# Task #8: allow_extension_operations - Implementation Proof

## Summary

Implemented `allow_extension_operations` as a root-level boolean argument that maps to `properties.osProfile.allowExtensionOperations` in the Azure API. The field defaults to `true` and includes cross-field validation with `provision_vm_agent`. The field is updatable and does not trigger ForceNew.

## Shadow Implementation

```hcl
# variables.tf
variable "allow_extension_operations" {
  type        = bool
  default     = true          # <-
  nullable    = false         # <-
  description = "(Optional) Should Extension Operations be allowed on this Virtual Machine? Defaults to `true`."

  validation {                # <-
    condition     = var.provision_vm_agent != false || var.allow_extension_operations == false
    error_message = "`allow_extension_operations` cannot be set to `true` when `provision_vm_agent` is set to `false`."
  }
}

# migrate_main.tf
locals {
  body = {
    properties = merge(
      # ... other properties ...
      var.admin_username != null ? {
        osProfile = merge(
          {
            adminUsername = var.admin_username
          },
          {
            allowExtensionOperations = var.allow_extension_operations  # <-
          }
        )
      } : {}
    )
  }
}
```

## Create Phase Verification

**Query Result**: Queried `resourceWindowsVirtualMachineCreate` function.

**Pattern Identification**: Single-phase creation pattern - the field is set during the primary `CreateOrUpdateThenPoll` operation.

**Go Code Evidence**:
```go
func resourceWindowsVirtualMachineCreate(d *pluginsdk.ResourceData, meta interface{}) error {
	// ...
	
	allowExtensionOperations := true
	if !d.GetRawConfig().AsValueMap()["allow_extension_operations"].IsNull() {
		allowExtensionOperations = d.Get("allow_extension_operations").(bool)
	}
	
	// ... later in the function, when !osDiskIsImported ...
	
	provisionVMAgent := true
	if p, ok := d.GetRawConfig().AsValueMap()["provision_vm_agent"]; ok && !p.IsNull() {
		provisionVMAgent = d.Get("provision_vm_agent").(bool)
	}

	if !provisionVMAgent && allowExtensionOperations {
		return fmt.Errorf("`allow_extension_operations` cannot be set to `true` when `provision_vm_agent` is set to `false`")
	}
	
	// ...
	
	params.Properties.OsProfile = &virtualmachines.OSProfile{
		AdminPassword:            pointer.To(d.Get("admin_password").(string)),
		AdminUsername:            pointer.To(d.Get("admin_username").(string)),
		ComputerName:             pointer.To(computerName),
		AllowExtensionOperations: pointer.To(allowExtensionOperations),  // <-- Field assigned here
		WindowsConfiguration: &virtualmachines.WindowsConfiguration{
			// ...
		},
		Secrets: secrets,
	}
	
	// ...
	
	if err := client.CreateOrUpdateThenPoll(ctx, id, params, virtualmachines.DefaultCreateOrUpdateOperationOptions()); err != nil {
		return fmt.Errorf("creating Windows %s: %+v", id, err)
	}
}
```

**Classification**: The field is assigned during the Create phase as part of the primary resource creation (before the single `CreateOrUpdateThenPoll` call). It belongs in `local.body`.

**Decision**: Implement in `local.body.properties.osProfile.allowExtensionOperations`.

## Assignment Path Verification

**Predicted Path**: `properties.osProfile.allowExtensionOperations`

**Go Code Evidence - Assignment Chain**:
1. Field read: `allowExtensionOperations := d.Get("allow_extension_operations").(bool)` (with default `true`)
2. Assigned to struct: `params.Properties.OsProfile.AllowExtensionOperations = pointer.To(allowExtensionOperations)`
3. Where `params` is `virtualmachines.VirtualMachine` with struct:
   - `Properties` → `*virtualmachines.VirtualMachineProperties`
   - `Properties.OsProfile` → `*virtualmachines.OSProfile`
   - `Properties.OsProfile.AllowExtensionOperations` → `*bool`

**Verified Path**: `properties.osProfile.allowExtensionOperations`

**Path Comparison**: ✅ Predicted path matches verified path.

## Provider Schema

**Source**: `resourceWindowsVirtualMachine()` schema definition in azurerm provider

```go
"allow_extension_operations": {
	Type:     pluginsdk.TypeBool,
	Optional: true,
	Computed: true,
},
```

**Key Properties**:
- **Type**: `TypeBool`
- **Optional**: `true`
- **Computed**: `true`
- **Default**: Not explicitly set in schema (handled in Create logic as `true`)
- **ForceNew**: `false` (field is updatable)
- **Validation**: Custom validation in Create method (cross-field with `provision_vm_agent`)

## Azure API Schema

**Resource Type**: `Microsoft.Compute/virtualMachines@2024-03-01`

**Property Path**: `body.properties.osProfile.allowExtensionOperations`

**Type**: `Bool`

**Description**: "Specifies whether extension operations should be allowed on the virtual machine. This may only be set to False when no extensions are present on the virtual machine."

## Hidden Fields

None identified for this field.

## Mapping

| AzureRM Field | Azure API Field | Notes |
|---------------|----------------|-------|
| `allow_extension_operations` | `allowExtensionOperations` | Boolean field in osProfile |

**Naming Convention**: snake_case → camelCase

## Special Handling

### 1. Default Value

**Provider Behavior**: 
```go
allowExtensionOperations := true
if !d.GetRawConfig().AsValueMap()["allow_extension_operations"].IsNull() {
	allowExtensionOperations = d.Get("allow_extension_operations").(bool)
}
```

The provider defaults to `true` when the field is not specified.

**Implementation**: Added `default = true` and `nullable = false` to the variable definition in `variables.tf`.

**Rationale**: Since this is a root-level argument with a computed default, we must set both `default = true` AND `nullable = false` according to executor.md rules for top-level arguments with defaults.

### 2. Cross-Field Validation with `provision_vm_agent`

**Provider Validation Logic**:
```go
provisionVMAgent := true
if p, ok := d.GetRawConfig().AsValueMap()["provision_vm_agent"]; ok && !p.IsNull() {
	provisionVMAgent = d.Get("provision_vm_agent").(bool)
}

if !provisionVMAgent && allowExtensionOperations {
	return fmt.Errorf("`allow_extension_operations` cannot be set to `true` when `provision_vm_agent` is set to `false`")
}
```

**Implementation**: Added validation block to `allow_extension_operations` variable:
```hcl
validation {
  condition     = var.provision_vm_agent != false || var.allow_extension_operations == false
  error_message = "`allow_extension_operations` cannot be set to `true` when `provision_vm_agent` is set to `false`."
}
```

**Logic Explanation**:
- Condition is satisfied when EITHER:
  - `var.provision_vm_agent != false` (i.e., it's `true` or `null`) OR
  - `var.allow_extension_operations == false`
- This prevents the invalid combination: `provision_vm_agent = false` AND `allow_extension_operations = true`

### 3. Conditional Inclusion in osProfile

**Provider Behavior**: The field is only included when `osProfile` is created (i.e., when not using `os_managed_disk_id`).

**Implementation**: The field is merged into the `osProfile` object which is conditionally created when `var.admin_username != null`:
```hcl
var.admin_username != null ? {
  osProfile = merge(
    {
      adminUsername = var.admin_username
    },
    {
      allowExtensionOperations = var.allow_extension_operations
    }
  )
} : {}
```

This ensures the field is only included when an osProfile is being created.

### 4. Updatable Field (No ForceNew)

**Provider Behavior - Update Method**:
```go
if d.HasChange("allow_extension_operations") {
	allowExtensionOperations := d.Get("allow_extension_operations").(bool)

	shouldUpdate = true

	if update.Properties.OsProfile == nil {
		update.Properties.OsProfile = &virtualmachines.OSProfile{}
	}

	update.Properties.OsProfile.AllowExtensionOperations = pointer.To(allowExtensionOperations)
}
```

The field can be updated without recreating the resource.

**Implementation**: No entry in `replace_triggers_external_values` since the field does not trigger ForceNew.

## Deferred Work Completion

Checked `following.md` - no deferred work found for Task #8.

## Critical Review & Edge Case Analysis

### Null Semantics
- **When `null`**: Not applicable since we set `nullable = false` and `default = true`. The field always has a value.
- **When `true`**: Extension operations are allowed (default behavior)
- **When `false`**: Extension operations are disabled (only valid when no extensions are present per Azure API docs)

### Boundary Conditions
- **Boolean field**: Only two states: `true` or `false`
- **Cross-field dependency**: Must validate against `provision_vm_agent`

### Idempotency
✅ **Idempotent**: Boolean value is deterministic and does not depend on order or timing.

### Safe References
✅ **Safe**: Direct boolean value reference, no nested access required.

### Edge Cases

1. **Case: `provision_vm_agent = false` and `allow_extension_operations = true`**
   - **Validation**: Caught by validation block at plan time
   - **Error**: "`allow_extension_operations` cannot be set to `true` when `provision_vm_agent` is set to `false`."

2. **Case: `provision_vm_agent = null` (default true) and `allow_extension_operations = true`**
   - **Valid**: Both defaults are `true`, which is the expected default configuration

3. **Case: `provision_vm_agent = null` and `allow_extension_operations = false`**
   - **Valid**: Explicitly disabling extension operations while keeping VM agent enabled

4. **Case: `provision_vm_agent = false` and `allow_extension_operations = false`**
   - **Valid**: Both disabled together is allowed

5. **Case: osProfile not created (os_managed_disk_id used)**
   - **Handled**: Field is not included in body since osProfile merge is conditional on `admin_username != null`

## Checklist

- ✅ Property in correct local (`local.body.properties.osProfile`)
- ✅ ForceNew handling: Not applicable (field is updatable, no ForceNew)
- ✅ Default value replicated (`default = true`, `nullable = false`)
- ✅ All logic exactly replicated from provider:
  - ✅ Default to `true` when not specified
  - ✅ Cross-field validation with `provision_vm_agent`
  - ✅ Conditional inclusion when osProfile exists
  - ✅ Updatable via Update method
- ✅ Validations implemented in variables.tf (cross-field validation with `provision_vm_agent`)
- ✅ Hidden fields checked: None found
- ✅ Deferred work: None in following.md
- ✅ Critical review performed (null semantics, edge cases, idempotency, safe refs)
- ✅ Edge Case Analysis section included
- ✅ Proof document created
- ✅ Self-Review: Only `allow_extension_operations` field implemented, no content from other tasks

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-24
**Task:** #8 - allow_extension_operations

### Validation Results

✅ **ForceNew Logic:** Not applicable - field is updatable (no ForceNew in schema or CustomizeDiff)
✅ **Stable Keys:** Not applicable - no replace_triggers_external_values entry needed
✅ **Phase Detection:** Field correctly placed in `local.body` (Create phase)
✅ **Type Conversion:** Direct boolean to boolean, no conversion needed
✅ **Null Handling:** Correctly uses `nullable = false` with `default = true` for root-level argument
✅ **Default Value:** Correctly implements both `default = true` AND `nullable = false` as required by executor.md for root-level arguments with defaults
✅ **Validations:** Cross-field validation with `provision_vm_agent` correctly implemented in `variables.tf` using Terraform 1.9+ cross-variable validation. Logic correctly translates provider error condition using De Morgan's law.
✅ **Nested Merge:** Correctly uses nested merge for `osProfile` path to avoid shallow merge overwrites
✅ **Deferred Work Completion:** No deferred work for this task in following.md
✅ **Deferred Work Recording:** No deferrals made by this task
✅ **Edge Cases:** All edge cases properly analyzed including cross-field validation scenarios and osProfile conditional creation

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. No deviations, simplifications, or "safer alternatives" were found. The cross-field validation logic correctly implements the provider's runtime check at Terraform plan time using variable validation blocks.

**Status:** APPROVED ✅

---
