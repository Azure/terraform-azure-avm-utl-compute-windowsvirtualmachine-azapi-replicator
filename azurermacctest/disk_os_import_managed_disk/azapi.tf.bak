# NOTE: This test case uses 'os_managed_disk_id' which is marked as "Failed" in track.md
# and is not currently implemented in the module variables. This conversion is provided
# for reference but may not work until os_managed_disk_id support is added.

# The original test imports an existing managed disk for the OS disk, which is a special
# scenario that may require additional implementation work in the module.

module "replicator" {
  source = "../../"

  name                  = local.vm_name
  resource_group_name   = azurerm_resource_group.test.name
  location              = azurerm_resource_group.test.location
  size                  = "Standard_F2"
  network_interface_ids = [azurerm_network_interface.test.id]

  # NOTE: os_managed_disk_id not yet supported - see track.md item 26
  # Original value: data.azurerm_managed_disks.test.disk.0.id
  
  os_disk = {
    caching              = "ReadWrite"
    storage_account_type = "Premium_LRS"  # Default value required by module
  }

  resource_group_id = azurerm_resource_group.test.id
}

resource "azapi_resource" "this" {
  type                             = module.replicator.azapi_header.type
  name                             = module.replicator.azapi_header.name
  location                         = module.replicator.azapi_header.location
  parent_id                        = module.replicator.azapi_header.parent_id
  tags                             = module.replicator.azapi_header.tags
  body                             = module.replicator.body
  ignore_null_property             = module.replicator.azapi_header.ignore_null_property
  sensitive_body                   = module.replicator.sensitive_body
  sensitive_body_version           = module.replicator.sensitive_body_version
  replace_triggers_external_values = module.replicator.replace_triggers_external_values
  locks                            = module.replicator.locks
  retry                            = module.replicator.retry

  dynamic "identity" {
    for_each = can(module.replicator.azapi_header.identity) ? [module.replicator.identity] : []
    content {
      type         = identity.value.type
      identity_ids = try(identity.value.identity_ids, null)
    }
  }

  dynamic "timeouts" {
    for_each = module.replicator.timeouts != null ? [module.replicator.timeouts] : []
    content {
      create = timeouts.value.create
      delete = timeouts.value.delete
      read   = timeouts.value.read
      update = timeouts.value.update
    }
  }
}
