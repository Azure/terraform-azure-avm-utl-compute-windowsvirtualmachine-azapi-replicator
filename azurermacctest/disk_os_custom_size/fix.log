Test Case: disk_os_custom_size
================================================================================

Initial Error:
Error: Attempt to get attribute from null value

  on azapi.tf line 47, in resource "azapi_resource" "this":
  47:       type         = identity.value.type
    ├────────────────
    │ identity.value is null

This value is null, so it does not have any attributes.

Fix Process:

Attempt 1:
- Problem Analysis: The dynamic "identity" block uses can(module.replicator.azapi_header.identity) which returns true even when the value is null. When for_each creates an iteration with a null value, accessing identity.value.type fails.
- Fix Method: Change the for_each condition to properly check if identity is not null and not an empty object
- Changes Made: Modified azapi.tf line 45 from:
    for_each = can(module.replicator.azapi_header.identity) ? [module.replicator.azapi_header.identity] : []
  to:
    for_each = module.replicator.azapi_header.identity != null ? [module.replicator.azapi_header.identity] : []
- Result: Success - plan completed. Detected drifts analyzed against acceptable_drift_patterns.md:
  * All resource-level attribute changes (ignore_null_property, locks, replace_triggers_external_values, sensitive_body_version, output, type) are acceptable per Section 1
  * All body changes (storageUri, licenseType additions; requireGuestProvisionSignal, secrets, patchSettings, winRM, priority, deleteOption, managedDisk.id removals) are acceptable per Section 2 (Azure API response fields not in AzureRM schema or Optional+Computed defaults)
  * Proceeding with apply and idempotency verification

Final Result: Fix successful
