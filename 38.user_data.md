# Task #38 - user_data - Proof Document

## Shadow Implementation

```hcl
# migrate_main.tf
locals {
  body = merge(
    {
      properties = merge(
        # ... existing properties ...
        var.user_data != null ? {
          userData = var.user_data  # <-
        } : {}
      )
    }
  )
}
```

## Summary

The `user_data` field is an optional root-level argument that allows passing Base64-encoded custom data to the VM. It maps to `properties.userData` in the Azure API and can be updated without replacement.

## Create Phase Verification

**Query Result**: From `resourceWindowsVirtualMachineCreate`:

```go
if v, ok := d.GetOk("user_data"); ok {
	params.Properties.UserData = pointer.To(v.(string))
}
```

**Pattern**: Single-phase operation.

**Classification**: The field is set in the primary `CreateOrUpdate` call via `params.Properties.UserData`.

**Decision**: Implement in `local.body.properties.userData` (Create phase).

## Assignment Path Verification

**Predicted Path**: `properties.userData`

**Go Code Evidence**:
```go
params := virtualmachines.VirtualMachine{
	Properties: &virtualmachines.VirtualMachineProperties{
		// ... other properties ...
	},
}

if v, ok := d.GetOk("user_data"); ok {
	params.Properties.UserData = pointer.To(v.(string))
}
```

**Trace**:
1. `params.Properties.UserData = pointer.To(v.(string))` - Direct assignment to Properties.UserData
2. `params` is sent to API as request body
3. Path: `properties.userData`

**Verified Path**: `properties.userData`

**Path Comparison**: ✅ Match - Predicted path matches verified path.

## Provider Schema

From `resourceWindowsVirtualMachine` schema:

```go
"user_data": {
	Type:         pluginsdk.TypeString,
	Optional:     true,
	ValidateFunc: validation.StringIsBase64,
},
```

**Field Properties**:
- **Type**: String
- **Optional**: true
- **Required**: false
- **ForceNew**: false (not specified, so field is updatable)
- **Sensitive**: false
- **Computed**: false
- **ValidateFunc**: `validation.StringIsBase64` - validates the string is Base64-encoded
- **ConflictsWith**: None
- **RequiredWith**: None

## Azure API Schema

From `Microsoft.Compute/virtualMachines@2024-03-01`:

**Path**: `body.properties.userData`

**Description**: "UserData for the VM, which must be base-64 encoded. Customer should not pass any secrets in here. Minimum api-version: 2021-03-01."

**Type**: String

**Properties**:
- Not marked as ReadOnly
- Not marked as Required
- Not marked as WriteOnly
- Can be updated

## Hidden Fields

None. The field is directly exposed in the provider schema.

## Mapping

| Terraform (snake_case) | Azure API (camelCase) | Notes |
|------------------------|----------------------|-------|
| `user_data` | `userData` | Direct mapping |

## Special Handling

### 1. Validation

**From Schema**: `ValidateFunc: validation.StringIsBase64`

The provider validates that the value is Base64-encoded. Must replicate in `variables.tf`.

**Implementation**: The variable already exists in `variables.tf` but lacks validation. Must add:

```hcl
variable "user_data" {
  type        = string
  default     = null
  description = "(Optional) The Base64-Encoded User Data which should be used for this Virtual Machine."
  
  validation {
    condition     = var.user_data == null || can(base64decode(var.user_data))
    error_message = "The user_data must be Base64-encoded."
  }
}
```

### 2. ForceNew Behavior

**From Schema**: No `ForceNew: true` specified.

**From Update Method**: 
```go
if d.HasChange("user_data") {
	shouldUpdate = true
	update.Properties.UserData = pointer.To(d.Get("user_data").(string))
}
```

The field can be updated in-place without forcing a new resource. The update is applied via the `Update` operation without requiring shutdown or deallocation.

**Decision**: Do NOT add to `replace_triggers_external_values`. The field is updatable.

### 3. Sensitive Handling

**From Schema**: Not marked as `Sensitive: true`.

**Decision**: Not a sensitive field. Place in `body`, not `sensitive_body`.

### 4. Assignment Location

The field is set in the primary `CreateOrUpdate` call, not in a post-creation operation.

**Implementation**: Add to `local.body.properties.userData`.

## Deferred Work Completion

Checked `following.md` - file does not exist yet, so no deferred work to complete.

## Edge Case Analysis

### Null Semantics
- **`null`**: Field not set in API request (due to `ignore_null_property = true`)
- **Behavior**: Provider treats `null` as "do not set userData"
- **Implementation**: Use conditional merge: `var.user_data != null ? { userData = var.user_data } : {}`

### Empty String
- **Value**: `""` (empty string)
- **Validation**: Will pass Base64 validation (empty string is valid Base64)
- **API Behavior**: Empty userData is valid and will be sent to the API
- **Implementation**: Allow empty string through

### Base64 Encoding
- **Requirement**: Value must be Base64-encoded
- **Validation**: Added validation block to ensure Base64 encoding
- **User Responsibility**: Users must Base64-encode their data before passing to the variable

### Idempotency
- **Updates**: Field can be updated in-place
- **API Behavior**: Azure accepts updates to userData without requiring VM reboot or deallocation
- **Implementation**: Standard update behavior, no special handling needed

### Safe References
- **Check**: `var.user_data != null` before including in body
- **Reason**: Prevents sending null values to API when ignore_null_property is enabled

## Checklist

- ✅ Property in correct local: `body.properties.userData`
- ✅ ForceNew NOT wrapped: Field is updatable, not in `replace_triggers_external_values`
- ✅ All logic EXACTLY replicated from provider: Validation for Base64 encoding
- ✅ Validations IMPLEMENTED in variables.tf: Base64 validation added
- ✅ Hidden fields checked: None
- ✅ Deferred work in following.md: None to defer
- ✅ Deferred work from following.md: None to complete
- ✅ Critical review (null, edge, idempotent, safe refs): Completed above
- ✅ Edge Case Analysis in proof: Included above
- ✅ Proof created: This document
- ✅ track.md to be updated to Pending for check: Will update after implementation
- ✅ Self-Review: Only implementing user_data field (Task #38)

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-24
**Task:** #38 - user_data

### Validation Results

✅ **ForceNew Logic:** Field is correctly NOT in `replace_triggers_external_values` - provider schema shows no ForceNew, and Update method supports in-place updates
✅ **Stable Keys:** Not applicable for updatable field in body
✅ **Phase Detection:** Field correctly placed in `local.body.properties` (Create phase)
✅ **Type Conversion:** Correct direct assignment from string to string (no conversion needed)
✅ **Null Handling:** Correctly uses conditional merge to exclude null values from body (consistent with `ignore_null_property = true`)
✅ **Validations:** Base64 validation correctly implemented in `variables.tf` using `can(base64decode(...))` which exactly replicates provider's `validation.StringIsBase64`
✅ **Deferred Work Completion:** No deferred work for this task (checked `following.md`)
✅ **Deferred Work Recording:** No deferrals made by this task
✅ **Edge Cases:** All edge cases properly analyzed (null semantics, empty string, Base64 validation, idempotency, safe references)
✅ **Assignment Path:** Correctly verified path `properties.userData` with Go code evidence
✅ **Sensitive Field Handling:** Correctly placed in `body` (not sensitive in provider schema)

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The field:
- Maps correctly from `user_data` (snake_case) to `userData` (camelCase)
- Implements the exact Base64 validation from provider schema
- Correctly supports in-place updates (not ForceNew)
- Properly handles null values with conditional merge
- Is placed in the correct phase (Create) and location (`body.properties`)

No deviations, simplifications, or "safer alternatives" were found.

**Status:** APPROVED ✅

---
