# Task #68 - gallery_application.order

## Summary

Implemented the optional `order` argument for `gallery_application` block, mapping to `order` in the Azure API. This field specifies the installation order for gallery applications, with a default value of 0 and valid values between 0 and 2147483647 (math.MaxInt32).

## Shadow Implementation

```hcl
# variables.tf
variable "gallery_application" {
  type = list(object({
    automatic_upgrade_enabled                   = optional(bool, false)
    configuration_blob_uri                      = optional(string)
    order                                       = optional(number, 0)  # <-
    tag                                         = optional(string)
    treat_failure_as_deployment_failure_enabled = optional(bool)
    version_id                                  = string
  }))
  default     = null
  
  validation {  # <-
    condition = var.gallery_application == null || alltrue([  # <-
      for app in var.gallery_application : app.order >= 0 && app.order <= 2147483647  # <-
    ])  # <-
    error_message = "Each gallery_application.order must be between 0 and 2147483647."  # <-
  }  # <-
}

# migrate_main.tf
locals {
  body = {
    properties = merge(
      var.gallery_application != null && length(var.gallery_application) > 0 ? {
        applicationProfile = {
          galleryApplications = [
            for app in var.gallery_application : merge(
              {
                packageReferenceId     = app.version_id
                enableAutomaticUpgrade = app.automatic_upgrade_enabled
              },
              app.configuration_blob_uri != null ? {
                configurationReference = app.configuration_blob_uri
              } : {},
              {
                order = app.order  # <-
                # tags = ... # Task #69
                # treatFailureAsDeploymentFailure = ... # Task #70
              }
            )
          ]
        }
      } : {}
    )
  }
}
```

## Create Phase Verification

### Single-Phase Pattern

From `resourceWindowsVirtualMachineCreate()`:

```go
params := virtualmachines.VirtualMachine{
	Name:             pointer.To(id.VirtualMachineName),
	ExtendedLocation: expandEdgeZone(d.Get("edge_zone").(string)),
	Location:         location.Normalize(d.Get("location").(string)),
	Identity:         identityExpanded,
	Plan:             plan,
	Properties: &virtualmachines.VirtualMachineProperties{
		ApplicationProfile: &virtualmachines.ApplicationProfile{
			GalleryApplications: expandVirtualMachineGalleryApplication(d.Get("gallery_application").([]interface{})),
		},
		// ... other properties
	},
	Tags: tags.Expand(t),
}

if err := client.CreateOrUpdateThenPoll(ctx, id, params, virtualmachines.DefaultCreateOrUpdateOperationOptions()); err != nil {
	return fmt.Errorf("creating Windows %s: %+v", id, err)
}
```

**Pattern Identification:**
- Single SDK operation: `CreateOrUpdateThenPoll`
- Gallery applications (including `order`) are part of the primary create request
- No post-creation operations for this field

**Decision:** This field is processed in the **Create phase** as part of `local.body.properties.applicationProfile.galleryApplications`

## Assignment Path Verification

### Predicted Path
`properties.applicationProfile.galleryApplications[*].order`

### Go Code Evidence

**1. Create method structure assignment:**
```go
Properties: &virtualmachines.VirtualMachineProperties{
	ApplicationProfile: &virtualmachines.ApplicationProfile{
		GalleryApplications: expandVirtualMachineGalleryApplication(d.Get("gallery_application").([]interface{})),
	},
}
```

**2. Expand function from `virtual_machine.go`:**
```go
func expandVirtualMachineGalleryApplication(input []interface{}) *[]virtualmachines.VMGalleryApplication {
	out := make([]virtualmachines.VMGalleryApplication, 0)
	if len(input) == 0 {
		return &out
	}

	for _, v := range input {
		config := v.(map[string]interface{})
		app := &virtualmachines.VMGalleryApplication{
			PackageReferenceId:              config["version_id"].(string),
			ConfigurationReference:          pointer.To(config["configuration_blob_uri"].(string)),
			Order:                           pointer.To(int64(config["order"].(int))),
			Tags:                            pointer.To(config["tag"].(string)),
			EnableAutomaticUpgrade:          pointer.To(config["automatic_upgrade_enabled"].(bool)),
			TreatFailureAsDeploymentFailure: pointer.To(config["treat_failure_as_deployment_failure_enabled"].(bool)),
		}

		out = append(out, *app)
	}

	return &out
}
```

**Key observations:**
- Direct assignment: `Order: pointer.To(int64(config["order"].(int)))`
- The provider always reads the `order` field and wraps it with `pointer.To`
- Field is always assigned (no conditional logic)
- The default value of `0` is applied by the schema before the expand function is called

### Verified Path
`properties.applicationProfile.galleryApplications[*].order` ✅

**Path Comparison:** Predicted path matches verified path exactly.

## Provider Schema

From `VirtualMachineGalleryApplicationSchema()` in `internal/services/compute/virtual_machine.go`:

```go
"order": {
	Type:         pluginsdk.TypeInt,
	Optional:     true,
	Default:      0,
	ValidateFunc: validation.IntBetween(0, math.MaxInt32),
},
```

**Key Details:**
- **Type:** Int
- **Optional:** Yes
- **Default:** 0
- **ForceNew:** No (not specified, defaults to false)
- **DiffSuppressFunc:** None
- **ValidateFunc:** `validation.IntBetween(0, math.MaxInt32)` - values must be between 0 and 2147483647
- **Conflicts:** Parent block has `ConflictsWith: ["os_managed_disk_id"]` (already handled by Task #64)

## Azure API Schema

**Resource Type**: `Microsoft.Compute/virtualMachines@2024-03-01`

**Property Path**: `body.properties.applicationProfile.galleryApplications[].order`

**Query Result:**
```
List(ObjectWithOptionalAttrs(map[string]Type{
  "configurationReference":String, 
  "enableAutomaticUpgrade":Bool, 
  "order":Number,  // <-- This field
  "packageReferenceId":String, 
  "tags":String, 
  "treatFailureAsDeploymentFailure":Bool
}, []string{"configurationReference", "enableAutomaticUpgrade", "order", "tags", "treatFailureAsDeploymentFailure"}))
```

**Type:** `Number` (optional attribute in the Azure API)

## Hidden Fields

None. The expand function shows all fields are explicitly mapped from Terraform configuration.

## Mapping

- Terraform (snake_case): `order`
- Azure API (camelCase): `order` (same name)

## Special Handling

### Default Value Implementation

The provider schema specifies `Default: 0`. Per executor.md rules for nested blocks with defaults:
> **Nested (PREFER):** `optional(bool, true)` or `optional(string, "PT1H30M")` in object type

Implementation in `variables.tf`:
```hcl
order = optional(number, 0)
```

This ensures:
- When user doesn't specify `order`, the default value `0` is used
- Exact replication of provider's default behavior
- Type system handles the default at the variable level (preferred approach)

### Validation - IntBetween(0, math.MaxInt32)

The provider validates that `order` must be between 0 and 2147483647 (math.MaxInt32 in Go).

Implementation in `variables.tf`:
```hcl
validation {
  condition = var.gallery_application == null || alltrue([
    for app in var.gallery_application : app.order >= 0 && app.order <= 2147483647
  ])
  error_message = "Each gallery_application.order must be between 0 and 2147483647."
}
```

**Rationale:**
- Replicates `validation.IntBetween(0, math.MaxInt32)` from provider schema
- Validates at plan time (fails fast before API call)
- Per executor.md: "MANDATORY: Every validation found in the provider schema MUST be implemented in variables.tf"
- Prevents user errors early in the Terraform workflow

### Updatable (Not ForceNew)

From Update method analysis:

```go
if d.HasChange("gallery_application") {
	shouldUpdate = true
	update.Properties.ApplicationProfile = &virtualmachines.ApplicationProfile{
		GalleryApplications: expandVirtualMachineGalleryApplication(d.Get("gallery_application").([]interface{})),
	}
}
```

The entire `gallery_application` block (including `order`) is updatable via the Update method. **No ForceNew behavior** - changes to this field do not require resource replacement.

## Deferred Work Completion

Checked `following.md` - no work was deferred to Task #68. ✅

## Critical Review & Edge Case

### Null Semantics

- **Not specified (null)**: When `order` is not explicitly set, the default value `0` is applied by the `optional(number, 0)` type specification
- **Explicit `0`**: Explicitly sets order to 0 (same as default)
- **Non-zero value**: Specifies the installation order for this gallery application

### Edge Cases

1. **Empty gallery_application list**: The parent block conditional (`var.gallery_application != null && length(var.gallery_application) > 0`) prevents the entire `applicationProfile` from being created when no applications are configured
2. **Multiple applications with same order**: Azure API allows this - order determines sequence but doesn't enforce uniqueness
3. **Default value (0)**: Most applications will use this default, which is fine for single-application deployments
4. **Maximum value (2147483647)**: Validated by our constraint, prevents overflow errors in the API
5. **Negative values**: Prevented by validation (must be >= 0)
6. **Updates**: Changes to `order` within existing gallery applications are applied via Update operation without VM replacement

### Idempotency

✅ The implementation is idempotent:
- First apply: Sets `order` to the specified value or default `0`
- Subsequent applies: No change if value remains the same
- Updates: Properly reflects changes when the field is modified
- Always present in API payload: Since we always assign `order = app.order` (with default 0), the field is consistently present

### Safe References

✅ Safe access pattern:
- `app.order` is safely accessed within the `for` loop over `var.gallery_application`
- The parent block ensures `var.gallery_application` is not null before iteration
- Default value (0) is applied at the type level via `optional(number, 0)`, so the field is never null within the loop
- Direct assignment without conditional checks (field is always present due to default)

## Checklist

- ✅ Property in correct local (`body.properties.applicationProfile.galleryApplications[].order`)
- ✅ ForceNew NOT needed (field is updatable)
- ✅ Default value applied in variables.tf using `optional(number, 0)` (preferred nested approach per executor.md)
- ✅ Validation implemented in variables.tf (IntBetween 0 to 2147483647)
- ✅ All logic EXACTLY replicated from provider (default and validation)
- ✅ Hidden fields checked (none found)
- ✅ Assignment path verified from Go source
- ✅ Create phase verified (single-phase, part of primary create)
- ✅ Deferred work checked - no work deferred TO this task
- ✅ Critical review completed (null semantics, edge cases, idempotency, safe refs)
- ✅ Edge Case Analysis included
- ✅ Proof document created
- ✅ Ready for track.md status update

---

**Implementation Status:** ✅ COMPLETE

This implementation exactly replicates the provider's behavior:
- Default value of `0` applied via `optional(number, 0)` type specification
- Validation for range 0-2147483647 implemented in variables.tf
- Field always present in API payload (no conditional logic needed)
- Updatable without VM replacement
- Safe and idempotent

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-24
**Task:** #68 - gallery_application.order

### Validation Results

✅ **ForceNew Logic:** Not ForceNew - field is correctly identified as updatable
✅ **Stable Keys:** Not applicable (no replace_triggers_external_values entry needed)
✅ **Phase Detection:** Field correctly placed in `local.body.properties.applicationProfile.galleryApplications[].order` (Create phase)
✅ **Type Conversion:** Correct conversion from Terraform `number` to Azure API `Number` (direct mapping)
✅ **Null Handling:** Correctly handled via `optional(number, 0)` - field always has a value
✅ **Validations:** IntBetween(0, 2147483647) validation correctly implemented in variables.tf
✅ **Default Value:** Uses preferred `optional(number, 0)` syntax (not fallback coalesce) - complies with executor.md line 148
✅ **Deferred Work Completion:** No deferred work for this task (checked following.md)
✅ **Deferred Work Recording:** No deferrals made by this task
✅ **Edge Cases:** All edge cases properly analyzed and handled (empty lists, boundary values, updates)

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. No deviations, simplifications, or "safer alternatives" were found. The implementation uses the preferred method for nested defaults (`optional(number, 0)`) rather than fallback approaches, and all validations are implemented at the variable level as mandated.

**Status:** APPROVED ✅

---
