# Task #92 - termination_notification.timeout - IMPLEMENTATION

## Summary
Implemented the `timeout` field within the `termination_notification` block. This Optional string field with a default value of "PT5M" controls the timeout duration for termination notifications and maps to `properties.scheduledEventsProfile.terminateNotificationProfile.notBeforeTimeout` in the Azure API.

## Shadow Implementation

```hcl
# variables.tf
variable "termination_notification" {  # <-
  type = object({  # <-
    enabled = bool  # <-
    timeout = optional(string, "PT5M")  # <-
  })  # <-
  default     = null  # <-
  
  validation {  # <-
    condition = var.termination_notification == null || var.termination_notification.timeout == null || can(regex("^PT([5-9]|1[0-5])M$", var.termination_notification.timeout))  # <-
    error_message = "The timeout must be an ISO 8601 duration between PT5M and PT15M."  # <-
  }  # <-
}  # <-

# migrate_main.tf
locals {  # <-
  body = merge(  # <-
    {  # <-
      properties = merge(  # <-
        var.os_image_notification != null || var.termination_notification != null ? {  # <-
          scheduledEventsProfile = merge(  # <-
            var.os_image_notification != null ? {  # <-
              osImageNotificationProfile = {  # <-
                enable           = true  # <-
                notBeforeTimeout = var.os_image_notification.timeout  # <-
              }  # <-
            } : {},  # <-
            var.termination_notification != null ? {  # <-
              terminateNotificationProfile = {  # <-
                enable           = var.termination_notification.enabled  # <-
                notBeforeTimeout = var.termination_notification.timeout  # <-
              }  # <-
            } : {}  # <-
          )  # <-
        } : {}  # <-
      )  # <-
    }  # <-
  )  # <-
}  # <-
```

## Create Phase Verification

**Method**: Queried Create method via `query_terraform_block_implementation_source_code` with `entrypoint_name=create`.

**Pattern**: Single-phase creation - the field is populated during the primary `CreateOrUpdateThenPoll` call.

**Go Code Evidence**:
```go
if v, ok := d.GetOk("termination_notification"); ok {
	terminateNotificationProfile = expandTerminateNotificationProfile(v.([]interface{}))
}

if terminateNotificationProfile != nil || osImageNotificationProfile != nil {
	params.Properties.ScheduledEventsProfile = &virtualmachines.ScheduledEventsProfile{
		OsImageNotificationProfile:   osImageNotificationProfile,
		TerminateNotificationProfile: terminateNotificationProfile,
	}
}

if err := client.CreateOrUpdateThenPoll(ctx, id, params, virtualmachines.DefaultCreateOrUpdateOperationOptions()); err != nil {
	return fmt.Errorf("creating Windows %s: %+v", id, err)
}
```

**Decision**: The field is assigned to `params.Properties.ScheduledEventsProfile.TerminateNotificationProfile.NotBeforeTimeout` **before** the primary `CreateOrUpdateThenPoll` call. This is part of the **Create phase** (single-phase pattern).

## Assignment Path Verification

**Predicted Path**: `body.properties.scheduledEventsProfile.terminateNotificationProfile.notBeforeTimeout`

**Go Code Trace**:
1. `expandTerminateNotificationProfile()` returns `*virtualmachines.TerminateNotificationProfile` with `NotBeforeTimeout` field set
2. Assigned to `params.Properties.ScheduledEventsProfile` → adds `.properties.scheduledEventsProfile`
3. Field name: `TerminateNotificationProfile.NotBeforeTimeout` → adds `.terminateNotificationProfile.notBeforeTimeout`

**Expand Function Evidence**:
```go
func expandTerminateNotificationProfile(input []interface{}) *virtualmachines.TerminateNotificationProfile {
	if len(input) == 0 {
		return &virtualmachines.TerminateNotificationProfile{
			Enable: pointer.To(false),
		}
	}

	raw := input[0].(map[string]interface{})
	enabled := raw["enabled"].(bool)
	timeout := raw["timeout"].(string)

	return &virtualmachines.TerminateNotificationProfile{
		Enable:           &enabled,
		NotBeforeTimeout: &timeout,
	}
}
```

**Verified Path**: `properties.scheduledEventsProfile.terminateNotificationProfile.notBeforeTimeout`

**Path Comparison**: ✅ MATCH - The predicted path exactly matches the verified path from Go code trace.

## Provider Schema

**Method**: Queried via `query_terraform_block_implementation_source_code` with `entrypoint_name=schema`.

**Schema Output**:
```go
func virtualMachineTerminationNotificationSchema() *pluginsdk.Schema {
	return &pluginsdk.Schema{
		Type:     pluginsdk.TypeList,
		Optional: true,
		Computed: true,
		MaxItems: 1,
		Elem: &pluginsdk.Resource{
			Schema: map[string]*pluginsdk.Schema{
				"enabled": {
					Type:     pluginsdk.TypeBool,
					Required: true,
				},
				"timeout": {
					Type:         pluginsdk.TypeString,
					Optional:     true,
					ValidateFunc: azValidate.ISO8601DurationBetween("PT5M", "PT15M"),
					Default:      "PT5M",
				},
			},
		},
	}
}
```

**Field Properties**:
- **Type**: `string`
- **Optional**: `true` (can be omitted)
- **Default**: `"PT5M"` (provider applies this default when user doesn't specify a value)
- **ValidateFunc**: `azValidate.ISO8601DurationBetween("PT5M", "PT15M")` (must be ISO 8601 duration between 5 and 15 minutes)
- **ForceNew**: `false` (not listed - field is updatable)
- **Computed**: `false`
- **Sensitive**: `false`

## Azure API Schema

**Method**: Queried via `query_azapi_resource_schema` with path `body.properties.scheduledEventsProfile.terminateNotificationProfile.notBeforeTimeout`.

**Schema Output**: `String`

**API Properties**:
- Type: String
- Optional in API (accepts ISO 8601 duration format)

## Hidden Fields

**Method**: Examined `expandTerminateNotificationProfile` function for any hardcoded values or transformations.

**Go Source**:
```go
func expandTerminateNotificationProfile(input []interface{}) *virtualmachines.TerminateNotificationProfile {
	if len(input) == 0 {
		return &virtualmachines.TerminateNotificationProfile{
			Enable: pointer.To(false),
		}
	}

	raw := input[0].(map[string]interface{})
	enabled := raw["enabled"].(bool)
	timeout := raw["timeout"].(string)

	return &virtualmachines.TerminateNotificationProfile{
		Enable:           &enabled,
		NotBeforeTimeout: &timeout,
	}
}
```

**Finding**: 
- The function directly reads `raw["timeout"]` and assigns it to `NotBeforeTimeout`
- When the block is not set (`len(input) == 0`), the function returns a profile with only `Enable: false` - no timeout is set in this case
- No hidden fields or special transformations for the timeout field
- The schema's `Default: "PT5M"` ensures that when the block is set but timeout is not specified, the value "PT5M" is automatically provided by the provider

**NO hidden fields** - straightforward assignment.

## Mapping

| Terraform Field | Azure API Field | Notes |
|----------------|-----------------|-------|
| `termination_notification.timeout` | `scheduledEventsProfile.terminateNotificationProfile.notBeforeTimeout` | Optional string with default "PT5M" |

**Naming Convention**: 
- `timeout` → `notBeforeTimeout` (descriptive camelCase, clarifies the timeout is for "not before" notification)

## Special Handling

### 1. Default Value Implementation

**Provider Behavior**: The schema has `Default: "PT5M"`, which means:
- When the user sets the block but omits `timeout`, the provider automatically provides "PT5M"
- When the user explicitly sets a value, that value is used

**Our Implementation**: 
```hcl
variable "termination_notification" {
  type = object({
    enabled = bool
    timeout = optional(string, "PT5M")  # Default applied in optional()
  })
  default = null
}
```

Using `optional(string, "PT5M")` replicates the exact provider behavior:
- When block is set but timeout is omitted: Uses "PT5M" (matches provider)
- When block is set and timeout is specified: Uses specified value (matches provider)
- When block is not set: Block is null, so timeout is not evaluated (matches provider)

### 2. Validation Implementation

**Provider Validation**: `azValidate.ISO8601DurationBetween("PT5M", "PT15M")`

This validates that the timeout is:
- An ISO 8601 duration format
- Between 5 minutes (PT5M) and 15 minutes (PT15M)

**Our Validation**:
```hcl
validation {
  condition = var.termination_notification == null || var.termination_notification.timeout == null || can(regex("^PT([5-9]|1[0-5])M$", var.termination_notification.timeout))
  error_message = "The timeout must be an ISO 8601 duration between PT5M and PT15M."
}
```

**Regex Breakdown**:
- `^PT` - Must start with "PT" (ISO 8601 duration prefix)
- `([5-9]|1[0-5])` - Matches 5-9 or 10-15 (exactly the range PT5M to PT15M)
- `M$` - Must end with "M" (minutes)

**Validation Logic**:
- Skips validation if block is null (`var.termination_notification == null`)
- Skips validation if timeout is null (should not happen due to default, but defensive)
- Validates the timeout format and range if present

**Why This Matches Exactly**: The provider's `ISO8601DurationBetween` function validates both format and range. Our regex does the same by:
1. Enforcing ISO 8601 format for minutes-only durations (`PT<number>M`)
2. Enforcing the exact numeric range (5-15)

### 3. Update Phase Support

**Update Method Evidence**:
```go
if d.HasChange("termination_notification") {
	shouldUpdate = true
	terminateNotificationProfile = expandTerminateNotificationProfile(d.Get("termination_notification").([]interface{}))
}

if osImageNotificationProfile != nil || terminateNotificationProfile != nil {
	update.Properties.ScheduledEventsProfile = &virtualmachines.ScheduledEventsProfile{
		OsImageNotificationProfile:   osImageNotificationProfile,
		TerminateNotificationProfile: terminateNotificationProfile,
	}
}
```

**Decision**: The field is updatable (not ForceNew). Same expand function is used, so the timeout value is sent in updates.

**No ForceNew**: Since the field is not ForceNew, we do NOT add it to `replace_triggers_external_values`.

### 4. Shared Parent Path

The `scheduledEventsProfile` object is shared with `os_image_notification` (Task #74). Our implementation correctly uses nested `merge()` to combine both profiles:
```hcl
var.os_image_notification != null || var.termination_notification != null ? {
  scheduledEventsProfile = merge(
    var.os_image_notification != null ? { osImageNotificationProfile = {...} } : {},
    var.termination_notification != null ? { terminateNotificationProfile = {...} } : {}
  )
} : {}
```

## Edge Case Analysis

### Null Semantics

**Block absent** (`var.termination_notification == null`):
- ✅ Provider behavior: `d.GetOk()` returns false, expand function not called, `terminateNotificationProfile` remains `nil`
- ✅ Our implementation: Returns `{}` (nothing merged), so no `terminateNotificationProfile` is sent
- ✅ EXACT MATCH

**Block present, timeout not specified**:
- ✅ Provider behavior: Schema's `Default: "PT5M"` provides the default, expand function receives "PT5M" from `raw["timeout"]`
- ✅ Our implementation: `optional(string, "PT5M")` provides "PT5M" when not specified, sent as `notBeforeTimeout = "PT5M"`
- ✅ EXACT MATCH

**Block present, timeout = "PT10M"**:
- ✅ Provider behavior: User value "PT10M" is used
- ✅ Our implementation: User value "PT10M" is sent as `notBeforeTimeout = "PT10M"`
- ✅ EXACT MATCH

### Boundary Conditions

**Minimum valid value** (PT5M):
- ✅ Validation regex accepts `PT5M`
- ✅ This is also the default value
- ✅ Sent correctly to API

**Maximum valid value** (PT15M):
- ✅ Validation regex accepts `PT15M`
- ✅ Sent correctly to API

**Invalid values**:
- `PT4M` (too low): ❌ Rejected by validation regex
- `PT16M` (too high): ❌ Rejected by validation regex
- `PT5S` (seconds, not minutes): ❌ Rejected by validation regex (doesn't end with "M")
- `5M` (missing PT prefix): ❌ Rejected by validation regex (doesn't start with "PT")
- `PT5` (missing unit): ❌ Rejected by validation regex (doesn't end with "M")

**Both blocks set** (termination_notification + os_image_notification):
- ✅ The `merge()` correctly combines both profiles under the shared `scheduledEventsProfile` parent
- ✅ Both timeouts are independent and don't interfere

### Safe References

✅ The block check `var.termination_notification != null` protects against null access when accessing `var.termination_notification.timeout`

✅ The field reference is only evaluated inside the non-null conditional block

✅ The default value in `optional(string, "PT5M")` ensures timeout is never null when the block is present (always has a value)

### Idempotency

✅ **Stable default**: Using "PT5M" as the default in `optional()` ensures that:
- First apply with block but no timeout: sends "PT5M"
- Subsequent applies with no changes: sends "PT5M" again
- No drift or unnecessary updates

✅ **No order dependencies**: The timeout field is independent and doesn't depend on ordering

✅ **API accepts ISO 8601**: The Azure API accepts ISO 8601 duration strings directly, no conversion needed

## Deferred Work Completion

**Checked `following.md`**: No deferred work found for Task #92.

## Checklist

- ✅ Property added to correct local (`body.properties.scheduledEventsProfile.terminateNotificationProfile.notBeforeTimeout`)
- ✅ Assignment within parent block skeleton from Task #90
- ✅ NO ForceNew (field is updatable)
- ✅ Default value "PT5M" implemented using `optional(string, "PT5M")` syntax (exactly replicates provider behavior)
- ✅ Validation implemented in `variables.tf` (regex validates ISO 8601 format and PT5M-PT15M range)
- ✅ Hidden fields checked - straightforward assignment, no hidden fields
- ✅ No deferred work from `following.md`
- ✅ Edge case analysis completed
- ✅ Proof document created
- ✅ Implementation exactly matches provider behavior
- ✅ `track.md` status to be updated to "Pending for check"
- ✅ Self-review: Only `timeout` field added, replaced comment placeholder correctly

## Critical Review & Edge Cases

### Default Value Replication
The most critical aspect of this implementation is replicating the provider's default value behavior:

**Provider mechanism**: Uses `Default: "PT5M"` in schema definition, which ensures that when the block is set but the field is omitted, the value "PT5M" is automatically provided before calling the expand function.

**Our mechanism**: Uses `optional(string, "PT5M")` in the object type definition, which provides the same behavior - when the block is set but timeout is omitted, Terraform automatically provides "PT5M".

**Why this is exact replication**:
1. Both approaches provide "PT5M" when the field is omitted
2. Both allow the user to override with a custom value
3. Both result in the same value being sent to the API
4. The expand function receives the same input in both cases

### Validation Coverage
The validation regex `^PT([5-9]|1[0-5])M$` exactly matches the provider's `ISO8601DurationBetween("PT5M", "PT15M")` by:
1. Enforcing ISO 8601 format (PT prefix, M suffix)
2. Enforcing minutes-only format (no hours, seconds, etc.)
3. Enforcing the exact numeric range (5 through 15)

This is more restrictive than a general ISO 8601 validator, but it exactly matches the provider's validation logic.

### No Compromises
This implementation does NOT take any shortcuts or "simpler" approaches:
- ✅ Default value is exactly replicated using `optional()` with default parameter
- ✅ Validation range is exactly enforced (PT5M to PT15M)
- ✅ Format validation is strict (only accepts PTnM format where n is 5-15)
- ✅ Update behavior matches (field is updatable, not ForceNew)
- ✅ Assignment path matches Go code trace exactly

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-24
**Task:** #92 - termination_notification.timeout

### Validation Results

✅ **Default Value Implementation:** PREFERRED method used - `optional(string, "PT5M")` in object type (exactly matches executor.md line 148 requirement)
✅ **Validation:** Implemented in `variables.tf` with regex `^PT([5-9]|1[0-5])M$` - exactly replicates provider's `ISO8601DurationBetween("PT5M", "PT15M")`
✅ **ForceNew Logic:** Correctly NOT added to `replace_triggers_external_values` (field is updatable, not ForceNew per provider schema)
✅ **Stable Keys:** N/A - no ForceNew logic
✅ **Phase Detection:** Correctly placed in `local.body` (Create phase, before primary CreateOrUpdateThenPoll)
✅ **Assignment Path:** `body.properties.scheduledEventsProfile.terminateNotificationProfile.notBeforeTimeout` - verified exact match with Go code trace
✅ **Shared Parent Path:** Correctly uses nested `merge()` for `scheduledEventsProfile` (shared with `os_image_notification` from Task #74)
✅ **Type Conversion:** Direct string assignment - no conversion needed
✅ **Null Handling:** Correctly propagates null semantics - block absence results in no `terminateNotificationProfile` sent
✅ **Validations:** All provider validations implemented - regex validates both format and range (PT5M to PT15M)
✅ **Sensitive Fields:** N/A - field is not sensitive
✅ **Deferred Work Completion:** No deferred work for this task in `following.md`
✅ **Deferred Work Recording:** No deferrals made by this task
✅ **Edge Cases:** All edge cases properly analyzed - null semantics, boundary conditions (PT5M/PT15M), invalid values, shared parent path, idempotency

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. Specifically:

1. **Default value replication**: Uses PREFERRED `optional(string, "PT5M")` syntax (not fallback coalesce method) - exactly matches provider's `Default: "PT5M"` behavior
2. **Validation replication**: Regex exactly matches provider's `ISO8601DurationBetween("PT5M", "PT15M")` validation - enforces both format and range
3. **Assignment path**: Matches Go code trace exactly through expand function and struct assignments
4. **Shared parent handling**: Correctly uses nested merge for `scheduledEventsProfile` to avoid shallow merge overwrites
5. **Update behavior**: Correctly NOT in `replace_triggers_external_values` (field is updatable per provider)

No deviations, simplifications, or "safer alternatives" were found. The implementation follows the EXACT provider behavior including:
- Default value mechanism (optional with default parameter)
- Validation logic (ISO 8601 format + PT5M-PT15M range)
- Create/Update phase placement
- API path construction
- Null handling semantics

**Status:** APPROVED ✅
