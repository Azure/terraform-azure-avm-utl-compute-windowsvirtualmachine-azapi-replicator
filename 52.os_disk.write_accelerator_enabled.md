# Task #52 - os_disk.write_accelerator_enabled

## Summary
Implemented `os_disk.write_accelerator_enabled` field that controls whether Write Accelerator should be enabled for the OS disk. This is a simple boolean field with a default value of `false`.

## Shadow Implementation

```hcl
# variables.tf
variable "os_disk" {
  type = object({
    write_accelerator_enabled = optional(bool, false)  # <- Default applied
    # ... other fields
  })
}

# migrate_main.tf
locals {
  body = {
    properties = merge(
      {
        storageProfile = merge(
          {
            osDisk = merge(
              {
                writeAcceleratorEnabled = var.os_disk.write_accelerator_enabled  # <-
                # ... other fields
              }
            )
          }
        )
      }
    )
  }
}
```

## Create Phase Verification

### Query Results

**Create method query**: The `os_disk` block is processed during the primary `CreateOrUpdateThenPoll` operation.

From the Create method:
```go
func resourceWindowsVirtualMachineCreate(d *pluginsdk.ResourceData, meta interface{}) error {
	// ...
	osDiskRaw := d.Get("os_disk").([]interface{})
	osDisk, err := expandVirtualMachineOSDisk(osDiskRaw, virtualmachines.OperatingSystemTypesWindows)
	if err != nil {
		return fmt.Errorf("expanding `os_disk`: %+v", err)
	}
	// ...
	params.Properties.StorageProfile.OsDisk = osDisk
	// ...
	if err := client.CreateOrUpdateThenPoll(ctx, id, params, virtualmachines.DefaultCreateOrUpdateOperationOptions()); err != nil {
		return fmt.Errorf("creating Windows %s: %+v", id, err)
	}
}
```

### Pattern Identification

**Single-phase operation**: The resource uses a single `CreateOrUpdateThenPoll` call. No post-creation operations.

### Field Classification

**Create phase**: The `write_accelerator_enabled` field is processed in `expandVirtualMachineOSDisk` which is called before the primary `CreateOrUpdateThenPoll`.

**Decision**: Field belongs in `local.body` (Create phase)

## Assignment Path Verification

### Predicted Path
`body.properties.storageProfile.osDisk.writeAcceleratorEnabled`

### Go Code Evidence

From `expandVirtualMachineOSDisk`:
```go
func expandVirtualMachineOSDisk(input []interface{}, osType virtualmachines.OperatingSystemTypes) (*virtualmachines.OSDisk, error) {
	raw := input[0].(map[string]interface{})
	caching := raw["caching"].(string)

	disk := virtualmachines.OSDisk{
		Caching: pointer.To(virtualmachines.CachingTypes(caching)),
		ManagedDisk: &virtualmachines.ManagedDiskParameters{
			StorageAccountType: pointer.To(virtualmachines.StorageAccountTypes(raw["storage_account_type"].(string))),
		},
		WriteAcceleratorEnabled: pointer.To(raw["write_accelerator_enabled"].(bool)),
		CreateOption: virtualmachines.DiskCreateOptionTypesFromImage,
		OsType:       pointer.To(osType),
	}
	// ... additional fields ...
	return &disk, nil
}
```

From Create method assignment:
```go
params := virtualmachines.VirtualMachine{
	Properties: &virtualmachines.VirtualMachineProperties{
		StorageProfile: &virtualmachines.StorageProfile{
			OsDisk: osDisk,  // <- Assigned here
		},
	},
}
```

**Assignment trace**: 
1. `expandVirtualMachineOSDisk` returns `*virtualmachines.OSDisk` with `WriteAcceleratorEnabled` field set
2. Assigned to `StorageProfile.OsDisk`
3. `StorageProfile` assigned to `Properties.StorageProfile`
4. `Properties` assigned to `VirtualMachine.Properties`

### Verified Path
`body.properties.storageProfile.osDisk.writeAcceleratorEnabled`

### Path Comparison
✅ **MATCH** - Predicted path matches verified path exactly.

## Provider Schema

From schema definition:
```go
"write_accelerator_enabled": {
	Type:     pluginsdk.TypeBool,
	Optional: true,
	Default:  false,
},
```

**Field Properties**:
- **Type**: `Bool`
- **Optional**: `true`
- **Default**: `false`
- **ForceNew**: `false` (not marked)
- **Computed**: `false`
- **Sensitive**: `false`
- **Validations**: None

## Azure API Schema

**Query Path**: `body.properties.storageProfile.osDisk.writeAcceleratorEnabled`

**Schema Type**: `Bool`

**Documentation**: "Specifies whether writeAccelerator should be enabled or disabled on the disk."

## Hidden Fields

No hidden fields for this specific argument. The parent block (`os_disk`) has hidden fields (`createOption`, `osType`) that are handled by Task #44.

## Mapping

| Terraform Field | Azure API Field | Notes |
|----------------|-----------------|-------|
| `write_accelerator_enabled` | `writeAcceleratorEnabled` | snake_case → camelCase conversion |

## Special Handling

### Default Value
The provider schema specifies `Default: false`. This default is implemented in `variables.tf` using the `optional(bool, false)` syntax for the nested object type.

**Implementation**:
```hcl
variable "os_disk" {
  type = object({
    write_accelerator_enabled = optional(bool, false)  # Default applied here
    # ... other fields
  })
}
```

### No ForceNew
The field does NOT have `ForceNew: true` in the schema, and there is NO CustomizeDiff logic in the resource function. Therefore, it is NOT added to `replace_triggers_external_values`.

### No Validation
The field has no validation functions in the provider schema. It simply accepts any boolean value.

## Deferred Work Completion

Checked `following.md` for any work deferred to Task #52: **None found**.

## Critical Review & Edge Case Analysis

### Null Semantics
- **Meaning**: When `null`, the field uses the default value of `false` (due to `optional(bool, false)`)
- **Behavior**: Never sends `null` to API; always sends `false` when not explicitly set to `true`

### Edge Cases
- **`false` (default)**: Write Accelerator disabled - standard behavior
- **`true`**: Write Accelerator enabled - requires compatible VM size and Premium storage
- **API Validation**: Azure API validates that Write Accelerator can only be enabled on certain VM sizes with Premium storage

### Idempotency
✅ **Idempotent**: Boolean value with default. Repeated applies with same value produce identical results.

### Safe References
✅ **Safe**: Direct reference to `var.os_disk.write_accelerator_enabled` is safe because:
- Field is defined with `optional(bool, false)` in the object type
- Always has a value (either user-provided or default `false`)
- No null checks needed

### Compatibility Notes
From Azure documentation, Write Accelerator:
- Only available on M-series VMs
- Requires Premium Storage (Premium_LRS)
- Not compatible with all VM configurations

These constraints are enforced by Azure API at runtime, not by the provider.

## Checklist

- ✅ Property in correct local (`local.body`)
- ✅ Default value applied in `variables.tf` using `optional(bool, false)`
- ✅ No ForceNew needed (field is updatable)
- ✅ ALL logic EXACTLY replicated from provider (simple boolean passthrough with default)
- ✅ No validations needed (provider has none)
- ✅ Hidden fields checked (none for this field)
- ✅ No deferred work in `following.md`
- ✅ No deferred work TO this task
- ✅ Critical review completed
- ✅ Edge Case Analysis included
- ✅ Proof created
- ✅ Ready to update `track.md` to Pending for check
- ✅ Self-Review: Implementation contains ONLY Task #52 content, no other fields added

## Implementation Files Modified

1. **variables.tf**: Updated `os_disk` object type to include default value `optional(bool, false)`
2. **migrate_main.tf**: Replaced comment placeholder with field assignment `writeAcceleratorEnabled = var.os_disk.write_accelerator_enabled`

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-24
**Task:** #52 - os_disk.write_accelerator_enabled

### Validation Results

✅ **ForceNew Logic:** No ForceNew needed - field is updatable (no `ForceNew: true` in schema, no CustomizeDiff logic)
✅ **Stable Keys:** N/A - field not in `replace_triggers_external_values`
✅ **Phase Detection:** Field correctly placed in `local.body` (Create phase)
✅ **Type Conversion:** Correct conversion from `bool` to Azure API `Bool`
✅ **Null Handling:** Correctly uses `optional(bool, false)` for nested object field (matches executor.md preference)
✅ **Validations:** None required (provider has no validations for this field)
✅ **Deferred Work Completion:** No deferred work for this task in `following.md`
✅ **Deferred Work Recording:** No deferrals made by this task
✅ **Edge Cases:** All edge cases properly analyzed and handled in proof document
✅ **Default Value Implementation:** Correctly uses `optional(bool, false)` in nested object type (executor.md lines 147-149 PREFER method)
✅ **Shared Path Merge Check:** Field is part of stable `osDisk` object structure - no merge conflicts

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The field:
- Uses the correct default value (`false`) via `optional(bool, false)` syntax
- Is properly placed in the Create phase (`local.body`)
- Correctly maps `write_accelerator_enabled` → `writeAcceleratorEnabled`
- Has no validations or ForceNew logic (matching provider schema)
- Follows the PREFER method for nested defaults per executor.md

No deviations, simplifications, or "safer alternatives" were found.

**Status:** APPROVED ✅

---
