# Task #69 - gallery_application.tag

## Summary

Implemented the optional `tag` argument for `gallery_application` block, mapping to `tags` in the Azure API. This field is a pass-through string value that can be any non-empty string, used for tagging gallery applications. The field is optional with no default value and includes validation to prevent empty strings.

## Shadow Implementation

```hcl
# migrate_main.tf
locals {
  body = {
    properties = merge(
      var.gallery_application != null && length(var.gallery_application) > 0 ? {
        applicationProfile = {
          galleryApplications = [
            for app in var.gallery_application : merge(
              {
                packageReferenceId     = app.version_id
                enableAutomaticUpgrade = app.automatic_upgrade_enabled
              },
              app.configuration_blob_uri != null ? {
                configurationReference = app.configuration_blob_uri
              } : {},
              app.tag != null ? {  # <-
                order = app.order  # <-
                tags  = app.tag    # <-
              } : {  # <-
                order = app.order  # <-
              },  # <-
              {
                # treatFailureAsDeploymentFailure = ... # Task #70
              }
            )
          ]
        }
      } : {}
    )
  }
}

# variables.tf
variable "gallery_application" {
  type = list(object({
    automatic_upgrade_enabled                   = optional(bool, false)
    configuration_blob_uri                      = optional(string)
    order                                       = optional(number, 0)
    tag                                         = optional(string)  # <-
    treat_failure_as_deployment_failure_enabled = optional(bool, false)
    version_id                                  = string
  }))
  
  validation {  # <-
    condition = var.gallery_application == null || alltrue([  # <-
      for app in var.gallery_application : app.tag == null || length(app.tag) > 0  # <-
    ])  # <-
    error_message = "Each gallery_application.tag must not be an empty string."  # <-
  }  # <-
}
```

## Create Phase Verification

From `resourceWindowsVirtualMachineCreate()` in the Create method:

```go
params := virtualmachines.VirtualMachine{
	Location:         location.Normalize(d.Get("location").(string)),
	Identity:         identityExpanded,
	Plan:             plan,
	Properties: &virtualmachines.VirtualMachineProperties{
		ApplicationProfile: &virtualmachines.ApplicationProfile{
			GalleryApplications: expandVirtualMachineGalleryApplication(d.Get("gallery_application").([]interface{})),
		},
		// ... other properties
	},
	Tags: tags.Expand(t),
}

if err := client.CreateOrUpdateThenPoll(ctx, id, params, virtualmachines.DefaultCreateOrUpdateOperationOptions()); err != nil {
	return fmt.Errorf("creating Windows %s: %+v", id, err)
}
```

**Pattern:** Single-phase creation
- The `tag` field is part of the `gallery_application` list
- Processed by `expandVirtualMachineGalleryApplication()` during the primary create
- No post-creation operations for this field
- Assignment happens before the primary `CreateOrUpdateThenPoll` call

**Decision:** This field belongs in `local.body.properties.applicationProfile.galleryApplications[].tags` (Create phase)

## Assignment Path Verification

**Predicted Path:** `properties.applicationProfile.galleryApplications[*].tags`

**Go Code Evidence:**

1. **Expand function in Create method:**
```go
ApplicationProfile: &virtualmachines.ApplicationProfile{
	GalleryApplications: expandVirtualMachineGalleryApplication(d.Get("gallery_application").([]interface{})),
},
```

2. **Expand function implementation:**
```go
func expandVirtualMachineGalleryApplication(input []interface{}) *[]virtualmachines.VMGalleryApplication {
	out := make([]virtualmachines.VMGalleryApplication, 0)
	if len(input) == 0 {
		return &out
	}

	for _, v := range input {
		config := v.(map[string]interface{})
		app := &virtualmachines.VMGalleryApplication{
			PackageReferenceId:              config["version_id"].(string),
			ConfigurationReference:          pointer.To(config["configuration_blob_uri"].(string)),
			Order:                           pointer.To(int64(config["order"].(int))),
			Tags:                            pointer.To(config["tag"].(string)),  // ← Field assignment
			EnableAutomaticUpgrade:          pointer.To(config["automatic_upgrade_enabled"].(bool)),
			TreatFailureAsDeploymentFailure: pointer.To(config["treat_failure_as_deployment_failure_enabled"].(bool)),
		}

		out = append(out, *app)
	}

	return &out
}
```

3. **Struct construction in Create method:**
```go
Properties: &virtualmachines.VirtualMachineProperties{
	ApplicationProfile: &virtualmachines.ApplicationProfile{
		GalleryApplications: expandVirtualMachineGalleryApplication(...),  // Returns []VMGalleryApplication
	},
}
```

**Assignment Trace:**
1. `config["tag"]` (Terraform input) → `app.Tags` (VMGalleryApplication struct field)
2. `app.Tags` → appended to `out` slice → `[]VMGalleryApplication`
3. `[]VMGalleryApplication` → `GalleryApplications` field
4. `GalleryApplications` → nested in `ApplicationProfile`
5. `ApplicationProfile` → nested in `Properties`
6. Final path: `Properties.ApplicationProfile.GalleryApplications[*].Tags`
7. API JSON path: `properties.applicationProfile.galleryApplications[*].tags`

### Verified Path
`properties.applicationProfile.galleryApplications[*].tags` ✅

**Path Comparison:** Predicted path matches verified path exactly.

## Provider Schema

From `VirtualMachineGalleryApplicationSchema()` in `internal/services/compute/virtual_machine.go`:

```go
// NOTE: Per the service team, "this is a pass through value that we just add to the model but don't depend on. It can be any string."
"tag": {
	Type:         pluginsdk.TypeString,
	Optional:     true,
	ValidateFunc: validation.StringIsNotEmpty,
},
```

**Key Details:**
- **Type:** String
- **Optional:** Yes
- **Default:** None (no default value)
- **ForceNew:** No (not specified, defaults to false)
- **DiffSuppressFunc:** None
- **ValidateFunc:** `validation.StringIsNotEmpty` - string must not be empty if provided
- **Comment:** Service team note indicates this is a pass-through value that can be any string
- **Conflicts:** Parent block has `ConflictsWith: ["os_managed_disk_id"]` (already handled by Task #64)

## Azure API Schema

**Resource Type**: `Microsoft.Compute/virtualMachines@2024-03-01`

**Property Path**: `body.properties.applicationProfile.galleryApplications[].tags`

**Query Result:**
```
List(ObjectWithOptionalAttrs(map[string]Type{
  "configurationReference":String, 
  "enableAutomaticUpgrade":Bool, 
  "order":Number,  
  "packageReferenceId":String, 
  "tags":String,  // <-- This field
  "treatFailureAsDeploymentFailure":Bool
}, []string{"configurationReference", "enableAutomaticUpgrade", "order", "tags", "treatFailureAsDeploymentFailure"}))
```

**Type:** `String` (optional attribute in the Azure API)

## Hidden Fields

None. The expand function shows all fields are explicitly mapped from Terraform configuration.

## Mapping

- Terraform (snake_case): `tag` (singular)
- Azure API (camelCase): `tags` (plural)

**Note:** The Terraform field is singular (`tag`) but maps to the plural Azure API field (`tags`).

## Special Handling

### Validation - StringIsNotEmpty

The provider validates that `tag` must not be an empty string if provided.

Implementation in `variables.tf`:
```hcl
validation {
  condition = var.gallery_application == null || alltrue([
    for app in var.gallery_application : app.tag == null || length(app.tag) > 0
  ])
  error_message = "Each gallery_application.tag must not be an empty string."
}
```

**Rationale:**
- Replicates `validation.StringIsNotEmpty` from provider schema
- Category: Value Constraint (string format)
- Per executor.md line 118-125, MUST replicate all value constraint validations
- Applied to each item in the `gallery_application` list
- Validation passes when field is null (optional field) or when string length > 0

### Conditional Rendering in merge()

The field is conditionally included based on whether `app.tag` is null:

```hcl
app.tag != null ? {
  order = app.order
  tags  = app.tag
} : {
  order = app.order
}
```

**Why this pattern:**
- The `order` field must always be present (it has a default value of 0)
- The `tags` field is optional (no default, may be null)
- Using conditional merge allows us to include `tags` only when it has a value
- This prevents sending `null` values to the API for optional fields

**Note about merge() structure:**
- Both branches include `order` to ensure it's always present
- The first branch adds `tags` when `app.tag != null`
- The second branch omits `tags` when `app.tag == null`
- This is necessary because `merge()` operates on object keys, and we want to avoid sending `tags: null` to the API

### Updatable (Not ForceNew)

From Update method analysis:

```go
if d.HasChange("gallery_application") {
	shouldUpdate = true
	update.Properties.ApplicationProfile = &virtualmachines.ApplicationProfile{
		GalleryApplications: expandVirtualMachineGalleryApplication(d.Get("gallery_application").([]interface{})),
	}
}
```

The entire `gallery_application` block (including `tag`) is updatable via the Update method. **No ForceNew behavior** - changes to this field do not require resource replacement.

## Deferred Work Completion

Checked `following.md` - no work was deferred to Task #69. ✅

## Edge Case Analysis

### Null Semantics

- **`null`** (default): Field is not sent to API (omitted from `galleryApplications` object)
- **Non-empty string**: Value is passed through to API as-is
- **Empty string**: Validation prevents this case - user must provide null or non-empty string

### Edge Cases

1. **Empty gallery_application list**: The parent block conditional (`var.gallery_application != null && length(var.gallery_application) > 0`) prevents the entire `applicationProfile` from being created when no applications are configured
2. **Null tag value**: Field is omitted from the API payload (conditional merge structure ensures `tags` key is not present)
3. **Empty string**: Prevented by validation - user must provide null or non-empty string
4. **Pass-through value**: Per service team comment, this can be any string - no semantic interpretation by Azure
5. **Updates**: Changes to `tag` within existing gallery applications are applied via Update operation without VM replacement

### Idempotency

✅ Idempotent behavior:
- Same input produces same output across multiple applies
- Updates: Properly reflects changes when the field is modified
- Null handling: Consistently omits field when null

### Safe References

✅ Safe access pattern:
- `app.tag` is safely accessed within the `for` loop over `var.gallery_application`
- The parent block ensures `var.gallery_application` is not null before iteration
- Null check (`app.tag != null`) before including in merge structure prevents null values from being sent to API
- Validation ensures non-null values are never empty strings

## Checklist

- ✅ Property in correct local (`body.properties.applicationProfile.galleryApplications[].tags`)
- ✅ ForceNew not needed (field is updatable, not ForceNew)
- ✅ All logic EXACTLY replicated from provider (conditional rendering, validation)
- ✅ Validation IMPLEMENTED in variables.tf (StringIsNotEmpty → length check)
- ✅ Hidden fields checked (none for this field)
- ✅ Deferred work in following.md: None to defer for this task
- ✅ Deferred work from following.md: Checked - none deferred TO this task
- ✅ Critical review (null, edge, idempotent, safe refs) - completed in Edge Case Analysis
- ✅ Edge Case Analysis in proof (see section above)
- ✅ Proof created (this document)
- ✅ `track.md` updated to Pending for check
- ✅ Self-Review: Only Task #69 field implemented (tag), no other fields added ✅

## Self-Review: Scope Check

**Did I add ONLY what Task #69 requires?**
- ✅ Added `tag` field implementation in `migrate_main.tf` within existing `gallery_application` block
- ✅ Added validation for `tag` in `variables.tf`
- ✅ Did NOT add fields from other tasks
- ✅ Did NOT modify unrelated code

**Did I add things that belong to other tasks?**
- ❌ No - only implemented Task #69 (gallery_application.tag)
- ✅ Left Task #70 placeholder comment in place for `treatFailureAsDeploymentFailure`

✅ **Scope verification passed**

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-24
**Task:** #69 - gallery_application.tag

### Validation Results

✅ **ForceNew Logic:** Not ForceNew - field is updatable via Update method (correctly NOT in replace_triggers_external_values)
✅ **Stable Keys:** N/A (no replace triggers for this field)
✅ **Phase Detection:** Field correctly placed in `local.body.properties.applicationProfile.galleryApplications[*].tags` (Create phase)
✅ **Type Conversion:** Correct - provider String type → Terraform string type → Azure API string
✅ **Null Handling:** Correctly propagates null semantics - field omitted from API payload when null via conditional merge
✅ **Validations:** StringIsNotEmpty validation correctly implemented in variables.tf (lines 568-573) with exact logic: `app.tag == null || length(app.tag) > 0`
✅ **Conditional Rendering:** Proper merge structure - `tags` included only when `app.tag != null`, preventing null values in API payload
✅ **Naming Convention:** Correct mapping from Terraform `tag` (singular) to Azure API `tags` (plural)
✅ **Deferred Work Completion:** No deferred work for this task in following.md ✅
✅ **Deferred Work Recording:** No deferrals made by this task ✅
✅ **Edge Cases:** All edge cases properly analyzed (null semantics, empty list, empty string validation, pass-through value behavior, update handling)
✅ **Proof Document Quality:** Complete with all required sections, Go code evidence, path verification, no forbidden deviation phrases
✅ **Merge Structure:** No duplicate keys - `applicationProfile` appears once in properties merge, proper conditional structure for optional field

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`:
- Provider schema: `Type: TypeString, Optional: true, ValidateFunc: validation.StringIsNotEmpty`
- Implementation: `optional(string)` with validation `length(app.tag) > 0` when non-null
- Assignment path verified with complete Go code trace matching Azure API schema
- Conditional rendering correctly handles optional field without sending null to API
- No deviations, simplifications, or "safer alternatives" found

**Status:** APPROVED ✅

---
