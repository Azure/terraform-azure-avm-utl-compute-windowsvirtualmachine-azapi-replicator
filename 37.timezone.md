# Task #37 - timezone - Proof Document

## Summary

Implemented the `timezone` root-level argument which maps to `properties.osProfile.windowsConfiguration.timeZone` in the Azure API. The field is ForceNew, optional, and requires validation against a specific list of valid Windows timezone strings.

## Shadow Implementation

```hcl
# variables.tf
variable "timezone" {
  type        = string
  default     = null
  description = "(Optional) Specifies the Time Zone which should be used by the Virtual Machine..."
  
  validation {  # <-
    condition = var.timezone == null || contains([  # <-
      "",  # <-
      "Afghanistan Standard Time",  # <-
      "Alaskan Standard Time",  # <-
      # ... (full list of 106 valid timezone strings)  # <-
    ], var.timezone)  # <-
    error_message = "The timezone must be a valid Windows timezone string..."  # <-
  }  # <-
}

# migrate_main.tf
locals {
  replace_triggers_external_values = {
    # ...
    timezone = { value = var.timezone }  # <-
  }
  
  body = {
    properties = merge(
      {
        osProfile = merge(
          # ...
          {
            windowsConfiguration = merge(
              # ...
              var.timezone != null ? {  # <-
                timeZone = var.timezone  # <-
              } : {}  # <-
            )
          }
        )
      }
    )
  }
}
```

## Create Phase Verification

**Query Method:** `query_terraform_block_implementation_source_code` with `entrypoint_name=create`

**Pattern:** Single-phase create operation

**Field Classification:** Create phase - field is set during primary `CreateOrUpdateThenPoll`

**Evidence from Create Method:**
```go
if v, ok := d.GetOk("timezone"); ok {
    params.Properties.OsProfile.WindowsConfiguration.TimeZone = pointer.To(v.(string))
}
```

**Decision:** Field belongs in `local.body`, not in any post-creation operation.

## Assignment Path Verification

**Predicted Path:** `body.properties.osProfile.windowsConfiguration.timeZone`

**Go Code Evidence:**
```go
// From resourceWindowsVirtualMachineCreate
params := virtualmachines.VirtualMachine{
    Properties: &virtualmachines.VirtualMachineProperties{
        OsProfile: &virtualmachines.OSProfile{
            WindowsConfiguration: &virtualmachines.WindowsConfiguration{
                // ... other fields
            },
        },
    },
}

// Later in the function:
if v, ok := d.GetOk("timezone"); ok {
    params.Properties.OsProfile.WindowsConfiguration.TimeZone = pointer.To(v.(string))
}
```

**Assignment Trace:**
1. `params.Properties` → Creates `VirtualMachineProperties` struct
2. `.OsProfile` → Adds `OSProfile` object
3. `.WindowsConfiguration` → Adds `WindowsConfiguration` object
4. `.TimeZone` → Final field assignment

**Verified Path:** `properties.osProfile.windowsConfiguration.timeZone`

**Path Comparison:** ✅ Match - Predicted path matches verified path

## Provider Schema

**Source:** `resourceWindowsVirtualMachine()` schema definition

```go
"timezone": {
    Type:         pluginsdk.TypeString,
    Optional:     true,
    ForceNew:     true,
    ValidateFunc: computeValidate.VirtualMachineTimeZone(),
},
```

**Key Properties:**
- **Type:** String
- **Optional:** true
- **ForceNew:** true (changes force new resource)
- **ValidateFunc:** `computeValidate.VirtualMachineTimeZone()` - validates against a list of valid timezone strings

**Validation Function Implementation:**
```go
func virtualMachineTimeZone(ignoreCase bool) pluginsdk.SchemaValidateFunc {
    // Candidates are listed here: http://jackstromberg.com/2017/01/list-of-time-zones-consumed-by-azure/
    candidates := []string{
        "",
        "Afghanistan Standard Time",
        "Alaskan Standard Time",
        // ... 106 total valid timezone values including empty string
        "Yakutsk Standard Time",
    }
    return validation.StringInSlice(candidates, ignoreCase)
}
```

## Azure API Schema

**Query Method:** `query_azapi_resource_schema`

**Resource Type:** `Microsoft.Compute/virtualMachines@2024-03-01`

**Property Path:** `body.properties.osProfile.windowsConfiguration.timeZone`

**Schema Type:** `String` (optional field in ObjectWithOptionalAttrs)

**Evidence:**
```
ObjectWithOptionalAttrs(map[string]Type{
    "timeZone":String,
    // ... other windowsConfiguration fields
}, []string{"timeZone", ...})
```

## Hidden Fields

None. The timezone field is explicitly defined in the schema with no hidden dependencies or hardcoded values.

## Mapping

**Terraform (snake_case):** `timezone`
**Azure API (camelCase):** `timeZone`

The mapping follows standard snake_case to camelCase conversion.

## Special Handling

### 1. Validation (MANDATORY)

Implemented validation in `variables.tf` using `contains()` function to check against the complete list of 106 valid Windows timezone strings as defined in the provider's validation function.

**List of Valid Values:**
- Empty string `""`
- 105 timezone names including:
  - "Afghanistan Standard Time"
  - "UTC", "UTC+12", "UTC-02", "UTC-11"
  - Various regional time zones (e.g., "Pacific Standard Time", "Eastern Standard Time")
  - Country-specific zones (e.g., "China Standard Time", "India Standard Time")

### 2. ForceNew Trigger

**Implementation:** Added to `replace_triggers_external_values` with wrapped value to ensure stable key:
```hcl
timezone = { value = var.timezone }
```

**Rationale:** Schema has `ForceNew: true`, which means any change to the timezone value must trigger resource replacement. The wrapped format ensures the key remains stable across applies while the value change triggers replacement.

### 3. Conditional Assignment

**Implementation:** Field is only added to `windowsConfiguration` when not null:
```hcl
var.timezone != null ? {
  timeZone = var.timezone
} : {}
```

**Rationale:** 
- Optional field with no default value
- When unset (null), the field is omitted from the API payload
- Azure API treats omitted field as "no timezone set" (uses default)

## Deferred Work Completion

**Check:** Reviewed `following.md` - file does not exist yet, no deferred work for this task.

## Critical Review & Edge Case Analysis

### Null Semantics
- **null:** Field is omitted from API payload, Azure uses default timezone behavior
- **Empty string (""):** Valid timezone value (included in validation list), explicitly sends empty string to API
- Both null and empty string are acceptable; null omits the field, empty string sends it

### Boundary Conditions
1. **Exact string matching:** Validation uses exact string matching (case-sensitive per `ignoreCase=false` in provider)
2. **String length:** No explicit length validation beyond the enum list
3. **Special characters:** Timezone strings can contain spaces, periods, parentheses, plus/minus signs (all valid per the list)

### Idempotency
- Direct value assignment ensures idempotent behavior
- No ordering concerns (single string value)
- ForceNew ensures consistency - changes always create new resource rather than attempting in-place update

### Safe References
- Direct variable reference `var.timezone` - safe as it's a root-level variable
- Null check `var.timezone != null` prevents sending unnecessary empty objects
- No nested property access that could fail on null values

### Edge Cases Identified
1. **Empty string vs null:** Both are valid but semantically different:
   - null = omit field from payload
   - "" = explicitly send empty string (valid per validation list)
2. **Case sensitivity:** Validation is case-sensitive; "UTC" is valid, "utc" would fail
3. **Whitespace:** Timezone names contain intentional spaces; trimming would break validation
4. **ForceNew behavior:** Any change (including null → value, value → null, value → different value) triggers replacement

## Checklist

- ✅ Property in correct local (`body.properties.osProfile.windowsConfiguration.timeZone`)
- ✅ ForceNew wrapped: `timezone = { value = var.timezone }` in `replace_triggers_external_values`
- ✅ All logic exactly replicated from provider (no shortcuts, no "safer" alternatives)
- ✅ Validations implemented in variables.tf (complete list of 106 valid timezone strings)
- ✅ Hidden fields checked (none found)
- ✅ Deferred work in following.md: N/A (no work deferred to other tasks)
- ✅ Deferred work from following.md: N/A (no work deferred to this task)
- ✅ Critical review completed (null, edge cases, idempotency, safe refs)
- ✅ Edge Case Analysis documented above
- ✅ Proof created
- ✅ track.md status will be updated to "Pending for check"
- ✅ Self-Review: Only implemented timezone field as required by Task #37, no additional fields added

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-24
**Task:** #37 - timezone

### Validation Results

✅ **ForceNew Logic:** Simple ForceNew (schema `ForceNew: true`) correctly implemented with stable key wrapping
✅ **Stable Keys:** Key `timezone` always present in `replace_triggers_external_values`, value wrapped in object
✅ **Phase Detection:** Field correctly placed in `local.body` (Create phase)
✅ **Type Conversion:** Direct string to string mapping (no conversion needed)
✅ **Null Handling:** Correctly propagates null semantics (null = omit field, empty string = valid value)
✅ **Validations:** All provider validations implemented - complete list of 106 valid timezone strings in variables.tf validation block
✅ **Assignment Path:** Correct path `body.properties.osProfile.windowsConfiguration.timeZone`
✅ **Shared Path Merge:** No duplicate parent keys, nested merge structure correct
✅ **Deferred Work Completion:** No deferred work for this task in following.md
✅ **Deferred Work Recording:** No deferrals made by this task
✅ **Edge Cases:** All edge cases properly analyzed and handled (null vs empty string, case sensitivity, ForceNew behavior)

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. No deviations, simplifications, or "safer alternatives" were found. The validation includes all 106 valid Windows timezone strings from the provider's `computeValidate.VirtualMachineTimeZone()` function. The ForceNew implementation follows the correct pattern for stable key tracking. The field is properly nested within the windowsConfiguration merge without causing any shared path conflicts.

**Status:** APPROVED ✅

---
