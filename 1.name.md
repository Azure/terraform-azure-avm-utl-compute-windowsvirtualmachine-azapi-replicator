# Task #1 - name - Proof Document

## Summary
Implemented the `name` argument for `azurerm_windows_virtual_machine` to `azapi_resource`. The `name` field is Required and ForceNew. Created the complete azapi_header structure with type, name, location, parent_id, tags, ignore_null_property, and retry. Added all provider validations to variables.tf and created resource_group_id variable for parent_id mapping.

## Shadow Implementation

### migrate_main.tf
```hcl
locals {
  replace_triggers_external_values = {
    name = { value = var.name }  # <-
  }
  body = { properties = {} }
  sensitive_body = { properties = {} }
  sensitive_body_version = {}
  azapi_header = {
    type                 = "Microsoft.Compute/virtualMachines@2024-03-01"  # <-
    name                 = var.name  # <-
    location             = var.location  # <-
    parent_id            = var.resource_group_id  # <-
    tags                 = var.tags  # <-
    ignore_null_property = true  # <-
    retry                = null  # <-
  }

  locks = []
}
```

### migrate_variables.tf
```hcl
variable "resource_group_id" {  # <-
  type        = string  # <-
  description = "The ID of the Resource Group in which the Windows Virtual Machine should exist."  # <-
  nullable    = false  # <-
}  # <-
```

### variables.tf
```hcl
variable "name" {
  type        = string
  description = "(Required) The name of the Windows Virtual Machine. Changing this forces a new resource to be created."
  nullable    = false

  validation {  # <-
    condition     = length(var.name) <= 80  # <-
    error_message = "The name can be at most 80 characters."  # <-
  }  # <-

  validation {  # <-
    condition     = can(regex("^[a-zA-Z0-9._-]+$", var.name))  # <-
    error_message = "The name may only contain alphanumeric characters, dots, dashes and underscores."  # <-
  }  # <-

  validation {  # <-
    condition     = can(regex("^[a-zA-Z0-9]", var.name))  # <-
    error_message = "The name must begin with an alphanumeric character."  # <-
  }  # <-

  validation {  # <-
    condition     = can(regex("\\w$", var.name))  # <-
    error_message = "The name must end with an alphanumeric character or underscore."  # <-
  }  # <-

  validation {  # <-
    condition     = !can(regex("^\\d+$", var.name))  # <-
    error_message = "The name cannot contain only numbers."  # <-
  }  # <-
}
```

## Create Phase Verification

### Pattern Identification
Query: `query_terraform_block_implementation_source_code(entrypoint_name="create")`

Evidence from Create method:
```go
func resourceWindowsVirtualMachineCreate(d *pluginsdk.ResourceData, meta interface{}) error {
	client := meta.(*clients.Client).Compute.VirtualMachinesClient
	subscriptionId := meta.(*clients.Client).Account.SubscriptionId
	ctx, cancel := timeouts.ForCreate(meta.(*clients.Client).StopContext, d)
	defer cancel()

	id := virtualmachines.NewVirtualMachineID(subscriptionId, d.Get("resource_group_name").(string), d.Get("name").(string))
	
	// ... builds params as virtualmachines.VirtualMachine
	
	params := virtualmachines.VirtualMachine{
		Name:             pointer.To(id.VirtualMachineName),
		// ... other properties
	}
	
	if err := client.CreateOrUpdateThenPoll(ctx, id, params, virtualmachines.DefaultCreateOrUpdateOperationOptions()); err != nil {
		return fmt.Errorf("creating Windows %s: %+v", id, err)
	}

	d.SetId(id.ID())
	return resourceWindowsVirtualMachineRead(d, meta)
}
```

**Decision**: Single-phase operation. The `name` field is used in the primary `CreateOrUpdateThenPoll` operation. No post-creation operations are present. The field belongs in the `azapi_header.name` property as it is a top-level identifier for the resource.

## Assignment Path Verification

### Predicted Path
`azapi_header.name` (top-level resource identifier)

### Go Code Evidence
```go
id := virtualmachines.NewVirtualMachineID(subscriptionId, d.Get("resource_group_name").(string), d.Get("name").(string))

params := virtualmachines.VirtualMachine{
	Name:             pointer.To(id.VirtualMachineName),
	// ...
}
```

The `name` is extracted from `d.Get("name")` and assigned to `id.VirtualMachineName`, then assigned to `params.Name` as a top-level property of the `VirtualMachine` struct. This corresponds to the Azure API resource name field.

### Verified Path
`azapi_header.name`

### Path Comparison
✅ Match. The predicted path matches the verified path. The `name` is a top-level resource identifier in both AzureRM and AzAPI providers.

## Provider Schema

### Schema Definition
```go
"name": {
	Type:         pluginsdk.TypeString,
	Required:     true,
	ForceNew:     true,
	ValidateFunc: computeValidate.VirtualMachineName,
},
```

### Validation Function
```go
func VirtualMachineName(i interface{}, k string) (warnings []string, errors []error) {
	v, ok := i.(string)
	if !ok {
		errors = append(errors, fmt.Errorf("expected %q to be a string but it wasn't", k))
		return
	}

	// The value must not be empty.
	if strings.TrimSpace(v) == "" {
		errors = append(errors, fmt.Errorf("%q must not be empty", k))
		return
	}

	const maxLength = 80
	// VM name can be 1-80 characters in length
	if len(v) > maxLength {
		errors = append(errors, fmt.Errorf("%q can be at most %d characters, got %d", k, maxLength, len(v)))
	}

	if matched := regexp.MustCompile(`^[a-zA-Z0-9._-]+$`).Match([]byte(v)); !matched {
		errors = append(errors, fmt.Errorf("%q may only contain alphanumeric characters, dots, dashes and underscores", k))
	}

	if matched := regexp.MustCompile(`^[a-zA-Z0-9]`).Match([]byte(v)); !matched {
		errors = append(errors, fmt.Errorf("%q must begin with an alphanumeric character", k))
	}

	if matched := regexp.MustCompile(`\w$`).Match([]byte(v)); !matched {
		errors = append(errors, fmt.Errorf("%q must end with an alphanumeric character or underscore", k))
	}

	// Portal: Virtual machine name cannot contain only numbers.
	if matched := regexp.MustCompile(`^\d+$`).Match([]byte(v)); matched {
		errors = append(errors, fmt.Errorf("%q cannot contain only numbers", k))
	}

	return warnings, errors
}
```

**Key Attributes**:
- Type: String
- Required: Yes
- ForceNew: Yes
- Validation: Custom function `VirtualMachineName` with multiple rules

## Azure API Schema

Query: `query_azapi_resource_schema(resource_type="Microsoft.Compute/virtualMachines", api_version="2024-03-01", path="name")`

Result: `String`

The Azure API schema confirms that `name` is a string property at the resource level.

## Hidden Fields

No hidden fields detected for the `name` property. The `name` is explicitly defined in the schema and directly used in the Create operation.

## Mapping

| AzureRM Field | AzAPI Field | Notes |
|---------------|-------------|-------|
| `name` | `azapi_header.name` | Top-level resource identifier |

The field name remains `name` in both providers. No case conversion needed.

## Special Handling

### ForceNew
**Schema Evidence**: `ForceNew: true`

**Implementation**: Added to `replace_triggers_external_values` using Mode 1 (Direct Value Tracking):
```hcl
replace_triggers_external_values = {
  name = { value = var.name }
}
```

The key `name` is always present, and the wrapped value ensures any change to the name triggers resource replacement.

### Validations
All validations from the provider's `VirtualMachineName` function have been replicated in `variables.tf`:

1. **Length constraint**: Maximum 80 characters
2. **Character set**: Only alphanumeric characters, dots, dashes, and underscores
3. **Start character**: Must begin with alphanumeric character
4. **End character**: Must end with alphanumeric character or underscore
5. **Numeric-only restriction**: Cannot contain only numbers

Implementation matches the exact validation logic from the provider source code.

### Parent ID Mapping
The `resource_group_name` in AzureRM is translated to `parent_id` in AzAPI. Created a new variable `resource_group_id` in `migrate_variables.tf` to hold the Resource Group ID, which is used as the `parent_id` in the azapi_header.

## Deferred Work Completion

No deferred work was assigned to this task in `following.md`.

## Edge Case Analysis

### Null Semantics
- `name` is Required and `nullable = false`, so null is not a valid value
- The validation blocks will catch invalid values before reaching the API

### Boundary Conditions
- **Empty string**: Caught by Terraform's required constraint and provider validation
- **Maximum length (80 characters)**: Explicitly validated
- **Minimum length (1 character)**: Implicit in the non-empty requirement and start character validation

### Idempotency
- The `name` field is stable and deterministic
- No transformation or ordering concerns
- Direct value-to-value mapping ensures idempotent behavior

### Safe References
- `var.name` is always available as it's a required field
- No nested access or conditional references needed
- No risk of null pointer exceptions

### Special Edge Cases
1. **Numeric-only names**: Explicitly rejected by validation (e.g., "123456")
2. **Leading/trailing special characters**: Rejected by start/end character validations
3. **Invalid characters**: Caught by character set validation (e.g., spaces, @, #)
4. **Case sensitivity**: Azure resource names are case-insensitive, but we preserve user input
5. **Unicode characters**: Rejected by the alphanumeric-only pattern

## Checklist

- ✅ Property in correct local (azapi_header.name)
- ✅ ForceNew wrapped: `{ value = var.name }`
- ✅ All logic EXACTLY replicated from provider (5 validation rules)
- ✅ Validations IMPLEMENTED in variables.tf (not deferred to Azure API)
- ✅ TODO comment added to original field in variables.tf (N/A - not a sensitive field)
- ✅ Hidden fields checked (none found)
- ✅ Deferred work in following.md (N/A - no work deferred)
- ✅ Deferred work from following.md (none assigned to this task)
- ✅ Critical review (null, edge, idempotent, safe refs)
- ✅ Edge Case Analysis in proof
- ✅ Proof created
- ✅ track.md ready to update to Pending for check
- ✅ Self-Review: Added ONLY what Task #1 requires (name field, azapi_header initialization, resource_group_id variable, validations)

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-24
**Task:** #1 - name

### Validation Results

✅ **ForceNew Logic:** Simple ForceNew (schema `ForceNew: true`) correctly implemented with wrapped value tracking `name = { value = var.name }`
✅ **Stable Keys:** The key `name` is always present in `replace_triggers_external_values`
✅ **Phase Detection:** Field correctly placed in `azapi_header.name` (Create phase, top-level resource identifier)
✅ **Type Conversion:** Correct - String to String, no conversion needed
✅ **Null Handling:** Correctly set `nullable = false` for Required field
✅ **Validations:** All 5 provider validations exactly replicated in `variables.tf`:
  - Length constraint (max 80 characters)
  - Character set validation (alphanumeric, dots, dashes, underscores)
  - Start character validation (must begin with alphanumeric)
  - End character validation (must end with alphanumeric or underscore)
  - Numeric-only restriction (cannot contain only numbers)
✅ **Deferred Work Completion:** No `following.md` exists, no deferred work to complete
✅ **Deferred Work Recording:** No deferrals made in this task
✅ **Edge Cases:** Properly analyzed - null semantics, boundary conditions, idempotency, safe references
✅ **azapi_header Structure:** Complete with all required fields (type, name, location, parent_id, tags, ignore_null_property, retry)
✅ **resource_group_id Variable:** Created in `migrate_variables.tf` with correct type, description, and `nullable = false`
✅ **terraform.tf File:** Exists with azapi provider requirement `~> 2.0` (actual version `~> 2.4` is acceptable)
✅ **Shared Path Merge:** No merge conflicts - each key appears once at its level
✅ **Sensitive Field Handling:** N/A - name is not a sensitive field

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. No deviations, simplifications, or "safer alternatives" were found.

**Status:** APPROVED ✅

---
