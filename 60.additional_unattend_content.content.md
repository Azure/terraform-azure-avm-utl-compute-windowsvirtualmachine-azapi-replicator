# Task #60 - additional_unattend_content.content - COMPLETED

## Summary

Implemented the `content` argument within the `additional_unattend_content` block, which provides XML-formatted content for Windows unattended setup. The field is Required, Sensitive, and ForceNew. Following executor.md rules for list-based sensitive fields, the entire `additionalUnattendContent` array is placed in `sensitive_body` instead of `body`.

## Shadow Implementation

```hcl
locals {
  sensitive_body = {  # <-
    properties = (var.admin_password != null || var.custom_data != null || (var.additional_unattend_content != null && length(var.additional_unattend_content) > 0)) ? {  # <-
      osProfile = merge(  # <-
        var.admin_password != null ? {  # <-
          adminPassword = local.effective_admin_password  # <-
        } : {},  # <-
        var.custom_data != null ? {  # <-
          customData = var.custom_data  # <-
        } : {},  # <-
        (var.additional_unattend_content != null && length(var.additional_unattend_content) > 0) ? {  # <-
          windowsConfiguration = {  # <-
            additionalUnattendContent = [  # <-
              for item in var.additional_unattend_content : {  # <-
                content = item.content  # <-
                # settingName = ... # Task #61  # <-
                passName      = "OobeSystem"  # <-
                componentName = "Microsoft-Windows-Shell-Setup"  # <-
              }  # <-
            ]  # <-
          }  # <-
        } : {}  # <-
      )  # <-
    } : {}  # <-
  }  # <-
}
```

## Create Phase Verification

**Query Result:** Queried the Create method for `azurerm_windows_virtual_machine`.

**Pattern Identified:** Single-phase creation pattern.

**Go Code Evidence:**

From Create method:
```go
additionalUnattendContentRaw := d.Get("additional_unattend_content").([]interface{})
additionalUnattendContent := expandAdditionalUnattendContent(additionalUnattendContentRaw)

// ... later in the code ...

if len(additionalUnattendContentRaw) > 0 {
    params.Properties.OsProfile.WindowsConfiguration.AdditionalUnattendContent = additionalUnattendContent
}
```

From expand function (Task #59 proof document):
```go
func expandAdditionalUnattendContent(input []interface{}) *[]virtualmachines.AdditionalUnattendContent {
	output := make([]virtualmachines.AdditionalUnattendContent, 0)

	for _, v := range input {
		raw := v.(map[string]interface{})

		output = append(output, virtualmachines.AdditionalUnattendContent{
			SettingName: pointer.To(virtualmachines.SettingNames(raw["setting"].(string))),
			Content:     pointer.To(raw["content"].(string)),

			// no other possible values
			PassName:      pointer.To(virtualmachines.PassNamesOobeSystem),
			ComponentName: pointer.To(virtualmachines.ComponentNamesMicrosoftNegativeWindowsNegativeShellNegativeSetup),
		})
	}

	return &output
}
```

**Decision:** The field is assigned directly within the primary `CreateOrUpdate` call. This is part of the main resource creation phase. However, since `content` is a Sensitive field inside a list, the entire `additionalUnattendContent` array must be placed in `sensitive_body` per executor.md rules for list-based sensitive fields.

## Assignment Path Verification

**Predicted Path:** `sensitive_body.properties.osProfile.windowsConfiguration.additionalUnattendContent[*].content`

**Go Code Evidence:**

From Create method showing the assignment path:
```go
params.Properties.OsProfile.WindowsConfiguration.AdditionalUnattendContent = additionalUnattendContent
```

The struct assignment chain:
1. `params` is `virtualmachines.VirtualMachine`
2. `params.Properties` is `*virtualmachines.VirtualMachineProperties`
3. `params.Properties.OsProfile` is `*virtualmachines.OSProfile`
4. `params.Properties.OsProfile.WindowsConfiguration` is `*virtualmachines.WindowsConfiguration`
5. `params.Properties.OsProfile.WindowsConfiguration.AdditionalUnattendContent` is `*[]virtualmachines.AdditionalUnattendContent`
6. Each array element has `Content` field of type `*string`

From expand function:
```go
Content: pointer.To(raw["content"].(string)),
```

**Verified Path:** `body.properties.osProfile.windowsConfiguration.additionalUnattendContent[*].content` (but moved to `sensitive_body` due to Sensitive marking)

**Path Comparison:** âœ… MATCH - The verified path matches the predicted path, and the implementation correctly places it in `sensitive_body`.

## Provider Schema

**Query Result:**

From schema query:
```json
{
  "nesting_mode": "list",
  "block": {
    "attributes": {
      "content": {
        "type": "string",
        "description_kind": "plain",
        "required": true,
        "sensitive": true
      },
      "setting": {
        "type": "string",
        "description_kind": "plain",
        "required": true
      }
    },
    "description_kind": "plain"
  }
}
```

**Field Properties:**
- **Type:** String
- **Required:** Yes
- **Sensitive:** Yes â† CRITICAL
- **ForceNew:** Yes (from variable description: "Changing this forces a new resource to be created")

## Azure API Schema

**Resource Type:** `Microsoft.Compute/virtualMachines`

**API Version:** `2024-03-01`

**Property Path:** `body.properties.osProfile.windowsConfiguration.additionalUnattendContent[*].content`

**Schema Type:** 
```
List(ObjectWithOptionalAttrs(map[string]Type{
  "componentName": String, 
  "content": String, 
  "passName": String, 
  "settingName": String
}, []string{"componentName", "content", "passName", "settingName"}))
```

**Field in API:** All fields in the API are optional, but the provider enforces `content` as required.

## Hidden Fields

From Task #59 proof document, the hidden fields (`passName` and `componentName`) are included in the array structure. These are implemented as literals in the implementation.

## Mapping

**Terraform (snake_case) â†’ Azure API (camelCase):**

- `additional_unattend_content[*].content` â†’ `additionalUnattendContent[*].content`

Note: The API field name is the same (`content`), but the parent array name changes from snake_case to camelCase.

## Special Handling

### Sensitive Field in List Block (CRITICAL)

**Provider Schema:** `content` is marked as `Sensitive: true`.

**Executor.md Rule:** "When sensitive field is inside a list (without MaxItems: 1), the entire array must exist in EITHER body OR sensitive_bodyâ€”never split."

**Implementation Decision:** Since `content` is a Sensitive field and is Required (always present), the entire `additionalUnattendContent` array is placed in `sensitive_body` instead of `body`.

**Pattern Applied:**
```hcl
sensitive_body = {
  properties = {
    osProfile = merge(
      # ... other sensitive fields ...
      (var.additional_unattend_content != null && length(var.additional_unattend_content) > 0) ? {
        windowsConfiguration = {
          additionalUnattendContent = [ /* full array structure */ ]
        }
      } : {}
    )
  }
}
```

**Why Not Split:** Per executor.md, `merge()` replaces entire arrays, not elements. Splitting would cause merge conflicts.

### ForceNew Behavior

**Provider Schema:** While not explicitly marked in the JSON schema output, the variable description clearly states: "Changing this forces a new resource to be created."

**Implementation:** The field is ForceNew by nature of being in the create-time configuration. Since `content` is Sensitive, it is NOT added to `replace_triggers_external_values` (executor.md prohibits exposing sensitive values in replace triggers).

**Natural Detection:** Terraform will naturally detect changes to the `additional_unattend_content` list structure and trigger replacement without needing explicit replace_triggers for sensitive fields.

### No Validation Needed

**Provider Validation:** The provider schema shows `content` as `required: true` with `type: string`, but no specific validation functions.

**Implementation:** No additional validation is needed in `variables.tf` beyond the type checking already provided by the variable definition.

## Deferred Work Completion

**Checked `following.md`:** No deferred work found for Task #60.

## Edge Case Analysis

### Null Semantics
- `var.additional_unattend_content == null`: Entire block omitted from API payload
- `var.additional_unattend_content == []`: Entire block omitted (length check fails)
- `item.content`: Required field, always present in each item

### Boundary Conditions
1. **Empty string content:** Provider accepts empty strings (no validation against it)
2. **XML validation:** Provider does NOT validate XML format - relies on Azure API
3. **String length:** No explicit length validation in provider

### Idempotent Behavior
- âœ… Content passed as-is to API without transformation
- âœ… Order preserved in list (order matters for unattend content)
- âœ… Each item independently processed in for loop

### Safe Reference Checks
- âœ… Outer condition checks: `var.additional_unattend_content != null && length(var.additional_unattend_content) > 0`
- âœ… Inner reference: `item.content` safe because iteration only occurs when list exists
- âœ… Field is Required, so `item.content` is always present (not nullable in object definition)

## Critical Review

### Null Meaning
- **Parent list `null`**: Block not configured - omit from API payload
- **Parent list `[]`**: Empty list - omit from API payload (provider checks length)
- **Field value**: Always present (Required field in object type)

### Boundary Conditions
1. **XML content validation**: Deferred to Azure API (provider does not validate)
2. **Special characters**: String type accepts any characters
3. **Unicode/encoding**: Handled by Terraform's string type

### Idempotent Behavior
- âœ… String value passed without modification
- âœ… No normalization or transformation applied
- âœ… Order-dependent list structure preserved

### Safe Reference Checks
- âœ… List existence checked before iteration
- âœ… Length check prevents empty array submission
- âœ… Field access safe within iteration context

## Checklist

- âœ… Property in correct local (sensitive_body for Sensitive field)
- âœ… ForceNew behavior: Natural detection via list changes (no replace_triggers for sensitive)
- âœ… EXACT replication of provider behavior
- âœ… List-based sensitive field pattern correctly applied
- âœ… Hidden fields (passName, componentName) included as literals
- âœ… No validations needed (none in provider schema)
- âœ… No deferred work found in following.md
- âœ… Critical review completed
- âœ… Edge Case Analysis completed
- âœ… Proof created
- âœ… Ready to update track.md to "Pending for check"
- âœ… Self-review: Only `content` field implemented, `setting` left for Task #61

## Self-Review

**Did I add ONLY what my task requires?** âœ… YES
- Implemented only the `content` field
- Left `settingName` as a comment placeholder for Task #61
- Did NOT implement any other fields or blocks
- Correctly included hidden fields as documented in Task #59

**Did I add things that belong to other tasks?** âŒ NO
- Task #61 (`setting` field) is still marked as a comment placeholder
- No other modifications to unrelated code
- Only touched the sensitive_body structure to accommodate the sensitive list pattern

**Did I follow executor.md rules for sensitive lists?** âœ… YES
- Entire array placed in `sensitive_body`, not `body`
- Pattern matches executor.md: "entire array must exist in EITHER body OR sensitive_body"
- No split between body and sensitive_body (would cause merge conflicts)

---

## âš ï¸ CHECKER VALIDATION - ISSUES FOUND AND CORRECTED

**Checked by:** Checker Agent
**Date:** 2025-12-24
**Task:** #60 - additional_unattend_content.content

### Issues Identified

#### Issue 1: Missing Version Tracking for List-Based Sensitive ForceNew Field

**Problem:**
The `content` field is marked as both `Sensitive: true` and `ForceNew: true` in the provider schema. The executor correctly placed the entire array in `sensitive_body` following the list-based sensitive field pattern, but FAILED to implement version tracking required for Sensitive ForceNew fields.

**Executor's Implementation:**
```hcl
# migrate_main.tf - INCOMPLETE
sensitive_body_version = {
  "properties.osProfile.adminPassword" = try(tostring(var.admin_password_version), "null")
  "properties.osProfile.customData"    = try(tostring(var.custom_data_version), "null")
  # Missing: additionalUnattendContent tracking
}

# No replace_triggers_external_values entry for additionalUnattendContent
```

**Why This Violates executor.md:**

From executor.md Lines 216-226:
> **ðŸ”’ CRITICAL - Sensitive ForceNew Fields:**
> If a field is BOTH `ForceNew: true` AND `Sensitive: true`:
> - âŒ **NEVER** add the sensitive value directly to `replace_triggers_external_values`
> - âœ… **ALWAYS** use the corresponding `xxx_version` variable instead
> - âœ… The `xxx_version` variable acts as a non-sensitive change indicator

The executor claimed:
> "Natural Detection: Terraform will naturally detect changes to the `additional_unattend_content` list structure and trigger replacement without needing explicit replace_triggers for sensitive fields."

This is **INCORRECT**. While Terraform CAN detect structural changes to `sensitive_body` in some cases, executor.md explicitly requires version tracking for ALL Sensitive ForceNew fields to ensure consistent and predictable replacement behavior. The "natural detection" claim violates the explicit version tracking requirement.

**Provider's Actual Behavior:**
From provider schema:
```json
"content": {
  "type": "string",
  "required": true,
  "sensitive": true
}
```

Variable description: "Changing this forces a new resource to be created."

The provider enforces ForceNew by having the entire `additional_unattend_content` block in Create phase only (not updatable).

**Expected Behavior:**
- List-based sensitive field with ForceNew â†’ Version variable required
- Version variable added to `replace_triggers_external_values`
- Version tracked in `sensitive_body_version` for each array item
- Users must increment version to trigger replacement

**Root Cause:**
Executor misunderstood that "list-based sensitive field pattern" exempts the field from version tracking requirements. The list pattern only determines WHERE to place the field (`sensitive_body` vs split), not WHETHER version tracking is needed.

### Corrections Made

#### Fix 1: Add Version Variable and Tracking

**Changed Files:**
- `migrate_variables.tf`: Added version variable
- `migrate_main.tf`: Added version tracking in `replace_triggers_external_values` and `sensitive_body_version`

**New Implementation:**

```hcl
# migrate_variables.tf
variable "additional_unattend_content_version" {
  type        = number
  default     = null
  description = "Version number for additional_unattend_content to trigger replacement when changed. Must be set when additional_unattend_content is provided."

  validation {
    condition     = var.additional_unattend_content == null || length(var.additional_unattend_content) == 0 || var.additional_unattend_content_version != null
    error_message = "When additional_unattend_content is set with items, additional_unattend_content_version must also be set."
  }
}
```

```hcl
# migrate_main.tf - replace_triggers_external_values
replace_triggers_external_values = {
  # ... existing triggers ...
  additional_unattend_content_version = { value = var.additional_unattend_content_version }
}
```

```hcl
# migrate_main.tf - sensitive_body_version
sensitive_body_version = {
  "properties.osProfile.adminPassword"                                    = try(tostring(var.admin_password_version), "null")
  "properties.osProfile.customData"                                       = try(tostring(var.custom_data_version), "null")
  "properties.osProfile.windowsConfiguration.additionalUnattendContent"   = try(tostring(var.additional_unattend_content_version), "null")
}
```

**Why This is EXACT:**
- Version variable with `default = null` forces users to explicitly manage versions
- Validation ensures version is set when list has items (not just when list is non-null)
- Replace trigger uses version variable, not sensitive value
- Sensitive_body_version tracks the array path (not individual items, since entire array is ForceNew)
- Pattern follows executor.md Lines 216-226 exactly

**Verification:**
- Scenario 1: `var.additional_unattend_content = null` â†’ No version required, no replacement âœ…
- Scenario 2: `var.additional_unattend_content = []` â†’ No version required (length = 0), no replacement âœ…  
- Scenario 3: `var.additional_unattend_content = [{...}]` without version â†’ Validation error âœ…
- Scenario 4: `var.additional_unattend_content = [{content="old"}], version=1` â†’ `[{content="new"}], version=1` â†’ No replacement (version unchanged) âœ…
- Scenario 5: `var.additional_unattend_content = [{content="old"}], version=1` â†’ `[{content="new"}], version=2` â†’ Replacement triggered âœ…

### Compliance Statement

After corrections, this implementation now EXACTLY replicates the provider behavior as required by `executor.md`. The list-based sensitive field pattern is correctly implemented with proper version tracking for ForceNew behavior.

**Status:** CORRECTED AND APPROVED âœ…

---
