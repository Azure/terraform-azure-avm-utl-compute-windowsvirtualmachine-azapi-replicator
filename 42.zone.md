# Task #42 - zone - COMPLETED

## Summary

Implemented the `zone` root-level argument for Windows Virtual Machine. This field specifies the Availability Zone within the Azure Region. The provider accepts a single string value, which the Azure API expects as a single-element array. ForceNew: true triggers resource replacement on changes.

## Provider Schema

From `resourceWindowsVirtualMachine()` in `internal/services/compute/windows_virtual_machine_resource.go`:

```go
"zone": commonschema.ZoneSingleOptionalForceNew(),
```

**Key Observations**:
- **Type**: String (single zone value)
- **Optional**: true
- **ForceNew**: true (from `ZoneSingleOptionalForceNew()`)
- **ConflictsWith**: `availability_set_id` (from Task #10 proof)

The `commonschema.ZoneSingleOptionalForceNew()` function creates a schema for a single availability zone with ForceNew behavior.

## Create Phase Verification

**Query**: `resourceWindowsVirtualMachineCreate` in `internal/services/compute/windows_virtual_machine_resource.go`

**Pattern**: Single-phase creation (one `CreateOrUpdateThenPoll` call)

**Field Assignment** (from source code lines 938-942):

```go
if v, ok := d.GetOk("zone"); ok {
	params.Zones = &[]string{
		v.(string),
	}
}
```

**Evidence**:
1. Field is read as string from Terraform config
2. Converted to pointer to string slice with single element
3. Assigned to `params.Zones` before `CreateOrUpdateThenPoll` call
4. Part of primary create operation (not post-creation)

**Decision**: Field is set during **Create phase** in the primary `CreateOrUpdate` operation.

## Assignment Path Verification

**Predicted Path**: `zones` (root-level field in Azure API)

**Go Code Evidence**:

```go
params := virtualmachines.VirtualMachine{
	Name:             pointer.To(id.VirtualMachineName),
	ExtendedLocation: expandEdgeZone(d.Get("edge_zone").(string)),
	Location:         location.Normalize(d.Get("location").(string)),
	// ... other root-level fields
	Properties: &virtualmachines.VirtualMachineProperties{
		// ... properties
	},
	Tags: tags.Expand(t),
}

// Later in the function:
if v, ok := d.GetOk("zone"); ok {
	params.Zones = &[]string{
		v.(string),
	}
}
```

**Assignment Trace**:
1. `v.(string)` - String value from Terraform
2. `&[]string{v.(string)}` - Converted to pointer to single-element string slice
3. `params.Zones = ...` - Assigned to `Zones` field on root `VirtualMachine` struct
4. No intermediate structs - direct assignment to root-level field

**Verified Path**: `zones` (root-level API field)

**Path Comparison**: ✅ **MATCH** - Predicted path matches verified path.

## Azure API Schema

**Resource Type**: `Microsoft.Compute/virtualMachines`
**API Version**: `2024-03-01`

**Field**: `zones` (root-level, not in `properties`)

**Type**: `array of string` (but provider accepts single string and converts to array)

**Description**: Specifies the availability zone where the virtual machine should be created. For single-zone deployment, provide a single-element array.

## Hidden Fields

None. The `zone` field is explicitly defined in the Terraform schema and maps directly to the `zones` API field.

## Mapping

| Terraform (snake_case) | Azure API (camelCase) | Transformation |
|-------------------------|------------------------|----------------|
| `zone` | `zones` | String to single-element array |

**Note**: While the provider schema uses the singular `zone`, the Azure API uses the plural `zones` and expects an array. The provider implementation converts the single string value to a single-element array.

## Special Handling

### 1. ForceNew Behavior

**Provider Schema**: `ForceNew: true` (from `ZoneSingleOptionalForceNew()`)

**Implementation**: Added to `replace_triggers_external_values`:

```hcl
zone = { value = var.zone }  # <- Tracks full value
```

**Rationale**: 
- ForceNew triggers replacement when zone changes
- Wrapped in object to ensure stable key presence
- Tracks full value (not just presence) to detect: `null → "1"`, `"1" → "2"`, `"1" → null`

### 2. Type Conversion (String to Array)

**Provider Code**:
```go
params.Zones = &[]string{v.(string)}
```

**Replicator Implementation**:
```hcl
var.zone != null ? {
  zones = [var.zone]
} : {}
```

**Rationale**:
- Provider takes single string value from user
- Converts to single-element array for API
- We replicate this exact behavior in locals
- When `var.zone` is null, omit the `zones` field entirely (conditional merge)

### 3. Validations

**From existing `variables.tf` (Task #10)**:

```hcl
validation {
  condition     = var.zone == null || var.availability_set_id == null
  error_message = "availability_set_id cannot be used together with zone (ConflictsWith)."
}
```

This validation was already implemented by Task #10 for `availability_set_id`. No additional validations needed in this task.

**Cross-field Constraints** (already handled):
- ✅ **ConflictsWith availability_set_id**: Implemented by Task #10

## Deferred Work Completion

**Checked `following.md`**: No work was deferred to Task #42.

## Edge Case Analysis

### 1. Null Semantics
- **`null`**: No availability zone specified (VM can be placed in any zone or non-zonal)
- **Implementation**: When `var.zone == null`, the `zones` field is completely omitted from the body via conditional merge `var.zone != null ? {...} : {}`
- **Idempotent**: ✅ Null stays null, omitted field stays omitted

### 2. Empty String
- **Provider Behavior**: Empty string `""` would pass through as `Zones = &[]string{""}`
- **Problem**: Azure API may reject empty string
- **Mitigation**: While provider doesn't validate this, users should naturally provide valid zone IDs. The existing variable description in `variables.tf` should guide users to proper values.
- **Note**: Provider doesn't validate zone format (e.g., "1", "2", "3"), relies on Azure API validation

### 3. Value Changes
- **`null → "1"`**: Triggers replacement (ForceNew)
- **`"1" → "2"`**: Triggers replacement (ForceNew)
- **`"1" → null`**: Triggers replacement (ForceNew)
- **`"1" → "1"`**: No replacement (value unchanged)
- **Tracking**: `{ value = var.zone }` captures full value, ensuring all changes are detected

### 4. Array Conversion Safety
- **Single Value**: `[var.zone]` always produces single-element array when non-null
- **No Iteration**: No risk of `for` loops producing unexpected counts
- **Type Safety**: String type in `variables.tf` ensures correct type

### 5. Boundary Conditions
- **Invalid Zone**: Provider doesn't validate zone ID format. Azure API will reject invalid zones (e.g., "999", "invalid")
- **Multiple Zones**: Provider schema is single zone only (ZoneSingleOptional), cannot specify multiple
- **Regional Support**: Not all Azure regions support availability zones. Provider doesn't check region compatibility, relies on API validation

### 6. Safe References
- **Direct Reference**: `var.zone` is top-level variable, always safe to reference
- **No Nested Access**: No need for `try()` or null-checking complex paths
- **Conditional**: `var.zone != null` ensures we only create `zones` array when value exists

## Implementation

### migrate_main.tf

```hcl
locals {
  replace_triggers_external_values = {
    # ... other fields
    zone = { value = var.zone }  # <-
  }
  
  body = merge(
    {
      properties = merge(
        # ... properties
      )
    },
    local.effective_edge_zone != null ? {
      extendedLocation = {
        name = local.effective_edge_zone
        type = "EdgeZone"
      }
    } : {},
    var.zone != null ? {  # <-
      zones = [var.zone]  # <-
    } : {}  # <-
  )
}
```

### variables.tf

No changes needed. The `zone` variable already exists:

```hcl
variable "zone" {
  type        = string
  default     = null
  description = "* `zones`"
}
```

And the ConflictsWith validation with `availability_set_id` was already added by Task #10.

## Checklist

- ✅ Property in correct local (`body.zones` at root level)
- ✅ ForceNew wrapped: `{ value = var.zone }`
- ✅ ALL logic EXACTLY replicated from provider (string → single-element array conversion)
- ✅ Validations implemented (ConflictsWith handled by Task #10)
- ✅ Hidden fields checked (none)
- ✅ Deferred work in following.md: N/A (not deferring any work)
- ✅ Deferred work from following.md: Checked - no work deferred to this task
- ✅ Critical review (null, edge, idempotent, safe refs)
- ✅ Edge Case Analysis in proof
- ✅ Proof created
- ✅ `track.md` will be updated to Pending for check
- ✅ Self-Review: Only added `zone` field as required by this task

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-24
**Task:** #42 - zone

### Validation Results

✅ **ForceNew Logic:** Simple ForceNew correctly implemented with stable key and full value tracking
✅ **Stable Keys:** Key `zone` always present in `replace_triggers_external_values`
✅ **Phase Detection:** Field correctly placed in `local.body` (Create phase, root level)
✅ **Type Conversion:** Correct conversion from string to single-element array: `[var.zone]`
✅ **Null Handling:** Correctly propagates null semantics via conditional merge
✅ **Validations:** ConflictsWith validation with availability_set_id already implemented by Task #10
✅ **Deferred Work Completion:** No deferred work for this task (verified in following.md)
✅ **Deferred Work Recording:** No deferrals made by this task
✅ **Edge Cases:** All edge cases properly analyzed and handled (null semantics, array conversion, safe references)

### Detailed Verification

#### 1. ForceNew Implementation (Line 32 in migrate_main.tf)
```hcl
zone = { value = var.zone }
```
- ✅ Wrapped in object for stable key presence
- ✅ Tracks full value (not just presence) - detects null ↔ "1", "1" ↔ "2", etc.
- ✅ Matches executor.md Mode 1: Direct Value Tracking for schema `ForceNew: true`

#### 2. Type Conversion (Lines 285-287 in migrate_main.tf)
```hcl
var.zone != null ? {
  zones = [var.zone]
} : {}
```
- ✅ Exactly replicates provider logic: `params.Zones = &[]string{v.(string)}`
- ✅ String to single-element array conversion
- ✅ Conditional merge when null (omits field entirely)
- ✅ Root-level placement (outside properties)

#### 3. Phase Detection
- ✅ Provider code shows field assigned before primary `CreateOrUpdateThenPoll`
- ✅ Correctly placed in `local.body` (Create phase)
- ✅ No post-creation operations needed

#### 4. Validations
- ✅ ConflictsWith availability_set_id validation already exists in variables.tf (line 239-240)
- ✅ Validation correctly placed in `availability_set_id` variable (ownership rule)
- ✅ No additional validations required for zone field itself

#### 5. Proof Document Quality
- ✅ All required sections present
- ✅ Go code evidence provided
- ✅ Assignment path verification complete
- ✅ No forbidden phrases or deviations
- ✅ Comprehensive edge case analysis

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The field is correctly:
- Placed at root level in body (not in properties)
- Converted from string to single-element array
- Tracked for ForceNew with stable key and full value
- Validated for conflicts with availability_set_id (via Task #10)
- Handled for null semantics with conditional merge

No deviations, simplifications, or "safer alternatives" were found.

**Status:** APPROVED ✅

---
