# Task #65 - gallery_application.version_id

## Summary
Implemented the required `version_id` argument for `gallery_application` block, mapping to `packageReferenceId` in the Azure API. This field specifies the Gallery Application Version resource ID and is required when gallery_application is configured.

## Shadow Implementation
```hcl
locals {
  body = merge(
    {
      properties = merge(
        # ... other properties ...
        var.gallery_application != null && length(var.gallery_application) > 0 ? {
          applicationProfile = {
            galleryApplications = [
              for app in var.gallery_application : {
                packageReferenceId = app.version_id  # <-
                # other fields...
              }
            ]
          }
        } : {}
      )
    }
  )
}
```

## Create Phase Verification

### Single-Phase Pattern

From `resourceWindowsVirtualMachineCreate()`:

```go
params := virtualmachines.VirtualMachine{
	Name:             pointer.To(id.VirtualMachineName),
	ExtendedLocation: expandEdgeZone(d.Get("edge_zone").(string)),
	Location:         location.Normalize(d.Get("location").(string)),
	Identity:         identityExpanded,
	Plan:             plan,
	Properties: &virtualmachines.VirtualMachineProperties{
		ApplicationProfile: &virtualmachines.ApplicationProfile{
			GalleryApplications: expandVirtualMachineGalleryApplication(d.Get("gallery_application").([]interface{})),
		},
		// ... other properties
	},
	Tags: tags.Expand(t),
}

if err := client.CreateOrUpdateThenPoll(ctx, id, params, virtualmachines.DefaultCreateOrUpdateOperationOptions()); err != nil {
	return fmt.Errorf("creating Windows %s: %+v", id, err)
}
```

**Pattern Identification:**
- Single SDK operation: `CreateOrUpdateThenPoll`
- Gallery applications are part of the primary create request
- No post-creation operations for this field

**Decision:** This field is processed in the **Create phase** as part of `local.body.properties.applicationProfile.galleryApplications`

## Assignment Path Verification

### Predicted Path
`properties.applicationProfile.galleryApplications[*].packageReferenceId`

### Go Code Evidence

**1. Create method structure assignment:**
```go
Properties: &virtualmachines.VirtualMachineProperties{
	ApplicationProfile: &virtualmachines.ApplicationProfile{
		GalleryApplications: expandVirtualMachineGalleryApplication(d.Get("gallery_application").([]interface{})),
	},
}
```

**2. Expand function from `virtual_machine.go`:**
```go
func expandVirtualMachineGalleryApplication(input []interface{}) *[]virtualmachines.VMGalleryApplication {
	out := make([]virtualmachines.VMGalleryApplication, 0)
	if len(input) == 0 {
		return &out
	}

	for _, v := range input {
		config := v.(map[string]interface{})
		app := &virtualmachines.VMGalleryApplication{
			PackageReferenceId:              config["version_id"].(string),
			ConfigurationReference:          pointer.To(config["configuration_blob_uri"].(string)),
			Order:                           pointer.To(int64(config["order"].(int))),
			Tags:                            pointer.To(config["tag"].(string)),
			EnableAutomaticUpgrade:          pointer.To(config["automatic_upgrade_enabled"].(bool)),
			TreatFailureAsDeploymentFailure: pointer.To(config["treat_failure_as_deployment_failure_enabled"].(bool)),
		}

		out = append(out, *app)
	}

	return &out
}
```

**Key observations:**
- Direct assignment: `PackageReferenceId: config["version_id"].(string)`
- **No pointer wrapper** - this is a required string field
- Field is directly assigned without conditional logic

### Verified Path
`properties.applicationProfile.galleryApplications[*].packageReferenceId` ✅

**Path Comparison:** Predicted path matches verified path exactly.

## Provider Schema

From `VirtualMachineGalleryApplicationSchema()` in `internal/services/compute/virtual_machine.go`:

```go
func VirtualMachineGalleryApplicationSchema() *pluginsdk.Schema {
	return &pluginsdk.Schema{
		Type:     pluginsdk.TypeList,
		Optional: true,
		MaxItems: 100,
		Elem: &pluginsdk.Resource{
			Schema: map[string]*pluginsdk.Schema{
				"version_id": {
					Type:         pluginsdk.TypeString,
					Required:     true,
					ValidateFunc: galleryapplicationversions.ValidateApplicationVersionID,
				},
				// ... other fields
			},
		},
		ConflictsWith: []string{
			"os_managed_disk_id",
		},
	}
}
```

**Key Details:**
- **Type:** String
- **Required:** Yes
- **ForceNew:** No (not specified, defaults to false)
- **DiffSuppressFunc:** None
- **ValidateFunc:** `galleryapplicationversions.ValidateApplicationVersionID`
- **Conflicts:** Parent block has `ConflictsWith: ["os_managed_disk_id"]` (already handled by Task #64)

## Azure API Schema

From Azure Compute API specification for `Microsoft.Compute/virtualMachines@2024-03-01`:

**Property Path:** `properties.applicationProfile.galleryApplications[*].packageReferenceId`

**Type:** string

**Required:** Yes (within galleryApplications array item)

**Description:** Specifies the Gallery Application Version resource ID. The format is: `/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/galleries/{galleryName}/applications/{applicationName}/versions/{versionName}`

## Hidden Fields

From `expandVirtualMachineGalleryApplication()` function analysis:

All fields in the expand function correspond to schema fields:
- `PackageReferenceId` ← `version_id` (this task)
- `ConfigurationReference` ← `configuration_blob_uri` (Task #67)
- `Order` ← `order` (Task #68)
- `Tags` ← `tag` (Task #69)
- `EnableAutomaticUpgrade` ← `automatic_upgrade_enabled` (Task #66)
- `TreatFailureAsDeploymentFailure` ← `treat_failure_as_deployment_failure_enabled` (Task #70)

**Hidden Fields for This Task:** None ✅

## Mapping (snake_case → camelCase)

| Terraform (snake_case) | Azure API (camelCase) | Notes |
|------------------------|----------------------|-------|
| `version_id` | `packageReferenceId` | Required string, no pointer |

## Special Handling

### Validation

**Provider Validation:**
From schema: `ValidateFunc: galleryapplicationversions.ValidateApplicationVersionID`

This validates the Azure resource ID format for gallery application versions. The validation is imported from the Azure SDK package `github.com/hashicorp/go-azure-sdk/resource-manager/compute/2022-03-03/galleryapplicationversions`.

**Implementation Decision:**
The validation function `galleryapplicationversions.ValidateApplicationVersionID` is a complex Azure resource ID validation that:
1. Parses the resource ID structure
2. Validates segment names and values
3. Ensures proper hierarchy (subscription → resource group → gallery → application → version)

This is an Azure resource ID format validation which per executor.md line 123 can be skipped: "❌ Skip ONLY Azure Resource ID format validations (e.g., `/subscriptions/.../resourceGroups/...`) - these are verified by resource references"

The field is already defined as `version_id = string` in the parent `gallery_application` variable in `variables.tf`, so no additional validation block is needed for this task.

### ForceNew Behavior

**Schema Analysis:**
- `ForceNew: false` (default - not explicitly set)
- No CustomizeDiff logic
- No conditional ForceNew triggers

**Decision:** No ForceNew handling required. Updates to `version_id` are allowed without resource replacement.

### Sensitive Fields

**Schema Analysis:**
- `Sensitive: false` (default)
- Not marked as WriteOnly in API

**Decision:** Not a sensitive field. Value goes in `local.body`, not `local.sensitive_body`.

### Required Field Handling

**Schema shows Required: true**, meaning:
1. Field must be present when `gallery_application` block is used
2. The parent variable in `variables.tf` already enforces this:

```hcl
variable "gallery_application" {
  type = list(object({
    # ... other optional fields
    version_id = string  # Required - no optional() wrapper
  }))
}
```

3. No additional validation needed - Terraform's type system enforces the requirement

## Deferred Work Completion

Checked `following.md` for work deferred to Task #65: **None found** ✅

No work was deferred to this task by previous tasks.

## Edge Case Analysis

### Null Semantics

**Field-level null handling:**
- `version_id` is Required in the schema
- Cannot be null when `gallery_application` item exists
- Terraform type system enforces: `version_id = string` (not `optional(string)`)

**Block-level null handling:**
- Handled by parent block conditional: `var.gallery_application != null && length(var.gallery_application) > 0`
- If list is empty or null, entire `applicationProfile` is omitted

### Boundary Conditions

**Empty string:**
- Provider validation (`ValidateApplicationVersionID`) would reject empty string
- Validation occurs at Terraform plan time, not our responsibility
- Azure API would also reject invalid format

**Invalid resource ID format:**
- Caught by provider's `ValidateApplicationVersionID` function
- Validation ensures proper format before our module processes the value

**List iteration:**
- Safe iteration with `for app in var.gallery_application`
- List is guaranteed non-empty by outer condition check

### Idempotency

**Multiple applies with same value:**
- Direct string assignment: `packageReferenceId = app.version_id`
- No transformations or side effects
- Same input always produces same output ✅

**List ordering:**
- Terraform list maintains order
- Array order preserved in API payload
- Idempotent across multiple applies ✅

### Safe References

**Within for expression:**
- `app.version_id` is safe because:
  - Loop iterates over validated list items
  - `version_id` is Required in object schema
  - Type system guarantees field exists

**No nested optional fields:**
- Direct field access with no intermediate nullable steps
- No need for `try()` or null coalescing

## Checklist

- ✅ Property replaced comment placeholder in correct local (`local.body.properties.applicationProfile.galleryApplications`)
- ✅ Field mapped correctly: `version_id` → `packageReferenceId`
- ✅ Direct string assignment (no pointer) matches provider expand function
- ✅ No ForceNew handling needed (schema default is false)
- ✅ No Sensitive handling needed (not sensitive or writeonly)
- ✅ Provider validation acknowledged and documented (Azure Resource ID validation skipped per executor.md)
- ✅ Required field enforced by parent variable type definition
- ✅ Hidden fields checked (none for this field)
- ✅ Deferred work checked (none found)
- ✅ Create phase verified (single-phase, part of primary create)
- ✅ Assignment path verified from Go source code
- ✅ Edge cases analyzed (null semantics, boundaries, idempotency, safe refs)
- ✅ Proof document created
- ✅ Track.md updated to "Pending for check"
- ✅ Self-Review: Only `version_id` field implemented, no other fields added

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-24
**Task:** #65 - gallery_application.version_id

### Validation Results

✅ **ForceNew Logic:** No ForceNew required (schema default is false)
✅ **Stable Keys:** Not applicable (no replace_triggers_external_values entries for this field)
✅ **Phase Detection:** Field correctly placed in `local.body` (Create phase)
✅ **Type Conversion:** Correct mapping from string to string, no pointer wrapper (matches Go expand function)
✅ **Null Handling:** Correctly enforced as Required via Terraform type system (`version_id = string` not `optional(string)`)
✅ **Validations:** Azure Resource ID validation correctly identified and skipped per executor.md line 123
✅ **Deferred Work Completion:** No deferred work for this task (checked following.md)
✅ **Deferred Work Recording:** No deferrals made by this task
✅ **Edge Cases:** All edge cases properly analyzed (null semantics, boundaries, idempotency, safe references)
✅ **Field Mapping:** Correctly maps `version_id` → `packageReferenceId`
✅ **Assignment Path:** Verified path matches Go source code: `properties.applicationProfile.galleryApplications[*].packageReferenceId`

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The field is correctly:
- Mapped to the Azure API property name (`packageReferenceId`)
- Placed in the Create phase body
- Enforced as Required through Terraform's type system
- Direct string assignment without pointer wrapper (matching provider's expand function)
- Validated appropriately (Azure Resource ID validation skipped per executor.md)

No deviations, simplifications, or "safer alternatives" were found.

**Status:** APPROVED ✅

---
