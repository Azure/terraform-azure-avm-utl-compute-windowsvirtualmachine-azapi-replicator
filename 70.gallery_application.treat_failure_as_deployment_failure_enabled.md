# Task #70 - gallery_application.treat_failure_as_deployment_failure_enabled

## Summary

Implemented `gallery_application.treat_failure_as_deployment_failure_enabled` as an optional boolean field with default value `false` within the gallery_application list block. The field maps directly to the Azure API property `treatFailureAsDeploymentFailure` without any transformation logic.

## Shadow Implementation

```hcl
locals {
  body = {
    properties = merge(
      var.gallery_application != null && length(var.gallery_application) > 0 ? {
        applicationProfile = {
          galleryApplications = [
            for app in var.gallery_application : merge(
              {
                packageReferenceId     = app.version_id
                enableAutomaticUpgrade = app.automatic_upgrade_enabled
              },
              app.configuration_blob_uri != null ? {
                configurationReference = app.configuration_blob_uri
              } : {},
              app.tag != null ? {
                order = app.order
                tags  = app.tag
              } : {
                order = app.order
              },
              {
                treatFailureAsDeploymentFailure = app.treat_failure_as_deployment_failure_enabled # <-
              }
            )
          ]
        }
      } : {}
    )
  }
}
```

## Create Phase Verification

**Query Result**: From `resourceWindowsVirtualMachineCreate` function:

```go
params := virtualmachines.VirtualMachine{
    Properties: &virtualmachines.VirtualMachineProperties{
        ApplicationProfile: &virtualmachines.ApplicationProfile{
            GalleryApplications: expandVirtualMachineGalleryApplication(d.Get("gallery_application").([]interface{})),
        },
        // ... other properties
    },
}

if err := client.CreateOrUpdateThenPoll(ctx, id, params, virtualmachines.DefaultCreateOrUpdateOperationOptions()); err != nil {
    return fmt.Errorf("creating Windows %s: %+v", id, err)
}
```

**Pattern**: Single-phase operation. The `ApplicationProfile` with `GalleryApplications` is set directly on the main `VirtualMachine` struct before the primary `CreateOrUpdateThenPoll` call.

**Classification**: Create phase - field is part of the main resource creation payload.

**Decision**: Implement in `local.body.properties.applicationProfile.galleryApplications` (already done by Task #64 skeleton, this task adds the specific field).

## Assignment Path Verification

**Predicted Path**: `properties.applicationProfile.galleryApplications[].treatFailureAsDeploymentFailure`

**Go Code Evidence**:

From `expandVirtualMachineGalleryApplication`:
```go
func expandVirtualMachineGalleryApplication(input []interface{}) *[]virtualmachines.VMGalleryApplication {
    out := make([]virtualmachines.VMGalleryApplication, 0)
    if len(input) == 0 {
        return &out
    }

    for _, v := range input {
        config := v.(map[string]interface{})
        app := &virtualmachines.VMGalleryApplication{
            PackageReferenceId:              config["version_id"].(string),
            ConfigurationReference:          pointer.To(config["configuration_blob_uri"].(string)),
            Order:                           pointer.To(int64(config["order"].(int))),
            Tags:                            pointer.To(config["tag"].(string)),
            EnableAutomaticUpgrade:          pointer.To(config["automatic_upgrade_enabled"].(bool)),
            TreatFailureAsDeploymentFailure: pointer.To(config["treat_failure_as_deployment_failure_enabled"].(bool)), // <-- Field assignment
        }

        out = append(out, *app)
    }

    return &out
}
```

From Create function:
```go
params := virtualmachines.VirtualMachine{
    Properties: &virtualmachines.VirtualMachineProperties{                          // .Properties = &props
        ApplicationProfile: &virtualmachines.ApplicationProfile{                    // .ApplicationProfile = &profile
            GalleryApplications: expandVirtualMachineGalleryApplication(...),       // .GalleryApplications = slice
        },
    },
}
```

**Verified Path**: 
- Start: `virtualmachines.VirtualMachine`
- `.Properties` → adds `properties` nesting
- `.ApplicationProfile` → adds `applicationProfile` nesting
- `.GalleryApplications` → array of application objects
- `.TreatFailureAsDeploymentFailure` → `treatFailureAsDeploymentFailure` field

**Path Comparison**: ✅ Match - `properties.applicationProfile.galleryApplications[].treatFailureAsDeploymentFailure`

## Provider Schema

**Source**: From `VirtualMachineGalleryApplicationSchema()` function:

```go
"treat_failure_as_deployment_failure_enabled": {
    Type:     pluginsdk.TypeBool,
    Optional: true,
    Default:  false,
},
```

**Properties**:
- **Type**: Boolean
- **Required**: false (Optional)
- **Optional**: true
- **Default**: false
- **ForceNew**: false (can be updated)
- **Sensitive**: false
- **Computed**: false
- **DiffSuppressFunc**: None
- **ValidateFunc**: None

## Azure API Schema

**Resource Type**: `Microsoft.Compute/virtualMachines@2024-03-01`

**Property Path**: `properties.applicationProfile.galleryApplications[].treatFailureAsDeploymentFailure`

**Type**: Boolean (from schema query showing `treatFailureAsDeploymentFailure:Bool`)

## Hidden Fields

None. The expand function only sets the fields explicitly provided in the Terraform schema.

## Mapping

| Terraform (snake_case) | Azure API (camelCase) |
|------------------------|----------------------|
| `treat_failure_as_deployment_failure_enabled` | `treatFailureAsDeploymentFailure` |

## Special Handling

### Default Value

**Provider Schema**: `Default: false`

**Implementation**: Added default in variable definition using `optional(bool, false)` syntax:

```hcl
variable "gallery_application" {
  type = list(object({
    treat_failure_as_deployment_failure_enabled = optional(bool, false)
    # ... other fields
  }))
}
```

This ensures that when a user omits this field, it defaults to `false` automatically, matching the provider behavior.

### ForceNew

**Schema**: No `ForceNew: true` marker

**Decision**: Not a ForceNew field. The field can be updated without requiring resource replacement. No entry needed in `replace_triggers_external_values`.

### Validation

**Schema**: No `ValidateFunc` specified

**Decision**: No validation needed. Boolean type validation is handled by Terraform's type system.

### Sensitive

**Schema**: Not marked as `Sensitive: true`

**Decision**: Normal field, placed in `body` (not `sensitive_body`).

## Deferred Work Completion

Checked `following.md` - no work deferred to this task.

## Edge Case Analysis

### Null Semantics
- **Null value**: When user explicitly sets to `null` or omits the field, defaults to `false` via `optional(bool, false)`
- **Meaning**: Field is optional with a concrete default, so null is never sent to API (always resolves to true/false)

### Boundary Conditions
- **Boolean values**: Only `true` or `false` are valid (enforced by Terraform type system)
- **Default behavior**: When omitted, defaults to `false`, meaning VM application failure does NOT fail the deployment

### Idempotency
- **Direct boolean mapping**: Value is passed through without transformation
- **No order dependency**: Field is independent of other gallery_application fields
- **Idempotent**: Setting the same value repeatedly produces the same result

### Safe References
- **Access pattern**: `app.treat_failure_as_deployment_failure_enabled` is safe because:
  - Field has default value of `false` (never null)
  - Accessed within `for app in var.gallery_application` loop (app object always exists)
  - Type system ensures boolean value

### Empty Collections
- **Parent list empty**: When `var.gallery_application` is null or empty, the entire `applicationProfile` block is omitted (handled by Task #64)
- **Field always present**: Due to default value, this field always has a boolean value for each application in the list

## Checklist

- ✅ Property in correct local (`body`)
- ✅ ForceNew handling (N/A - not a ForceNew field)
- ✅ All logic exactly replicated from provider (direct boolean pass-through, no logic)
- ✅ Validations implemented (N/A - no validations in schema)
- ✅ TODO comment added (N/A - not a sensitive field)
- ✅ Hidden fields checked (none)
- ✅ Deferred work checked (none)
- ✅ Critical review completed (null semantics, boundaries, idempotency, safe refs)
- ✅ Edge Case Analysis included
- ✅ Proof document created
- ✅ Self-Review: Added ONLY what Task #70 requires (one field within existing skeleton)

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-24
**Task:** #70 - gallery_application.treat_failure_as_deployment_failure_enabled

### Validation Results

✅ **ForceNew Logic:** Not a ForceNew field - correctly omitted from `replace_triggers_external_values`
✅ **Stable Keys:** Field always present in each application object with default value
✅ **Phase Detection:** Field correctly placed in `local.body.properties.applicationProfile.galleryApplications[]` (Create phase)
✅ **Type Conversion:** Direct boolean pass-through, no conversion needed
✅ **Null Handling:** Correctly defaults to `false` via `optional(bool, false)` - never null
✅ **Validations:** None required - boolean type validation handled by Terraform type system
✅ **Default Value Implementation:** Uses PREFERRED `optional(bool, false)` method per executor.md lines 146-148
✅ **Deferred Work Completion:** No deferred work for this task (checked following.md)
✅ **Deferred Work Recording:** No deferrals made
✅ **Edge Cases:** Comprehensive analysis provided covering null semantics, boundaries, idempotency, and safe references
✅ **Scope Compliance:** Task added ONLY the single field specified - no hidden fields or content from other tasks

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The field is a simple optional boolean with default value `false`, implemented using the preferred `optional(bool, false)` syntax for nested block defaults. The value is passed through directly to the Azure API property `treatFailureAsDeploymentFailure` without any transformation. No deviations, simplifications, or "safer alternatives" were found.

**Status:** APPROVED ✅

---
