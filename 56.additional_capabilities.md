# Task #56 - additional_capabilities Block Structure Skeleton

## Shadow Implementation

```hcl
locals {
  body = {
    properties = merge(
      # ... other properties ...
      var.additional_capabilities != null ? {  # <-
        additionalCapabilities = {  # <-
          # hibernationEnabled = ... # Task #57  # <-
          # ultraSSDEnabled = ... # Task #58  # <-
        }  # <-
      } : {},  # <-
      # ... other properties ...
    )
  }
}
```

## Summary

Created the conditional structure skeleton for the `additional_capabilities` block. The block is mapped to `properties.additionalCapabilities` in the Azure API and conditionally included when `var.additional_capabilities` is not null. Comment placeholders have been added for the two child fields (hibernationEnabled and ultraSSDEnabled) which will be implemented in Tasks #57 and #58.

## Create Phase Verification

**Pattern:** Single-phase creation (fields processed during primary Create operation)

**Evidence from Create method:**

```go
func resourceWindowsVirtualMachineCreate(d *pluginsdk.ResourceData, meta interface{}) error {
	// ... setup code ...

	additionalCapabilitiesRaw := d.Get("additional_capabilities").([]interface{})
	additionalCapabilities := expandVirtualMachineAdditionalCapabilities(additionalCapabilitiesRaw)

	// ... other code ...

	params := virtualmachines.VirtualMachine{
		Name:             pointer.To(id.VirtualMachineName),
		ExtendedLocation: expandEdgeZone(d.Get("edge_zone").(string)),
		Location:         location.Normalize(d.Get("location").(string)),
		Identity:         identityExpanded,
		Plan:             plan,
		Properties: &virtualmachines.VirtualMachineProperties{
			// ... other properties ...
			
			// Optional
			AdditionalCapabilities: additionalCapabilities,
			DiagnosticsProfile:     bootDiagnostics,
			ExtensionsTimeBudget:   pointer.To(d.Get("extensions_time_budget").(string)),
		},
		Tags: tags.Expand(t),
	}
	// ... more code ...

	if err := client.CreateOrUpdateThenPoll(ctx, id, params, virtualmachines.DefaultCreateOrUpdateOperationOptions()); err != nil {
		return fmt.Errorf("creating Windows %s: %+v", id, err)
	}
}
```

**Classification:** The `additionalCapabilities` field is expanded and assigned to `params.Properties.AdditionalCapabilities` BEFORE the primary `CreateOrUpdateThenPoll` operation. This is a **Create phase** field.

**Decision:** Implement in `local.body.properties.additionalCapabilities` (not in post-creation operations).

## Assignment Path Verification

**Predicted Path:** `properties.additionalCapabilities`

**Go Code Evidence:**

From the Create method:
```go
params := virtualmachines.VirtualMachine{
	Properties: &virtualmachines.VirtualMachineProperties{
		AdditionalCapabilities: additionalCapabilities,
	},
}
```

The struct assignment shows:
1. `params.Properties = &virtualmachines.VirtualMachineProperties{...}` - adds `properties` nesting
2. `AdditionalCapabilities: additionalCapabilities` - assigns the value to the `additionalCapabilities` field

**Verified Path:** `properties.additionalCapabilities`

**Path Comparison:** ✅ Match - predicted path matches actual path in API.

## Provider Schema

**Schema Definition:**

```go
func virtualMachineAdditionalCapabilitiesSchema() *pluginsdk.Schema {
	return &pluginsdk.Schema{
		Type:     pluginsdk.TypeList,
		Optional: true,
		MaxItems: 1,
		Elem: &pluginsdk.Resource{
			Schema: map[string]*pluginsdk.Schema{
				// TODO: confirm this command

				// NOTE: requires registration to use:
				// $ az feature show --namespace Microsoft.Compute --name UltraSSDWithVMSS
				// $ az provider register -n Microsoft.Compute
				"ultra_ssd_enabled": {
					Type:     pluginsdk.TypeBool,
					Optional: true,
					Default:  false,
				},

				"hibernation_enabled": {
					Type:     pluginsdk.TypeBool,
					Optional: true,
					Default:  false,
				},
			},
		},
	}
}
```

**Key Attributes:**
- **Type:** List (MaxItems: 1) - Terraform's pattern for optional single blocks
- **Optional:** true
- **Child Fields:**
  - `ultra_ssd_enabled`: Optional bool with default `false`
  - `hibernation_enabled`: Optional bool with default `false`

## Azure API Schema

**Resource Path:** `properties.additionalCapabilities`

**Schema from Azure API Documentation:**

```json
{
  "additionalCapabilities": {
    "hibernationEnabled": "The flag that enables or disables hibernation capability on the VM.",
    "ultraSSDEnabled": "The flag that enables or disables a capability to have one or more managed data disks with UltraSSD_LRS storage account type on the VM or VMSS. Managed disks with storage account type UltraSSD_LRS can be added to a virtual machine or virtual machine scale set only if this property is enabled."
  }
}
```

**Child Properties:**
- `hibernationEnabled` (bool): Enable/disable hibernation capability
- `ultraSSDEnabled` (bool): Enable/disable UltraSSD_LRS data disks support

## Hidden Fields

**Expand Function Analysis:**

```go
func expandVirtualMachineAdditionalCapabilities(input []interface{}) *virtualmachines.AdditionalCapabilities {
	capabilities := virtualmachines.AdditionalCapabilities{}

	if len(input) > 0 {
		raw := input[0].(map[string]interface{})

		capabilities.UltraSSDEnabled = pointer.To(raw["ultra_ssd_enabled"].(bool))

		capabilities.HibernationEnabled = pointer.To(raw["hibernation_enabled"].(bool))
	}

	return &capabilities
}
```

**Result:** ✅ No hidden fields found. The expand function only processes the two documented fields: `ultra_ssd_enabled` and `hibernation_enabled`. No hardcoded values or additional properties are added.

## Mapping

**Terraform to Azure API:**
- `additional_capabilities` (block) → `properties.additionalCapabilities` (object)
  - `hibernation_enabled` → `hibernationEnabled` (Task #57)
  - `ultra_ssd_enabled` → `ultraSSDEnabled` (Task #58)

**Naming Convention:** snake_case → camelCase (with proper capitalization: `SSD` remains uppercase)

## Special Handling

### Block Structure
- **Type 3 Task:** This is a structure skeleton task. Only the conditional block framework is created.
- **Condition:** The block is conditionally included when `var.additional_capabilities != null`
- **Placeholder Comments:** Each child field has a comment placeholder with its task number for future implementation

### No ForceNew Required
The `additional_capabilities` block itself has no ForceNew behavior at the block level. Individual fields within the block may have their own ForceNew requirements, which will be handled in their respective tasks.

### No Sensitive Fields
Neither field in this block is marked as Sensitive in the provider schema.

### No Validations at Block Level
The block itself has no validations. Individual fields may have their own validations, which will be implemented in their respective tasks.

## Child Tasks Ready for Delegation

The following child tasks are now ready to be implemented:

- **Task #57:** `additional_capabilities.hibernation_enabled` - Implement the hibernation_enabled argument
- **Task #58:** `additional_capabilities.ultra_ssd_enabled` - Implement the ultra_ssd_enabled argument

Both tasks can proceed independently as the parent block skeleton is now in place.

## Edge Case Analysis

### Null Semantics
- **`var.additional_capabilities == null`:** The entire `additionalCapabilities` object is omitted from the API request (not included in merge). This is the correct behavior as the block is optional.
- **Empty object:** If the variable structure exists but fields are null, the expand function will still create the object structure. The child tasks (#57, #58) must handle defaults appropriately.

### Idempotency
- The conditional `var.additional_capabilities != null ? {...} : {}` ensures stable behavior across applies
- The block structure will not appear/disappear unexpectedly as it depends only on variable presence

### Safe References
- The condition `var.additional_capabilities != null` is checked before accessing the block
- Child field implementations (Tasks #57, #58) must safely handle null checks within their own scopes

## Checklist

- ✅ Property in correct local (`local.body.properties`)
- ✅ Conditional structure created with null check
- ✅ Comment placeholders added for child fields with task numbers
- ✅ Hidden fields checked (none found)
- ✅ No ForceNew required at block level
- ✅ No sensitive fields at block level
- ✅ No validations at block level
- ✅ Critical review completed (null semantics, idempotency, safe references)
- ✅ Edge Case Analysis included
- ✅ Child tasks identified (#57, #58)
- ✅ Proof document created
- ✅ track.md ready to be updated to "Pending for check"
- ✅ Self-review: Only block skeleton created, no child field implementations added

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-24
**Task:** #56 - additional_capabilities

### Validation Results

✅ **Block Structure:** Conditional skeleton correctly created with `var.additional_capabilities != null` check
✅ **Placeholder Comments:** Both child fields (hibernationEnabled, ultraSSDEnabled) have comment placeholders with correct task numbers (#57, #58)
✅ **Phase Detection:** Field correctly placed in `local.body.properties` (Create phase)
✅ **Path Mapping:** Correct conversion from `additional_capabilities` to `properties.additionalCapabilities`
✅ **Type Conversion:** Block structure correctly maps Terraform list(object) MaxItems:1 pattern to Azure API object
✅ **Hidden Fields:** Expand function thoroughly analyzed, no hidden fields found
✅ **Deferred Work:** No deferred work to this task in following.md
✅ **Type 3 Compliance:** Implementation exactly follows executor.md Type 3 pattern with empty braces and comment placeholders
✅ **Edge Cases:** Null semantics, idempotency, and safe references properly analyzed

### Compliance Statement

This implementation EXACTLY replicates the Type 3 Block Structure Skeleton pattern as required by `executor.md`. The conditional skeleton is properly structured with comment placeholders for child tasks. The empty object with placeholders is the correct pattern - child tasks #57 and #58 will populate the actual field values with their defaults.

**Status:** APPROVED ✅

---
