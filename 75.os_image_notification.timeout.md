# Task #75 - os_image_notification.timeout - Block Argument

## Summary

Implemented the `timeout` argument within the `os_image_notification` block, which specifies the length of time for OS image notifications. The field maps to `properties.scheduledEventsProfile.osImageNotificationProfile.notBeforeTimeout` in the Azure API. The provider only allows the value "PT15M" and defaults to "PT15M".

## Shadow Implementation

```hcl
# variables.tf
variable "os_image_notification" {
  type = object({
    timeout = optional(string, "PT15M")  # <-
  })
  default     = null
  description = <<-EOT
 - `timeout` - (Optional) Length of time a notification to be sent to the VM on the instance metadata server till the VM gets OS upgraded. The only possible value is `PT15M`. Defaults to `PT15M`.
EOT

  validation {  # <-
    condition = var.os_image_notification == null || (  # <-
      var.os_image_notification.timeout == "PT15M"  # <-
    )  # <-
    error_message = "The timeout must be 'PT15M' (the only allowed value)."  # <-
  }  # <-
}

# migrate_main.tf
locals {
  body = {
    properties = merge(
      # ... other fields ...
      var.os_image_notification != null ? {
        scheduledEventsProfile = {
          osImageNotificationProfile = {
            enable           = true
            notBeforeTimeout = var.os_image_notification.timeout  # <-
          }
        }
      } : {}
    )
  }
}
```

## Create Phase Verification

**Query Method**: `query_terraform_block_implementation_source_code` with `entrypoint_name=create`

**Pattern**: Single-phase operation - the field is processed during the primary Create operation.

**Evidence from Create method**:

```go
if v, ok := d.GetOk("os_image_notification"); ok {
	params.Properties.ScheduledEventsProfile = &virtualmachines.ScheduledEventsProfile{
		OSImageNotificationProfile: expandOsImageNotificationProfile(v.([]interface{})),
	}
}
```

The `os_image_notification` field is read from Terraform state and expanded during the primary resource creation. It's assigned to `params.Properties.ScheduledEventsProfile.OSImageNotificationProfile` before the main `CreateOrUpdateThenPoll` call.

**Classification**: This is a **Create phase** field - processed during the primary `CreateOrUpdateThenPoll` operation.

**Decision**: Implement in `local.body.properties.scheduledEventsProfile.osImageNotificationProfile.notBeforeTimeout`.

## Assignment Path Verification

**Predicted Path**: `properties.scheduledEventsProfile.osImageNotificationProfile.notBeforeTimeout`

**Go Code Evidence**:

From the Create method:
```go
params.Properties.ScheduledEventsProfile = &virtualmachines.ScheduledEventsProfile{
	OSImageNotificationProfile: expandOsImageNotificationProfile(v.([]interface{})),
}
```

From the expand function `expandOsImageNotificationProfile`:
```go
func expandOsImageNotificationProfile(input []interface{}) *virtualmachines.OSImageNotificationProfile {
	if len(input) == 0 {
		return &virtualmachines.OSImageNotificationProfile{
			Enable: pointer.To(false),
		}
	}

	raw := input[0].(map[string]interface{})
	timeout := raw["timeout"].(string)

	return &virtualmachines.OSImageNotificationProfile{
		Enable:           pointer.To(true),
		NotBeforeTimeout: &timeout,
	}
}
```

**Assignment Trace**:
1. `params.Properties.ScheduledEventsProfile` → `properties.scheduledEventsProfile`
2. `.OSImageNotificationProfile` → `.osImageNotificationProfile`
3. `.NotBeforeTimeout` → `.notBeforeTimeout`

**Verified Path**: `properties.scheduledEventsProfile.osImageNotificationProfile.notBeforeTimeout`

**Path Comparison**: ✅ Match - Predicted path matches verified path.

## Provider Schema

**Source**: `virtualMachineOsImageNotificationSchema()` function

```go
func virtualMachineOsImageNotificationSchema() *pluginsdk.Schema {
	return &pluginsdk.Schema{
		Type:     pluginsdk.TypeList,
		Optional: true,
		MaxItems: 1,
		Elem: &pluginsdk.Resource{
			Schema: map[string]*pluginsdk.Schema{
				"timeout": {
					Type:     pluginsdk.TypeString,
					Optional: true,
					ValidateFunc: validation.StringInSlice([]string{
						"PT15M",
					}, false),
					Default: "PT15M",
				},
			},
		},
	}
}
```

**Key Properties**:
- **Type**: `TypeString`
- **Optional**: `true`
- **Default**: `"PT15M"`
- **Validation**: `validation.StringInSlice([]string{"PT15M"}, false)` - Only "PT15M" is allowed
- **ForceNew**: `false` (not set)
- **Sensitive**: `false` (not set)

## Azure API Schema

**Resource Type**: `Microsoft.Compute/virtualMachines@2024-03-01`

**API Path**: `properties.scheduledEventsProfile.osImageNotificationProfile.notBeforeTimeout`

**From Azure API Documentation**:
```
"notBeforeTimeout": "Length of time a Virtual Machine being reimaged or having its OS upgraded will have to potentially approve the OS Image Scheduled Event before the event is auto approved (timed out). The configuration is specified in ISO 8601 format, and the value must be 15 minutes (PT15M)"
```

**API Type**: String (ISO 8601 duration format)

## Hidden Fields

**Check**: Does the expand function set any hidden fields?

**Evidence**:
```go
return &virtualmachines.OSImageNotificationProfile{
	Enable:           pointer.To(true),
	NotBeforeTimeout: &timeout,
}
```

**Finding**: No hidden fields beyond what was already handled in Task #74. The `Enable` field was already implemented in the parent block skeleton (Task #74).

## Mapping

| Terraform (snake_case) | Azure API (camelCase) | Notes |
|------------------------|----------------------|-------|
| `timeout` | `notBeforeTimeout` | ISO 8601 duration string, only "PT15M" allowed |

## Special Handling

### 1. Validation

**Provider Validation**: `validation.StringInSlice([]string{"PT15M"}, false)`

**Implementation**: Added validation block in `variables.tf`:

```hcl
validation {
  condition = var.os_image_notification == null || (
    var.os_image_notification.timeout == "PT15M"
  )
  error_message = "The timeout must be 'PT15M' (the only allowed value)."
}
```

**Rationale**: The provider strictly validates that only "PT15M" is allowed. This validation must be replicated in the variable to provide immediate feedback at plan time.

### 2. Default Value

**Provider Default**: `Default: "PT15M"`

**Implementation**: Used `optional(string, "PT15M")` in the variable type definition:

```hcl
type = object({
  timeout = optional(string, "PT15M")
})
```

**Rationale**: The provider schema specifies a default value of "PT15M". When the user doesn't provide a timeout value, it should default to "PT15M". The `optional()` syntax with the second argument automatically provides this default.

### 3. ForceNew

**Check**: Does this field require `ForceNew`?

**Provider Schema**: `ForceNew` is NOT set (defaults to `false`)

**CustomizeDiff Check**: No `CustomizeDiff` logic found for this field

**Implementation**: No ForceNew handling required. The field can be updated in-place.

### 4. Sensitive

**Check**: Is this field sensitive?

**Provider Schema**: `Sensitive` is NOT set (defaults to `false`)

**Implementation**: No sensitive handling required. The field value is stored in `local.body`, not `local.sensitive_body`.

## Deferred Work Completion

**Check**: Review `following.md` for any work deferred to Task #75.

**Finding**: No deferred work found for Task #75 in `following.md`.

## Critical Review & Edge Case Analysis

### Null Handling

**Question**: What does `var.os_image_notification.timeout == null` mean?

**Analysis**: Since we use `optional(string, "PT15M")`, when the timeout is not specified, it defaults to "PT15M". The field will never be null when `var.os_image_notification` is non-null.

**Implementation**: Direct access `var.os_image_notification.timeout` is safe because:
1. The parent block skeleton (Task #74) already ensures `var.os_image_notification != null` before entering this structure
2. The `optional(string, "PT15M")` ensures the field always has a value when the parent block exists

### Boundary Conditions

**Only Value Allowed**: "PT15M"

**Validation**: The validation block ensures only "PT15M" is accepted, matching the provider's strict validation.

**Default Behavior**: When the user specifies an empty block `os_image_notification {}`, the timeout automatically defaults to "PT15M" via the `optional()` syntax.

### Idempotency

**Check**: Is the implementation idempotent?

**Analysis**: Yes. The field value is always "PT15M" (either explicitly set or defaulted), and it's assigned directly without any transformations or conditional logic that could cause drift.

### Safe References

**Check**: Are all field accesses safe from null pointer errors?

**Analysis**: 
- ✅ `var.os_image_notification.timeout` is safe because:
  1. Parent conditional `var.os_image_notification != null` ensures the object exists
  2. `optional(string, "PT15M")` ensures the field has a value

**Edge Case - Empty String**: The validation block prevents empty strings since it only allows "PT15M".

**Edge Case - Wrong Case**: The validation is case-sensitive (as per `StringInSlice` with `false` for case sensitivity), so "pt15m" would be rejected.

## Implementation Checklist

- ✅ Property in correct local (`local.body`)
- ✅ Field path verified: `properties.scheduledEventsProfile.osImageNotificationProfile.notBeforeTimeout`
- ✅ Default value implemented via `optional(string, "PT15M")`
- ✅ Validation implemented (only "PT15M" allowed)
- ✅ Mapping correct: `timeout` → `notBeforeTimeout`
- ✅ No ForceNew required (field is not ForceNew in provider)
- ✅ No sensitive handling required (field is not sensitive)
- ✅ Hidden fields checked (none beyond Task #74)
- ✅ Deferred work checked (none found)
- ✅ Critical review completed
- ✅ Edge case analysis completed
- ✅ Proof document created
- ✅ Ready for track.md update

## Additional Notes

**Single Valid Value**: This field is unusual in that it only accepts one value ("PT15M"). This is explicitly documented in both the provider schema and Azure API documentation. The validation ensures this constraint is enforced at plan time rather than during API calls.

**ISO 8601 Duration**: "PT15M" is an ISO 8601 duration format representing 15 minutes (Period Time 15 Minutes).

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-24
**Task:** #75 - os_image_notification.timeout

### Validation Results

✅ **ForceNew Logic:** Not required - schema shows `ForceNew: false` (not set), no CustomizeDiff logic found
✅ **Stable Keys:** Not applicable - field does not require ForceNew handling
✅ **Phase Detection:** Field correctly placed in `local.body` - processed during Create phase
✅ **Type Conversion:** Direct string-to-string mapping - no conversion needed
✅ **Null Handling:** Correctly uses `optional(string, "PT15M")` to ensure field always has value when parent block exists
✅ **Validations:** Provider validation `StringInSlice([]string{"PT15M"}, false)` exactly replicated in variables.tf
✅ **Default Value Implementation:** PREFERRED method used - `optional(string, "PT15M")` in object type (executor.md line 148)
✅ **Sensitive Fields:** Not sensitive - correctly placed in `local.body`, not `local.sensitive_body`
✅ **Deferred Work Completion:** No deferred work for this task in following.md
✅ **Deferred Work Recording:** No deferrals made by this task
✅ **Edge Cases:** All edge cases properly analyzed - single value constraint, safe references, idempotency verified

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The field uses the PREFERRED default value method (`optional()` syntax) rather than the fallback coalesce() approach. Validation is implemented in variables.tf as mandated (not deferred to Azure API). No deviations, simplifications, or "safer alternatives" were found.

**Key Verification Points:**
- ✅ Default value: Uses `optional(string, "PT15M")` (PREFERRED method per executor.md)
- ✅ Validation: Enforces only "PT15M" allowed, matching provider's StringInSlice validation
- ✅ Path verification: Correct assignment to `properties.scheduledEventsProfile.osImageNotificationProfile.notBeforeTimeout`
- ✅ Safe references: Parent conditional `var.os_image_notification != null` ensures safe field access
- ✅ Method priority: Correctly used PREFER method over fallback for defaults

**Status:** APPROVED ✅

---
