# Task #45 - os_disk.caching

## Summary
Implemented required `caching` argument for `os_disk` block in `migrate_main.tf` with enum validation in `variables.tf`. The field controls the caching type for the Internal OS Disk with possible values None, ReadOnly, and ReadWrite.

## Shadow Implementation
```hcl
locals {
  body = {
    properties = merge(
      {
        storageProfile = merge(
          {
            osDisk = {
              caching = var.os_disk.caching  # <-
              # ... other fields ...
              createOption = "FromImage"
              osType       = "Windows"
            }
          }
        )
      }
    )
  }
}
```

## Create Phase Verification

### Query Create Method
The resource uses a single-phase create pattern:

```go
func resourceWindowsVirtualMachineCreate(d *pluginsdk.ResourceData, meta interface{}) error {
	// ...
	osDiskRaw := d.Get("os_disk").([]interface{})
	osDisk, err := expandVirtualMachineOSDisk(osDiskRaw, virtualmachines.OperatingSystemTypesWindows)
	if err != nil {
		return fmt.Errorf("expanding `os_disk`: %+v", err)
	}
	// ...
	params.Properties.StorageProfile.OsDisk = osDisk
	// ...
	if err := client.CreateOrUpdateThenPoll(ctx, id, params, virtualmachines.DefaultCreateOrUpdateOperationOptions()); err != nil {
		return fmt.Errorf("creating Windows %s: %+v", id, err)
	}
}
```

**Pattern**: Single-phase (one `CreateOrUpdateThenPoll` operation)

### Field Classification
The `caching` field is retrieved and processed in the `expandVirtualMachineOSDisk` function which is called before the primary `CreateOrUpdateThenPoll` operation.

**Decision**: Field belongs in `local.body` (Create phase)

## Assignment Path Verification

### Predicted Path
`body.properties.storageProfile.osDisk.caching`

### Go Code Evidence

From `expandVirtualMachineOSDisk`:
```go
func expandVirtualMachineOSDisk(input []interface{}, osType virtualmachines.OperatingSystemTypes) (*virtualmachines.OSDisk, error) {
	raw := input[0].(map[string]interface{})
	caching := raw["caching"].(string)

	disk := virtualmachines.OSDisk{
		Caching: pointer.To(virtualmachines.CachingTypes(caching)),
		// ...
	}
	// ...
	return &disk, nil
}
```

From Create method:
```go
func resourceWindowsVirtualMachineCreate(d *pluginsdk.ResourceData, meta interface{}) error {
	// ...
	params := virtualmachines.VirtualMachine{
		// ...
		Properties: &virtualmachines.VirtualMachineProperties{
			StorageProfile: &virtualmachines.StorageProfile{
				OsDisk: expandVirtualMachineOSDisk(d.Get("os_disk").([]interface{}), virtualmachines.OperatingSystemTypesWindows),
				// ...
			},
		},
	}
}
```

**Assignment trace**: 
1. `expandVirtualMachineOSDisk` reads `caching` from `raw["caching"]`
2. Assigned to `OSDisk.Caching` field
3. `OSDisk` assigned to `StorageProfile.OsDisk`
4. `StorageProfile` assigned to `Properties.StorageProfile`
5. `Properties` assigned to `VirtualMachine.Properties`

### Verified Path
`body.properties.storageProfile.osDisk.caching`

### Path Comparison
✅ **MATCH** - Predicted path matches verified path exactly.

## Provider Schema

From `virtualMachineOSDiskSchema()`:

```go
func virtualMachineOSDiskSchema() *pluginsdk.Schema {
	return &pluginsdk.Schema{
		Type:     pluginsdk.TypeList,
		Required: true,
		MaxItems: 1,
		Elem: &pluginsdk.Resource{
			Schema: map[string]*pluginsdk.Schema{
				"caching": {
					Type:     pluginsdk.TypeString,
					Required: true,  // <- Required field
					ValidateFunc: validation.StringInSlice([]string{
						string(virtualmachines.CachingTypesNone),
						string(virtualmachines.CachingTypesReadOnly),
						string(virtualmachines.CachingTypesReadWrite),
					}, false),
				},
				// ...
			},
		},
	}
}
```

**Key attributes**:
- **Type**: String
- **Required**: true
- **ForceNew**: false (not present)
- **DiffSuppressFunc**: none
- **Validation**: StringInSlice with values: None, ReadOnly, ReadWrite

## Azure API Schema

The Azure API `Microsoft.Compute/virtualMachines@2024-03-01` expects the caching field at:
`properties.storageProfile.osDisk.caching`

Type: string (enum)
Possible values: None, ReadOnly, ReadWrite

## Hidden Fields
No hidden fields for this specific argument. Hidden fields (`createOption`, `osType`) were already added in Task #44 at the block level.

## Mapping

| Terraform (snake_case) | Azure API (camelCase) | Notes |
|------------------------|-----------------------|-------|
| os_disk.caching | storageProfile.osDisk.caching | Direct mapping, exact same name |

## Special Handling

### Validation
The provider schema includes enum validation using `StringInSlice`:
```go
ValidateFunc: validation.StringInSlice([]string{
	string(virtualmachines.CachingTypesNone),        // "None"
	string(virtualmachines.CachingTypesReadOnly),    // "ReadOnly"
	string(virtualmachines.CachingTypesReadWrite),   // "ReadWrite"
}, false),
```

**Implementation in variables.tf**:
```hcl
validation {
  condition = contains([
    "None",
    "ReadOnly",
    "ReadWrite"
  ], var.os_disk.caching)
  error_message = "The os_disk.caching must be one of: None, ReadOnly, ReadWrite."
}
```

This validation MUST be implemented because AzAPI provider has no built-in validation logic.

### ForceNew
The field is **NOT** marked as `ForceNew: true` in the schema, meaning changes to this field can be updated in-place without recreating the VM.

**No implementation needed** in `replace_triggers_external_values`.

### DiffSuppressFunc
No DiffSuppressFunc is present for this field.

**No implementation needed**.

### CustomizeDiff
Searched the resource function for CustomizeDiff logic related to `caching`. No CustomizeDiff logic found.

**No implementation needed**.

### Cross-Field Validation
The expand function includes a validation that checks if `diff_disk_settings` is used with `caching`:

```go
if diffDiskSettingsRaw := raw["diff_disk_settings"].([]interface{}); len(diffDiskSettingsRaw) > 0 {
	if caching != string(virtualmachines.CachingTypesReadOnly) {
		// Restriction per https://docs.microsoft.com/azure/virtual-machines/ephemeral-os-disks-deploy#vm-template-deployment
		return nil, fmt.Errorf("`diff_disk_settings` can only be set when `caching` is set to `ReadOnly`")
	}
	// ...
}
```

**Deferral**: This validation involves `diff_disk_settings` which is owned by Task #53. This cross-field validation should be implemented in Task #53 when that field is implemented.

**Recording in following.md**: Will add a row to track this deferral.

## Deferred Work Completion
Checked `following.md` - no work was deferred TO this task (#45).

## Deferred Work Recording
Adding deferred work TO Task #53:

| Deferred By | Deferred To | Type | Description | Status |
|-------------|-------------|------|-------------|--------|
| #45 | #53 | Validation | Cross-field validation: diff_disk_settings can only be set when caching is set to ReadOnly | Pending |

## Edge Case Analysis

### Null Semantics
- Field is **Required** in the provider schema
- Variable type is `string` (not `optional(string)`)
- Since the parent block `os_disk` is required (`nullable = false`), and `caching` is a required field within that block, `var.os_disk.caching` is guaranteed to be non-null
- No null check needed in implementation

### Boundary Conditions
- Field accepts only 3 specific string values: "None", "ReadOnly", "ReadWrite"
- Validation block enforces this constraint at plan time
- Invalid values will be rejected before reaching Azure API

### Idempotency
- Direct string value assignment: `caching = var.os_disk.caching`
- No transformation or conditional logic
- Same input always produces same output
- ✅ Idempotent

### Safe References
- Since `os_disk` is required and `caching` is required within it, `var.os_disk.caching` is always safe to access
- No nested null checks needed

### Special Cases
- **Ephemeral OS Disks**: When using `diff_disk_settings`, caching MUST be "ReadOnly" (validated in Task #53)
- **Write Accelerator**: No special interaction with caching documented in provider code
- **All cache types allowed**: Provider doesn't restrict caching based on storage account type or other fields

## Checklist

- ✅ Property in correct local (`local.body.properties.storageProfile.osDisk.caching`)
- ✅ No ForceNew needed (field not marked ForceNew in schema)
- ✅ Validation IMPLEMENTED in variables.tf (enum validation for None/ReadOnly/ReadWrite)
- ✅ Logic EXACTLY replicated from provider (direct string assignment, no transformation)
- ✅ Hidden fields not applicable (block-level hidden fields already in Task #44)
- ✅ Deferred work recorded in following.md (cross-field validation with diff_disk_settings deferred to Task #53)
- ✅ Deferred work from following.md: None for this task
- ✅ Critical review completed (null handling, edge cases, idempotency, safe references)
- ✅ Edge Case Analysis section added
- ✅ Proof document created
- ✅ Ready to update `track.md` to "Pending for check"
- ✅ Self-Review: Only caching field implemented, no other fields added

## Implementation Summary

**Files Modified**:
1. `migrate_main.tf`: Added `caching = var.os_disk.caching` at line 169
2. `variables.tf`: Added validation block for `os_disk.caching` enum constraint (lines 148-156)

**No files created** in `migrate_*` namespace (not needed for this task).

**Exact provider behavior replicated**: ✅
- Direct string assignment matches provider's `Caching: pointer.To(virtualmachines.CachingTypes(caching))`
- Enum validation matches provider's `StringInSlice` validation
- No ForceNew matches provider schema
- No DiffSuppressFunc matches provider schema

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-24
**Task:** #45 - os_disk.caching

### Validation Results

✅ **ForceNew Logic:** Not applicable - field is NOT marked ForceNew in schema and no CustomizeDiff logic found
✅ **Stable Keys:** Not applicable - field not in replace_triggers_external_values (correctly)
✅ **Phase Detection:** Field correctly placed in local.body (Create phase)
✅ **Type Conversion:** Direct string assignment - no conversion needed
✅ **Null Handling:** Correctly identified that caching is Required field in Required block - no null handling needed
✅ **Validations:** Enum validation correctly implemented in variables.tf matching provider's StringInSlice validation
✅ **Deferred Work Completion:** No deferred work for this task (checked following.md)
✅ **Deferred Work Recording:** Cross-field validation with diff_disk_settings correctly deferred to Task #53 and recorded in following.md
✅ **Edge Cases:** Comprehensive edge case analysis completed - idempotency, null semantics, boundary conditions all verified
✅ **Scope Compliance:** Only caching field implemented - no scope creep to other fields

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The field is directly assigned from the variable, the enum validation matches the provider's StringInSlice validation precisely, and the cross-field validation with diff_disk_settings is appropriately deferred to the owning task. No deviations, simplifications, or "safer alternatives" were found.

**Status:** APPROVED ✅

---
