# Task #36 - tags - Proof Document

## Summary

The `tags` argument is a root-level optional map(string) that maps directly to Azure API's root-level `tags` field. The provider schema uses `commonschema.Tags()` which provides built-in validation (max 50 tags, max key length 512, max value length 256). No ForceNew, no DiffSuppressFunc - tags can be updated in-place. Implementation places tags in `local.azapi_header.tags` as per AzAPI resource structure.

## Shadow Implementation

```hcl
# variables.tf - tags variable already exists (lines 669-673)
variable "tags" {                                                          # <-
  type        = map(string)                                               # <-
  default     = null                                                      # <-
  description = "(Optional) A mapping of tags which should be assigned to this Virtual Machine." # <-
}                                                                          # <-

# Add validation block to existing variable
variable "tags" {
  type        = map(string)
  default     = null
  description = "(Optional) A mapping of tags which should be assigned to this Virtual Machine."
  
  validation {                                                            # <-
    condition     = var.tags == null || length(var.tags) <= 50          # <-
    error_message = "A maximum of 50 tags can be applied to each resource." # <-
  }                                                                        # <-
  
  validation {                                                            # <-
    condition = var.tags == null || alltrue([                           # <-
      for k, v in var.tags : length(k) <= 512                           # <-
    ])                                                                    # <-
    error_message = "The maximum length for a tag key is 512 characters." # <-
  }                                                                        # <-
  
  validation {                                                            # <-
    condition = var.tags == null || alltrue([                           # <-
      for k, v in var.tags : length(v) <= 256                           # <-
    ])                                                                    # <-
    error_message = "The maximum length for a tag value is 256 characters." # <-
  }                                                                        # <-
}

# migrate_main.tf - tags already in azapi_header (line 310)
locals {
  azapi_header = {
    type                 = "Microsoft.Compute/virtualMachines@2024-03-01"
    name                 = var.name
    location             = local.location_normalized
    parent_id            = var.resource_group_id
    tags                 = var.tags                                       # <-
    ignore_null_property = true
    retry                = null
  }
}
```

## Create Phase Verification

**Pattern**: Single-phase creation

**Evidence from Create Method**:
```go
func resourceWindowsVirtualMachineCreate(d *pluginsdk.ResourceData, meta interface{}) error {
	// ... initialization code ...
	
	t := d.Get("tags").(map[string]interface{})
	
	// ... building params ...
	
	params := virtualmachines.VirtualMachine{
		Name:             pointer.To(id.VirtualMachineName),
		ExtendedLocation: expandEdgeZone(d.Get("edge_zone").(string)),
		Location:         location.Normalize(d.Get("location").(string)),
		Identity:         identityExpanded,
		Plan:             plan,
		Properties: &virtualmachines.VirtualMachineProperties{
			// ... other properties ...
		},
		Tags: tags.Expand(t),  // ← Tags assigned at root level before CreateOrUpdateThenPoll
	}
	
	// ... more property assignments ...
	
	if err := client.CreateOrUpdateThenPoll(ctx, id, params, virtualmachines.DefaultCreateOrUpdateOperationOptions()); err != nil {
		return fmt.Errorf("creating Windows %s: %+v", id, err)
	}
	
	// No additional SDK operations after CreateOrUpdateThenPoll
	d.SetId(id.ID())
	return resourceWindowsVirtualMachineRead(d, meta)
}
```

**Classification**: `tags` is read from `d.Get("tags")` and assigned to `params.Tags` before the primary `CreateOrUpdateThenPoll` call. No post-creation operations. This is a **Create phase** field.

**Decision**: Implement in `local.azapi_header.tags` (already present per Task #1).

## Assignment Path Verification

**Predicted Path**: Root-level `tags`

**Go Code Evidence**:
```go
// From Create method - direct assignment at root level
params := virtualmachines.VirtualMachine{
	Name:             pointer.To(id.VirtualMachineName),
	ExtendedLocation: expandEdgeZone(d.Get("edge_zone").(string)),
	Location:         location.Normalize(d.Get("location").(string)),
	Identity:         identityExpanded,
	Plan:             plan,
	Properties: &virtualmachines.VirtualMachineProperties{
		// properties go here
	},
	Tags: tags.Expand(t),  // ← Root-level assignment
}
```

**Verified Path**: Root-level `tags` (not inside `properties`)

**Path Comparison**: ✅ Predicted path matches verified path.

## Provider Schema

**Source**: `resourceWindowsVirtualMachine()` schema definition

```go
"tags": commonschema.Tags(),
```

**commonschema.Tags() Expansion**:
```go
func Tags() *schema.Schema {
	return &schema.Schema{
		Type:         schema.TypeMap,
		Optional:     true,
		ValidateFunc: tags.Validate,
		Elem: &schema.Schema{
			Type: schema.TypeString,
		},
	}
}
```

**tags.Validate() Implementation**:
```go
func Validate(v interface{}, _ string) (warnings []string, errors []error) {
	tagsMap := v.(map[string]interface{})

	if len(tagsMap) > 50 {
		errors = append(errors, fmt.Errorf("a maximum of 50 tags can be applied to each resource"))
	}

	for k, v := range tagsMap {
		if len(k) > 512 {
			errors = append(errors, fmt.Errorf("the maximum length for a tag key is 512 characters: %q is %d characters", k, len(k)))
		}

		value, err := tagValueToString(v)
		if err != nil {
			errors = append(errors, err)
		} else if len(value) > 256 {
			errors = append(errors, fmt.Errorf("the maximum length for a tag value is 256 characters: the value for %q is %d characters", k, len(value)))
		}
	}

	return warnings, errors
}
```

**Key Attributes**:
- Type: `map[string]string`
- Required: No
- Optional: Yes
- ForceNew: No (not specified, defaults to false)
- Sensitive: No
- DiffSuppressFunc: None
- ValidateFunc: `tags.Validate` (max 50 tags, key max 512 chars, value max 256 chars)

## Azure API Schema

**Resource Type**: `Microsoft.Compute/virtualMachines@2024-03-01`

**Property Path**: `tags` (root-level, not inside `body`)

**Query Results**:
```
Schema: Map(String)
Description: "A mapping of tags which should be assigned to the Azure resource."
```

**API Behavior**: Tags are a root-level property in Azure REST API for all resources. They can be updated in-place without resource recreation.

## Hidden Fields

None. Tags are explicitly defined in the Terraform schema and fully exposed to users.

## Locks Detection

No locks related to tags. Lock logic is handled at the resource level (VM name) in Task #2.

## Mapping

| Terraform (snake_case) | Azure API (camelCase) | Notes |
|------------------------|----------------------|-------|
| `tags` | `tags` | Direct mapping, no case conversion needed |

## Special Handling

### ForceNew Analysis

**Schema Check**: `ForceNew: true` not present in schema definition.

**CustomizeDiff Check**: No CustomizeDiff logic for tags.

**Update Method Evidence**:
```go
func resourceWindowsVirtualMachineUpdate(d *pluginsdk.ResourceData, meta interface{}) error {
	// ... initialization ...
	
	if d.HasChange("tags") {
		shouldUpdate = true

		tagsRaw := d.Get("tags").(map[string]interface{})
		update.Tags = tags.Expand(tagsRaw)
	}
	
	// ... deallocate/shutdown logic ...
	
	if shouldUpdate {
		log.Printf("[DEBUG] Updating Windows %s", id)
		if err := client.UpdateThenPoll(ctx, *id, update, virtualmachines.DefaultUpdateOperationOptions()); err != nil {
			return fmt.Errorf("updating Windows %s: %+v", id, err)
		}
		log.Printf("[DEBUG] Updated Windows %s.", id)
	}
	
	return resourceWindowsVirtualMachineRead(d, meta)
}
```

**Conclusion**: Tags can be updated in-place without requiring VM shutdown, deallocation, or recreation. No ForceNew logic needed.

### Validation

The provider implements three validations via `tags.Validate()`:

1. **Maximum 50 tags per resource**:
   ```hcl
   validation {
     condition     = var.tags == null || length(var.tags) <= 50
     error_message = "A maximum of 50 tags can be applied to each resource."
   }
   ```

2. **Maximum key length 512 characters**:
   ```hcl
   validation {
     condition = var.tags == null || alltrue([
       for k, v in var.tags : length(k) <= 512
     ])
     error_message = "The maximum length for a tag key is 512 characters."
   }
   ```

3. **Maximum value length 256 characters**:
   ```hcl
   validation {
     condition = var.tags == null || alltrue([
       for k, v in var.tags : length(v) <= 256
     ])
     error_message = "The maximum length for a tag value is 256 characters."
   }
   ```

All three validations MUST be implemented in `variables.tf` to replicate exact provider behavior.

### Sensitive

Tags are not marked as sensitive in the provider schema. Values are visible in Terraform state and outputs.

### AzAPI Placement

Per executor.md instructions and AzAPI provider design:
- ✅ `tags` goes in `local.azapi_header.tags` (root-level azapi_resource parameter)
- ❌ NOT in `local.body` or `local.sensitive_body`

This was already implemented correctly in Task #1 when `azapi_header` was created.

## Deferred Work Completion

Checked `following.md` - no work deferred to Task #36.

## Critical Review & Edge Case Analysis

### Null Semantics
- `null` means: "Don't set tags on the resource" (or inherit/keep existing tags on update)
- Empty map `{}` means: "Explicitly set no tags" (removes all tags)
- These are distinct behaviors in Azure API

### Edge Cases

1. **Empty Map vs Null**:
   - `tags = {}` → Azure API receives empty map, all tags removed
   - `tags = null` → With `ignore_null_property = true`, field not sent to API
   - Implementation: Direct passthrough `tags = var.tags` correctly handles both

2. **Key/Value Case Sensitivity**:
   - Azure preserves exact case for tag keys and values
   - No case normalization needed
   - Implementation: Direct passthrough preserves case

3. **Special Characters**:
   - Azure allows most special characters in tags
   - Provider only validates length, not content
   - Implementation: No sanitization needed, direct passthrough

4. **Unicode Characters**:
   - Azure API accepts Unicode in tag keys/values
   - Terraform string type supports Unicode
   - Implementation: No special handling needed

5. **Null Values in Map**:
   - Terraform `map(string)` type doesn't allow null values
   - All values must be strings (including empty string `""`)
   - Validation correctly checks `length(v) <= 256` for all values

### Idempotency

✅ **Idempotent**: Applying same tags multiple times produces same result. Map semantics ensure order doesn't matter (unlike lists).

### Safe References

✅ **Safe**: Direct reference `var.tags` is safe. No nested access needed for map type.

## Implementation Status

- ✅ Variable exists in `variables.tf` (lines 669-673)
- ✅ Already added to `local.azapi_header.tags` in Task #1 (line 310 of migrate_main.tf)
- ⚠️ **Action Required**: Add three validation blocks to existing `tags` variable in `variables.tf`

## Checklist

- ✅ Property in correct local (`azapi_header.tags` - already present)
- ✅ No ForceNew needed (can be updated in-place)
- ✅ Validations identified (3 validations from `tags.Validate()`)
- ⚠️ **TO DO**: Implement 3 validations in `variables.tf`
- ✅ No hidden fields
- ✅ No deferred work from other tasks
- ✅ Critical review complete (null semantics, edge cases)
- ✅ Edge Case Analysis documented
- ✅ Proof document created
- ⚠️ **TO DO**: Update `track.md` status to "Pending for check" after adding validations

## Validation Implementation Plan

Modify the existing `tags` variable in `variables.tf` (starting at line 669) to add the three validation blocks:

```hcl
variable "tags" {
  type        = map(string)
  default     = null
  description = "(Optional) A mapping of tags which should be assigned to this Virtual Machine."
  
  validation {
    condition     = var.tags == null || length(var.tags) <= 50
    error_message = "A maximum of 50 tags can be applied to each resource."
  }
  
  validation {
    condition = var.tags == null || alltrue([
      for k, v in var.tags : length(k) <= 512
    ])
    error_message = "The maximum length for a tag key is 512 characters."
  }
  
  validation {
    condition = var.tags == null || alltrue([
      for k, v in var.tags : length(v) <= 256
    ])
    error_message = "The maximum length for a tag value is 256 characters."
  }
}
```

This completes the exact replication of provider behavior for the `tags` argument.

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-24
**Task:** #36 - tags

### Validation Results

✅ **ForceNew Logic:** No ForceNew required - tags can be updated in-place as confirmed by provider Update method
✅ **Stable Keys:** Not applicable - no replace_triggers_external_values needed for tags
✅ **Phase Detection:** Create phase - correctly placed in `local.azapi_header.tags` (line 310 of migrate_main.tf)
✅ **Type Conversion:** Correct direct mapping from Terraform `map(string)` to Azure API `Map(String)`
✅ **Null Handling:** Correctly propagates null semantics with `ignore_null_property = true` in azapi_header
✅ **Validations:** All three provider validations from `tags.Validate()` correctly implemented in variables.tf (lines 674-691):
  - Max 50 tags per resource
  - Max key length 512 characters
  - Max value length 256 characters
✅ **AzAPI Placement:** Correctly placed in `local.azapi_header.tags` (root-level azapi_resource parameter), not in body or sensitive_body
✅ **Deferred Work Completion:** No deferred work for this task in following.md
✅ **Deferred Work Recording:** No deferrals made by this task
✅ **Edge Cases:** Comprehensive analysis covering null vs empty map, case sensitivity, special characters, Unicode, idempotency

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The `tags` argument is correctly placed in the root-level `azapi_header` structure (as Task #1 established), all three validations from `commonschema.Tags()` are implemented with correct error messages matching the provider, and the update-in-place behavior is correctly preserved by not adding tags to `replace_triggers_external_values`.

**Status:** APPROVED ✅

---
