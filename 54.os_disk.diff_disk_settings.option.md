# Task #54 - os_disk.diff_disk_settings.option

## Summary

Implemented required argument `os_disk.diff_disk_settings.option` within the existing `diff_disk_settings` block skeleton. Field is Required, ForceNew, with validation allowing only "Local" value. Direct mapping from Terraform variable to Azure API property `properties.storageProfile.osDisk.diffDiskSettings.option`.

## Shadow Implementation

```hcl
# migrate_main.tf
locals {
  replace_triggers_external_values = {
    # ... other fields ...
    os_disk_diff_disk_settings_option = { value = var.os_disk.diff_disk_settings != null ? var.os_disk.diff_disk_settings.option : null }  # <-
  }

  body = merge(
    {
      properties = merge(
        {
          storageProfile = merge(
            {
              osDisk = merge(
                # ... other os_disk fields ...
                var.os_disk.diff_disk_settings != null ? {  # <-
                  diffDiskSettings = {  # <-
                    option = var.os_disk.diff_disk_settings.option  # <-
                    # placement = ... # Task #55
                  }  # <-
                } : {},  # <-
              )
            }
          )
        }
      )
    }
  )
}
```

```hcl
# variables.tf (validation added)
variable "os_disk" {
  type = object({
    # ... other fields ...
    diff_disk_settings = optional(object({
      option    = string  # <-
      placement = optional(string)
    }))
  })
  
  validation {  # <-
    condition     = var.os_disk.diff_disk_settings == null || contains(["Local"], var.os_disk.diff_disk_settings.option)  # <-
    error_message = "os_disk.diff_disk_settings.option must be 'Local'."  # <-
  }  # <-
}
```

## Create Phase Verification

### Query Create Method

```go
// From expandVirtualMachineOSDisk function
func expandVirtualMachineOSDisk(input []interface{}, osType virtualmachines.OperatingSystemTypes) (*virtualmachines.OSDisk, error) {
	raw := input[0].(map[string]interface{})
	caching := raw["caching"].(string)

	disk := virtualmachines.OSDisk{
		Caching: pointer.To(virtualmachines.CachingTypes(caching)),
		ManagedDisk: &virtualmachines.ManagedDiskParameters{
			StorageAccountType: pointer.To(virtualmachines.StorageAccountTypes(raw["storage_account_type"].(string))),
		},
		WriteAcceleratorEnabled: pointer.To(raw["write_accelerator_enabled"].(bool)),
		CreateOption: virtualmachines.DiskCreateOptionTypesFromImage,
		OsType:       pointer.To(osType),
	}

	// ... other fields ...

	if diffDiskSettingsRaw := raw["diff_disk_settings"].([]interface{}); len(diffDiskSettingsRaw) > 0 {
		if caching != string(virtualmachines.CachingTypesReadOnly) {
			return nil, fmt.Errorf("`diff_disk_settings` can only be set when `caching` is set to `ReadOnly`")
		}

		diffDiskRaw := diffDiskSettingsRaw[0].(map[string]interface{})
		disk.DiffDiskSettings = &virtualmachines.DiffDiskSettings{
			Option:    pointer.To(virtualmachines.DiffDiskOptions(diffDiskRaw["option"].(string))),  // ← Field assigned here
			Placement: pointer.To(virtualmachines.DiffDiskPlacement(diffDiskRaw["placement"].(string))),
		}
	}

	// ... other fields ...

	return &disk, nil
}
```

### Pattern Classification

**Pattern**: Single-phase create operation.

The `option` field is processed during the primary `CreateOrUpdateThenPoll` operation. It is expanded within `expandVirtualMachineOSDisk` which is called during the request building for the primary create operation.

**Decision**: Implement in `local.body` (not in post-creation operations).

## Assignment Path Verification

### Predicted Path

From Terraform variable to Azure API:
- Terraform: `var.os_disk.diff_disk_settings.option`
- Local: `local.body.properties.storageProfile.osDisk.diffDiskSettings.option`
- Azure API: `properties.storageProfile.osDisk.diffDiskSettings.option`

### Go Code Evidence

```go
// Step 1: Extract from raw Terraform input
diffDiskRaw := diffDiskSettingsRaw[0].(map[string]interface{})
disk.DiffDiskSettings = &virtualmachines.DiffDiskSettings{
	Option:    pointer.To(virtualmachines.DiffDiskOptions(diffDiskRaw["option"].(string))),
	// ...
}
```

```go
// Step 2: Assign to disk.DiffDiskSettings.Option
// The DiffDiskSettings is a field of disk (virtualmachines.OSDisk)
disk.DiffDiskSettings = &virtualmachines.DiffDiskSettings{
	Option: pointer.To(virtualmachines.DiffDiskOptions(diffDiskRaw["option"].(string))),
}
```

```go
// Step 3: disk is returned and assigned to params.Properties.StorageProfile.OsDisk
// From resourceWindowsVirtualMachineCreate:
osDisk, err := expandVirtualMachineOSDisk(d.Get("os_disk").([]interface{}), virtualmachines.OperatingSystemTypesWindows)
if err != nil {
	return fmt.Errorf("expanding `os_disk`: %+v", err)
}

storageProfile := virtualmachines.StorageProfile{
	OsDisk: osDisk,
	// ...
}

params := virtualmachines.VirtualMachine{
	Properties: &virtualmachines.VirtualMachineProperties{
		StorageProfile: &storageProfile,
		// ...
	},
}
```

### Verified Path

The complete assignment path is:
1. `diffDiskRaw["option"]` (from Terraform input)
2. → `disk.DiffDiskSettings.Option` (OSDisk struct)
3. → `storageProfile.OsDisk.DiffDiskSettings.Option` (StorageProfile struct)
4. → `params.Properties.StorageProfile.OsDisk.DiffDiskSettings.Option` (VirtualMachine struct)
5. → Azure API: `properties.storageProfile.osDisk.diffDiskSettings.option`

### Path Comparison

✅ **MATCH**: Predicted path matches the verified assignment path exactly.

## Provider Schema

```go
"diff_disk_settings": {
	Type:     pluginsdk.TypeList,
	Optional: true,
	ForceNew: true,
	MaxItems: 1,
	Elem: &pluginsdk.Resource{
		Schema: map[string]*pluginsdk.Schema{
			"option": {
				Type:     pluginsdk.TypeString,
				Required: true,
				ForceNew: true,
				ValidateFunc: validation.StringInSlice([]string{
					string(virtualmachines.DiffDiskOptionsLocal),
				}, false),
			},
			"placement": {
				Type:     pluginsdk.TypeString,
				Optional: true,
				ForceNew: true,
				Default:  string(virtualmachines.DiffDiskPlacementCacheDisk),
				ValidateFunc: validation.StringInSlice([]string{
					string(virtualmachines.DiffDiskPlacementCacheDisk),
					string(virtualmachines.DiffDiskPlacementResourceDisk),
					string(virtualmachines.DiffDiskPlacementNVMeDisk),
				}, false),
			},
		},
	},
	ConflictsWith: []string{
		"os_managed_disk_id",
	},
},
```

**Key Attributes**:
- **Required**: true (within the `diff_disk_settings` block)
- **ForceNew**: true (changing requires replacement)
- **Type**: String
- **ValidateFunc**: `StringInSlice(["Local"], false)` - only "Local" is accepted

## Azure API Schema

From Azure API schema query for `Microsoft.Compute/virtualMachines@2024-03-01`:

```
"diffDiskSettings":ObjectWithOptionalAttrs(map[string]Type{
  "option":String, 
  "placement":String
}, []string{"option", "placement"})
```

**Property Path**: `body.properties.storageProfile.osDisk.diffDiskSettings.option`

**Type**: String (optional in Azure API, but required when parent block is set)

## Hidden Fields

No hidden fields identified for this argument. The `option` field is directly exposed in the provider schema and maps directly to the Azure API property.

## Mapping

| Terraform (snake_case) | Azure API (camelCase) | Task |
|------------------------|----------------------|------|
| os_disk.diff_disk_settings.option | properties.storageProfile.osDisk.diffDiskSettings.option | #54 |

## Special Handling

### ForceNew Behavior

**Provider Schema**: `ForceNew: true`

**Implementation**: Added to `replace_triggers_external_values` with full value tracking:

```hcl
os_disk_diff_disk_settings_option = { value = var.os_disk.diff_disk_settings != null ? var.os_disk.diff_disk_settings.option : null }
```

**Rationale**: 
- Wrapped in `{ value = ... }` to maintain stable key presence
- Tracks the full value (not just presence) to detect any changes
- Uses null when parent block is not set to avoid false triggers

### Validation

**Provider Validation**: 
```go
ValidateFunc: validation.StringInSlice([]string{
	string(virtualmachines.DiffDiskOptionsLocal),
}, false)
```

The only accepted value is "Local" (case-sensitive).

**Implementation**: Added validation block to `os_disk` variable in `variables.tf`:

```hcl
validation {
  condition     = var.os_disk.diff_disk_settings == null || contains(["Local"], var.os_disk.diff_disk_settings.option)
  error_message = "os_disk.diff_disk_settings.option must be 'Local'."
}
```

**Why this validation is correct**:
1. Checks null parent block first (`var.os_disk.diff_disk_settings == null`) to avoid evaluation errors
2. Uses `contains(["Local"], ...)` to validate allowed value (exact match)
3. Error message is clear and user-friendly

### Required Field Logic

The `option` field is Required in the provider schema (within the `diff_disk_settings` block). However, since `diff_disk_settings` itself is Optional, the field is only required when the parent block is set.

**Implementation**: The field is non-optional in the Terraform object type definition:
```hcl
diff_disk_settings = optional(object({
  option    = string      # Required (not wrapped in optional())
  placement = optional(string)
}))
```

This ensures that when a user sets `diff_disk_settings`, they MUST provide `option`.

## Deferred Work Completion

Checked `following.md` for any work deferred TO this task:

**Result**: No deferred work found for Task #54.

## Edge Case Analysis

### Null Semantics

1. **When `diff_disk_settings` is null**: 
   - The entire `diffDiskSettings` object is omitted from the API request
   - ForceNew trigger is null (no replacement triggered)
   - ✅ Correct behavior

2. **When `diff_disk_settings` is set but later removed**:
   - Value changes from `"Local"` to `null`
   - ForceNew trigger detects this change
   - VM is replaced
   - ✅ Correct behavior (matches provider ForceNew)

3. **When `option` changes value** (e.g., "Local" → "Local"):
   - No change detected (same value)
   - No replacement triggered
   - ✅ Correct behavior (idempotent)

### Boundary Conditions

1. **Invalid value** (e.g., "Remote"):
   - Validation catches this at plan time
   - Error: "os_disk.diff_disk_settings.option must be 'Local'."
   - ✅ Fail-fast validation

2. **Case sensitivity**:
   - Provider uses case-sensitive validation: `string(virtualmachines.DiffDiskOptionsLocal)` = "Local"
   - Our validation uses exact match: `contains(["Local"], ...)`
   - ✅ Matches provider behavior

3. **Empty string**:
   - Would fail validation (not in allowed list)
   - Error message guides user to correct value
   - ✅ Correct behavior

### Idempotency

- **Stable key**: `os_disk_diff_disk_settings_option` key always present in `replace_triggers_external_values`
- **Value tracking**: Tracks actual value, not just presence
- **Null handling**: Uses `null` when parent block not set, avoiding false positives
- ✅ Multiple applies with same configuration produce no changes

### Safe References

```hcl
# Safe null check before accessing nested field
os_disk_diff_disk_settings_option = { value = var.os_disk.diff_disk_settings != null ? var.os_disk.diff_disk_settings.option : null }

# Safe null check in body assignment
var.os_disk.diff_disk_settings != null ? {
  diffDiskSettings = {
    option = var.os_disk.diff_disk_settings.option  # Safe: parent null check protects this
  }
} : {}
```

✅ All references protected by parent null checks.

## Checklist

- ✅ Property in correct local (`local.body.properties.storageProfile.osDisk.diffDiskSettings.option`)
- ✅ ForceNew wrapped: `os_disk_diff_disk_settings_option = { value = ... }` with full value tracking
- ✅ ALL logic EXACTLY replicated from provider (direct string assignment, enum validation)
- ✅ Validations IMPLEMENTED in variables.tf (enum validation for "Local")
- ✅ Hidden fields checked (none found for this field)
- ✅ Deferred work in following.md: No work deferred by this task
- ✅ Deferred work from following.md: No work deferred TO this task
- ✅ Critical review (null handling, edge cases, idempotency, safe references)
- ✅ Edge Case Analysis completed above
- ✅ Proof document created
- ✅ Self-Review: Only implemented `option` field (Task #54), did not add `placement` (Task #55) or other fields

## Final Verification

### Implementation Exactly Matches Provider

**Provider logic**:
```go
diffDiskRaw := diffDiskSettingsRaw[0].(map[string]interface{})
disk.DiffDiskSettings = &virtualmachines.DiffDiskSettings{
	Option: pointer.To(virtualmachines.DiffDiskOptions(diffDiskRaw["option"].(string))),
}
```

**Our implementation**:
```hcl
var.os_disk.diff_disk_settings != null ? {
  diffDiskSettings = {
    option = var.os_disk.diff_disk_settings.option
  }
} : {}
```

✅ **EXACT MATCH**: Direct string assignment, no transformations, no "safer" alternatives.

### Validation Exactly Matches Provider

**Provider validation**:
```go
ValidateFunc: validation.StringInSlice([]string{
	string(virtualmachines.DiffDiskOptionsLocal),
}, false)
```

**Our validation**:
```hcl
validation {
  condition     = var.os_disk.diff_disk_settings == null || contains(["Local"], var.os_disk.diff_disk_settings.option)
  error_message = "os_disk.diff_disk_settings.option must be 'Local'."
}
```

✅ **EXACT MATCH**: Same allowed value ("Local"), case-sensitive, clear error message.

### ForceNew Exactly Matches Provider

**Provider schema**: `ForceNew: true`

**Our implementation**: 
- Added to `replace_triggers_external_values` with stable key
- Tracks full value to detect any changes
- Null when parent block not set

✅ **EXACT MATCH**: Changes to field value trigger replacement, as required by provider.

---

**Task Status**: Ready for checker verification. Update `track.md` status to `Pending for check`.

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-24
**Task:** #54 - os_disk.diff_disk_settings.option

### Validation Results

✅ **ForceNew Logic**: Correctly wrapped in `{ value = ... }` with stable key. Full value tracking (not just presence).
✅ **Stable Keys**: Key `os_disk_diff_disk_settings_option` always present in `replace_triggers_external_values`
✅ **Phase Detection**: Field correctly placed in `local.body` (Create phase)
✅ **Type Conversion**: Direct string assignment from Terraform to Azure API (no conversion needed)
✅ **Null Handling**: Correctly propagates null semantics with parent block null checks
✅ **Validations**: Provider validation (`StringInSlice(["Local"])`) exactly replicated in `variables.tf` with correct null-safe condition
✅ **Deferred Work Completion**: No deferred work for this task (verified in following.md)
✅ **Deferred Work Recording**: No deferrals made by this task
✅ **Edge Cases**: All edge cases properly analyzed (null semantics, boundary conditions, idempotency, safe references)
✅ **Scope Compliance**: Only implemented `option` field as required; did not add `placement` field (belongs to Task #55)

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. No deviations, simplifications, or "safer alternatives" were found.

**Specific Verifications:**
- **Schema ForceNew: true** → Correctly added to `replace_triggers_external_values` with stable key wrapper
- **Provider Validation**: `validation.StringInSlice(["Local"], false)` → Exactly replicated as `contains(["Local"], var.os_disk.diff_disk_settings.option)` with null-safe parent check
- **Required Field**: Correctly marked as non-optional (`string` not `optional(string)`) within the optional parent block
- **Assignment Path**: Correctly traced from `diffDiskRaw["option"]` → `disk.DiffDiskSettings.Option` → `properties.storageProfile.osDisk.diffDiskSettings.option`
- **Cross-Field Validation**: Validation for `caching == "ReadOnly"` requirement was already implemented by Task #45 and completed by Task #53 (verified in following.md line 21)

**Status:** APPROVED ✅

---
