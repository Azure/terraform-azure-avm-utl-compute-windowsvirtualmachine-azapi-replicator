# Task #13 - computer_name - Proof Document

## Summary

The `computer_name` argument is Optional + Computed with ForceNew behavior. It defaults to the VM name if not provided. Implementation includes validations for computer name format and adds the field to `properties.osProfile.computerName` in the request body.

## Shadow Implementation

```hcl
# variables.tf
variable "computer_name" {
  type        = string
  default     = null
  description = "(Optional) Specifies the Hostname which should be used for this Virtual Machine. If unspecified this defaults to the value for the `name` field. If the value of the `name` field is not a valid `computer_name`, then you must specify `computer_name`. Changing this forces a new resource to be created."

  validation {
    condition     = var.computer_name == null || var.computer_name != ""                    # <-
    error_message = "The computer_name must not be empty."                                  # <-
  }                                                                                          # <-

  validation {                                                                               # <-
    condition     = var.computer_name == null || length(var.computer_name) <= 15            # <-
    error_message = "The computer_name can be at most 15 characters."                       # <-
  }                                                                                          # <-

  validation {                                                                               # <-
    condition     = var.computer_name == null || !can(regex("-$", var.computer_name))       # <-
    error_message = "The computer_name cannot end with dash."                               # <-
  }                                                                                          # <-

  validation {                                                                               # <-
    condition     = var.computer_name == null || can(regex("^[a-zA-Z0-9-]+$", var.computer_name)) # <-
    error_message = "The computer_name may only contain alphanumeric characters and dashes." # <-
  }                                                                                          # <-

  validation {                                                                               # <-
    condition     = var.computer_name == null || !can(regex("^\\d+$", var.computer_name))   # <-
    error_message = "The computer_name cannot contain only numbers."                        # <-
  }                                                                                          # <-

  validation {                                                                               # <-
    condition = var.computer_name != null || (                                               # <-
      var.name != "" &&                                                                      # <-
      length(var.name) <= 15 &&                                                              # <-
      !can(regex("-$", var.name)) &&                                                         # <-
      can(regex("^[a-zA-Z0-9-]+$", var.name)) &&                                             # <-
      !can(regex("^\\d+$", var.name))                                                        # <-
    )                                                                                        # <-
    error_message = "When computer_name is not specified, the VM name must be a valid computer name (max 15 characters, alphanumeric and dashes only, cannot end with dash, cannot contain only numbers). Please provide an explicit computer_name." # <-
  }                                                                                          # <-
}

# migrate_main.tf
locals {
  replace_triggers_external_values = {
    # ... other fields ...
    computer_name = { value = var.computer_name != null ? var.computer_name : var.name }    # <-
  }

  body = {
    properties = merge(
      # ... other properties ...
      var.admin_username != null ? {
        osProfile = merge(
          {
            adminUsername = var.admin_username
          },
          {
            computerName = var.computer_name != null ? var.computer_name : var.name         # <-
          },
          # ... other osProfile fields ...
        )
      } : {},
      # ... other properties ...
    )
  }
}
```

## Create Phase Verification

**Query:** `query_terraform_block_implementation_source_code` with `entrypoint_name=create`

**Pattern:** Single-phase - the resource uses only one `CreateOrUpdateThenPoll` operation.

**Field Classification:** Create phase - `computer_name` is set during the primary resource creation.

**Go Code Evidence:**

```go
func resourceWindowsVirtualMachineCreate(d *pluginsdk.ResourceData, meta interface{}) error {
	// ... initialization ...

	managedDiskIdRaw := d.Get("os_managed_disk_id").(string)
	osDiskIsImported := managedDiskIdRaw != ""

	params := virtualmachines.VirtualMachine{
		// ... other fields ...
	}

	if !osDiskIsImported {
		var computerName string
		if v, ok := d.GetOk("computer_name"); ok && len(v.(string)) > 0 {
			computerName = v.(string)
		} else {
			_, errs := computeValidate.WindowsComputerNameFull(d.Get("name"), "computer_name")
			if len(errs) > 0 {
				return fmt.Errorf("unable to assume default computer name %s. Please adjust the `name`, or specify an explicit `computer_name`", errs[0])
			}
			computerName = id.VirtualMachineName
		}

		params.Properties.OsProfile = &virtualmachines.OSProfile{
			AdminPassword:            pointer.To(d.Get("admin_password").(string)),
			AdminUsername:            pointer.To(d.Get("admin_username").(string)),
			ComputerName:             pointer.To(computerName),  // <- Set here during create
			AllowExtensionOperations: pointer.To(allowExtensionOperations),
			WindowsConfiguration: &virtualmachines.WindowsConfiguration{
				// ...
			},
			Secrets: secrets,
		}
		// ... rest of OsProfile configuration ...
	}

	if err := client.CreateOrUpdateThenPoll(ctx, id, params, virtualmachines.DefaultCreateOrUpdateOperationOptions()); err != nil {
		return fmt.Errorf("creating Windows %s: %+v", id, err)
	}

	d.SetId(id.ID())
	return resourceWindowsVirtualMachineRead(d, meta)
}
```

**Decision:** Field is set during the primary Create operation. It belongs in `local.body`.

## Assignment Path Verification

**Predicted Path:** `properties.osProfile.computerName`

**Go Code Evidence:**

```go
// In Create method:
params := virtualmachines.VirtualMachine{
	Properties: &virtualmachines.VirtualMachineProperties{
		OsProfile: &virtualmachines.OSProfile{
			ComputerName: pointer.To(computerName),  // <- Direct assignment
		},
	},
}
```

**Trace:**
1. `params.Properties.OsProfile.ComputerName` - Direct assignment to struct field

**Verified Path:** `properties.osProfile.computerName`

**Path Comparison:** ✅ Match - predicted path matches actual implementation.

## Provider Schema

**Source:** `query_terraform_block_implementation_source_code` with `entrypoint_name=schema`

```go
"computer_name": {
	Type:     pluginsdk.TypeString,
	Optional: true,

	// Computed since we reuse the VM name if one's not specified
	Computed: true,
	ForceNew: true,

	ValidateFunc: computeValidate.WindowsComputerNameFull,
	ConflictsWith: []string{
		"os_managed_disk_id",
	},
},
```

**Key Attributes:**
- **Type:** String
- **Optional:** true
- **Computed:** true (defaults to VM name)
- **ForceNew:** true
- **ValidateFunc:** `computeValidate.WindowsComputerNameFull`
- **ConflictsWith:** `os_managed_disk_id`

## Azure API Schema

**Resource Type:** `Microsoft.Compute/virtualMachines@2024-03-01`

**Property Path:** `body.properties.osProfile.computerName`

**Type from Azure API:** String (within osProfile object)

## Hidden Fields

None identified. The `computer_name` field is directly exposed in the provider schema.

## Mapping

**Terraform (snake_case) → Azure API (camelCase):**
- `computer_name` → `computerName`

## Special Handling

### 1. ForceNew Behavior

**Evidence:**
```go
"computer_name": {
	ForceNew: true,
}
```

**Implementation:** Added to `replace_triggers_external_values` with full value tracking:
```hcl
replace_triggers_external_values = {
  computer_name = { value = var.computer_name != null ? var.computer_name : var.name }
}
```

**Note:** Tracks the effective computer name value (either explicit or defaulted from VM name) to ensure replacement is triggered when it changes.

### 2. Validation

**Provider Validation Function:**

```go
func WindowsComputerNameFull(i interface{}, k string) (warnings []string, errors []error) {
	return windowsComputerName(i, k, 15, false)
}

func windowsComputerName(i interface{}, k string, maxLength int, allowDashSuffix bool) (warnings []string, errors []error) {
	v, ok := i.(string)
	if !ok {
		errors = append(errors, fmt.Errorf("expected %q to be a string but it wasn't", k))
		return
	}

	// The value must not be empty.
	if strings.TrimSpace(v) == "" {
		errors = append(errors, fmt.Errorf("%q must not be empty", k))
		return
	}

	if len(v) > maxLength {
		errors = append(errors, fmt.Errorf("%q can be at most %d characters, got %d", k, maxLength, len(v)))
	}

	if !allowDashSuffix && strings.HasSuffix(v, "-") {
		errors = append(errors, fmt.Errorf("%q cannot end with dash", k))
	}

	// A windows computer name can only contain alphanumeric characters and hyphens
	if matched := regexp.MustCompile(`^[a-zA-Z0-9-]+$`).Match([]byte(v)); !matched {
		errors = append(errors, fmt.Errorf("%q may only contain alphanumeric characters and dashes", k))
	}

	// Windows computer name cannot contain only numbers
	if matched := regexp.MustCompile(`^\d+$`).Match([]byte(v)); matched {
		errors = append(errors, fmt.Errorf("%q cannot contain only numbers", k))
	}

	return warnings, errors
}
```

**Replicated Validations:**

1. **Not Empty:** `var.computer_name == null || var.computer_name != ""`
2. **Max Length (15 chars):** `length(var.computer_name) <= 15`
3. **Cannot End with Dash:** `!can(regex("-$", var.computer_name))`
4. **Alphanumeric + Dashes Only:** `can(regex("^[a-zA-Z0-9-]+$", var.computer_name))`
5. **Cannot Contain Only Numbers:** `!can(regex("^\\d+$", var.computer_name))`
6. **Default Value Validation:** When `computer_name` is not specified, the VM name must satisfy all the same validation rules

**Implementation Location:** `variables.tf` validation blocks for immediate plan-time validation.

### 3. Computed Default Behavior

**Provider Logic:**

```go
var computerName string
if v, ok := d.GetOk("computer_name"); ok && len(v.(string)) > 0 {
	computerName = v.(string)
} else {
	_, errs := computeValidate.WindowsComputerNameFull(d.Get("name"), "computer_name")
	if len(errs) > 0 {
		return fmt.Errorf("unable to assume default computer name %s. Please adjust the `name`, or specify an explicit `computer_name`", errs[0])
	}
	computerName = id.VirtualMachineName
}
```

**Replicated Behavior:**
- If `var.computer_name` is provided and not empty, use it
- Otherwise, use `var.name` as the computer name
- Validation ensures that if `var.name` is used as default, it must be a valid computer name

**Implementation:**
```hcl
computerName = var.computer_name != null ? var.computer_name : var.name
```

### 4. ConflictsWith

**Provider Schema:**
```go
ConflictsWith: []string{
	"os_managed_disk_id",
},
```

**Deferred Work:** Cross-field validation with `os_managed_disk_id` deferred to Task #26 (when `os_managed_disk_id` variable is created). Documented in `following.md`.

## Deferred Work Completion

**Check `following.md`:** No work was deferred TO this task (#13).

## Critical Review & Edge Case Analysis

### Null Semantics

**When `var.computer_name = null`:**
- Meaning: Use default (VM name)
- Implementation: `var.computer_name != null ? var.computer_name : var.name`
- Validation ensures VM name is valid as computer name

**When `var.computer_name = ""`:**
- Meaning: Invalid - empty string not allowed
- Validation: `var.computer_name != ""` catches this

### Boundary Conditions

1. **Length Boundary (15 characters):**
   - Valid: 15-character names pass validation
   - Invalid: 16+ character names fail validation
   - Edge case: Empty string fails validation

2. **Character Set:**
   - Valid: `a-zA-Z0-9-` (alphanumeric + hyphens)
   - Invalid: Any other characters including underscore, dot, space

3. **Ending with Dash:**
   - Valid: `"myvm-1"` (dash in middle)
   - Invalid: `"myvm-"` (ending with dash)

4. **Numeric Only:**
   - Valid: `"vm123"` (mixed alphanumeric)
   - Invalid: `"123456"` (only numbers)

### Idempotency

**Configuration:** The value is deterministic based on input:
- If `computer_name` is set: use that value
- If `computer_name` is null: always use `var.name`

**ForceNew Tracking:** The `replace_triggers_external_values` tracks the effective value, ensuring idempotent behavior:
- Same input → same effective value → no replacement
- Changed input → changed effective value → triggers replacement

### Safe References

**Implementation:**
```hcl
computerName = var.computer_name != null ? var.computer_name : var.name
```

**Safety Analysis:**
- `var.name` is always available (Required field, cannot be null)
- `var.computer_name` null-checked before access
- No nested property access that could fail

### Edge Cases

1. **VM Name Too Long (>15 chars):**
   - **Scenario:** User provides VM name that's > 15 characters but doesn't set `computer_name`
   - **Behavior:** Validation fails with clear error message
   - **Match Provider:** ✅ Provider also validates and returns error

2. **VM Name Contains Invalid Characters:**
   - **Scenario:** User provides VM name with underscores/dots (valid for VM name) but doesn't set `computer_name`
   - **Behavior:** Validation fails requiring explicit `computer_name`
   - **Match Provider:** ✅ Provider also validates and returns error

3. **Explicit Empty String:**
   - **Scenario:** User sets `computer_name = ""`
   - **Behavior:** Validation catches empty string
   - **Match Provider:** ✅ Provider validation also rejects empty string

4. **Only Numbers:**
   - **Scenario:** `computer_name = "12345"`
   - **Behavior:** Validation rejects (cannot be only numbers)
   - **Match Provider:** ✅ Provider validation has same rule

## Checklist

- ✅ Property in correct local (`body.properties.osProfile.computerName`)
- ✅ ForceNew wrapped in `replace_triggers_external_values`: `{ value = ... }`
- ✅ ALL provider logic EXACTLY replicated (default to VM name, validation rules)
- ✅ Validations IMPLEMENTED in variables.tf (6 validation blocks)
- ✅ Hidden fields checked (none found)
- ✅ Deferred work recorded in following.md (ConflictsWith validation for os_managed_disk_id)
- ✅ Deferred work from following.md checked (none for this task)
- ✅ Critical review completed (null, edge cases, idempotency, safe refs)
- ✅ Edge Case Analysis section added
- ✅ Proof document created
- ✅ track.md will be updated to "Pending for check"
- ✅ Self-Review: Added ONLY computer_name field, no hidden fields, no other task content

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-24
**Task:** #13 - computer_name

### Validation Results

✅ **ForceNew Logic:** Simple ForceNew correctly implemented with stable key wrapping `{ value = var.computer_name != null ? var.computer_name : var.name }` - tracks full effective value including default fallback to VM name
✅ **Stable Keys:** Key `computer_name` always present in `replace_triggers_external_values` with stable structure
✅ **Phase Detection:** Field correctly placed in `local.body.properties.osProfile.computerName` (Create phase)
✅ **Type Conversion:** String to String - direct mapping with conditional default logic
✅ **Null Handling:** Correctly implements computed default behavior - when null, falls back to `var.name`
✅ **Validations:** All 6 provider validation rules exactly replicated in variables.tf:
  - Not empty string
  - Max length 15 characters
  - Cannot end with dash
  - Alphanumeric and dashes only
  - Cannot contain only numbers
  - Cross-variable validation ensuring VM name is valid when used as default
✅ **Deferred Work Completion:** No deferred work for this task in following.md
✅ **Deferred Work Recording:** ConflictsWith validation for os_managed_disk_id properly deferred to Task #26 and documented in following.md
✅ **Edge Cases:** Comprehensive edge case analysis covering:
  - VM name too long (>15 chars) - validation catches
  - VM name with invalid characters - validation catches
  - Explicit empty string - validation catches
  - Only numbers - validation catches

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`:

1. **Exact Validation Replication:** All validation logic from `computeValidate.WindowsComputerNameFull` precisely replicated including empty check, length limit, character restrictions, dash suffix check, and numeric-only check
2. **Exact Default Logic:** Computed default behavior matches provider - when `computer_name` is null, falls back to `var.name` with validation ensuring name is valid as computer name
3. **Exact ForceNew Behavior:** Tracks effective value (explicit or defaulted) to ensure any change triggers replacement as provider does
4. **No Deviations:** Implementation contains no simplifications, no "safer alternatives", no approximations - only exact replication of provider source code logic

**Status:** APPROVED ✅

---
