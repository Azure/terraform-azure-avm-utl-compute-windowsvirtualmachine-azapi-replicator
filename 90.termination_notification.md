# Task #90 - termination_notification - STRUCTURE SKELETON

## Summary
Created the structure skeleton for the `termination_notification` block in `local.body.properties.scheduledEventsProfile.terminateNotificationProfile`. This block holds scheduled termination notification settings for the VM and is merged with `osImageNotificationProfile` under the shared `scheduledEventsProfile` parent.

## Shadow Implementation

```hcl
locals {
  body = merge(
    {
      properties = merge(
        # ... other properties ...
        var.os_image_notification != null || var.termination_notification != null ? {
          scheduledEventsProfile = merge(  # <-
            var.os_image_notification != null ? {  # <-
              osImageNotificationProfile = {  # <-
                enable           = true  # <-
                notBeforeTimeout = var.os_image_notification.timeout  # <-
              }  # <-
            } : {},  # <-
            var.termination_notification != null ? {  # <-
              terminateNotificationProfile = {  # <-
                # enabled = ... # Task #91  # <-
                # notBeforeTimeout = ... # Task #92  # <-
              }  # <-
            } : {}  # <-
          )  # <-
        } : {}  # <-
      )
    }
  )
}
```

## Create Phase Verification

**Method**: Queried Create method via `query_terraform_block_implementation_source_code` with `entrypoint_name=create`.

**Pattern**: Single-phase creation - the block is populated during the primary `CreateOrUpdateThenPoll` call.

**Go Code Evidence**:
```go
var osImageNotificationProfile *virtualmachines.OSImageNotificationProfile
var terminateNotificationProfile *virtualmachines.TerminateNotificationProfile

if v, ok := d.GetOk("os_image_notification"); ok {
	osImageNotificationProfile = expandOsImageNotificationProfile(v.([]interface{}))
}

if v, ok := d.GetOk("termination_notification"); ok {
	terminateNotificationProfile = expandTerminateNotificationProfile(v.([]interface{}))
}

if terminateNotificationProfile != nil || osImageNotificationProfile != nil {
	params.Properties.ScheduledEventsProfile = &virtualmachines.ScheduledEventsProfile{
		OsImageNotificationProfile:   osImageNotificationProfile,
		TerminateNotificationProfile: terminateNotificationProfile,
	}
}
```

**Decision**: The block is assigned to `params.Properties.ScheduledEventsProfile.TerminateNotificationProfile` **before** the primary `CreateOrUpdateThenPoll` call. This is part of the **Create phase** (single-phase pattern).

## Assignment Path Verification

**Predicted Path**: `body.properties.scheduledEventsProfile.terminateNotificationProfile`

**Go Code Trace**:
1. `terminateNotificationProfile` → local variable of type `*virtualmachines.TerminateNotificationProfile`
2. Assigned to `params.Properties.ScheduledEventsProfile` → adds `.properties.scheduledEventsProfile`
3. Field name: `TerminateNotificationProfile` → adds `.terminateNotificationProfile`

**Verified Path**: `properties.scheduledEventsProfile.terminateNotificationProfile`

**Path Comparison**: ✅ MATCH - The predicted path exactly matches the verified path from Go code trace.

## Provider Schema

**Method**: Queried via `query_terraform_block_implementation_source_code` with `entrypoint_name=schema`.

**Go Source**:
```go
"termination_notification": virtualMachineTerminationNotificationSchema(),
```

**Schema Function**:
```go
func virtualMachineTerminationNotificationSchema() *pluginsdk.Schema {
	return &pluginsdk.Schema{
		Type:     pluginsdk.TypeList,
		Optional: true,
		Computed: true,
		MaxItems: 1,
		Elem: &pluginsdk.Resource{
			Schema: map[string]*pluginsdk.Schema{
				"enabled": {
					Type:     pluginsdk.TypeBool,
					Required: true,
				},
				"timeout": {
					Type:         pluginsdk.TypeString,
					Optional:     true,
					ValidateFunc: azValidate.ISO8601DurationBetween("PT5M", "PT15M"),
					Default:      "PT5M",
				},
			},
		},
	}
}
```

**Block Properties**:
- **Type**: `TypeList` with `MaxItems: 1` (single block)
- **Optional**: `true` (not required)
- **Computed**: `true` (can be computed by provider)
- **Child Arguments**:
  - `enabled` (Required, TypeBool)
  - `timeout` (Optional, TypeString, Default: "PT5M")

## Azure API Schema

**Method**: Queried via `query_azapi_resource_schema` with path `body.properties.scheduledEventsProfile`.

**Schema Output**:
```
ObjectWithOptionalAttrs(
  map[string]Type{
    "osImageNotificationProfile": ObjectWithOptionalAttrs(
      map[string]Type{
        "enable": Bool, 
        "notBeforeTimeout": String
      }, 
      []string{"enable", "notBeforeTimeout"}
    ), 
    "terminateNotificationProfile": ObjectWithOptionalAttrs(
      map[string]Type{
        "enable": Bool, 
        "notBeforeTimeout": String
      }, 
      []string{"enable", "notBeforeTimeout"}
    )
  }, 
  []string{"osImageNotificationProfile", "terminateNotificationProfile"}
)
```

**Properties**:
- `scheduledEventsProfile.terminateNotificationProfile.enable` (Bool, optional)
- `scheduledEventsProfile.terminateNotificationProfile.notBeforeTimeout` (String, optional)

## Hidden Fields

**Method**: Examined `expandTerminateNotificationProfile` function for any hardcoded values or hidden fields.

**Go Source**:
```go
func expandTerminateNotificationProfile(input []interface{}) *virtualmachines.TerminateNotificationProfile {
	if len(input) == 0 {
		return &virtualmachines.TerminateNotificationProfile{
			Enable: pointer.To(false),
		}
	}

	raw := input[0].(map[string]interface{})
	enabled := raw["enabled"].(bool)
	timeout := raw["timeout"].(string)

	return &virtualmachines.TerminateNotificationProfile{
		Enable:           &enabled,
		NotBeforeTimeout: &timeout,
	}
}
```

**Hidden Fields**: 
- ⚠️ **CRITICAL**: When `len(input) == 0` (block is not set), the provider returns a profile with `Enable: pointer.To(false)`. This is NOT a hidden field - it's a special case where the provider explicitly sends `{"enable": false}` when the block is absent to ensure termination notifications are disabled.
- This behavior will be handled by the individual child tasks (#91, #92) when implementing the actual values, as they need to decide whether to send the terminateNotificationProfile object at all.

**NO hidden fields** need to be added to this skeleton - only the two child arguments from the schema.

## Mapping

| Terraform Field | Azure API Field | Notes |
|----------------|-----------------|-------|
| `termination_notification` | `scheduledEventsProfile.terminateNotificationProfile` | Object wrapper |
| `termination_notification.enabled` | `scheduledEventsProfile.terminateNotificationProfile.enable` | Task #91 |
| `termination_notification.timeout` | `scheduledEventsProfile.terminateNotificationProfile.notBeforeTimeout` | Task #92 |

**Naming Convention**: 
- `enabled` → `enable` (singular form)
- `timeout` → `notBeforeTimeout` (descriptive camelCase)

## Special Handling

### Shared Parent Path
The `scheduledEventsProfile` object is **shared** between two blocks:
1. `os_image_notification` (Task #74) → `scheduledEventsProfile.osImageNotificationProfile`
2. `termination_notification` (Task #90) → `scheduledEventsProfile.terminateNotificationProfile`

**Implementation Strategy**: Modified existing `os_image_notification` condition to create `scheduledEventsProfile` when **either** block is set, then use `merge()` to combine both profiles. This ensures the parent object is created correctly when only one or both blocks are present.

### Block vs Individual Fields
- This task creates the **block structure skeleton** only
- Individual field implementations belong to:
  - Task #91: `termination_notification.enabled` (Required)
  - Task #92: `termination_notification.timeout` (Optional with Default)

## Edge Case Analysis

### Null Semantics
- **Block absent** (`var.termination_notification == null`): The `terminateNotificationProfile` object is **not included** in the API request (handled by conditional `var.termination_notification != null ? {...} : {}`)
- **Block present but empty**: This cannot occur in Terraform - the `enabled` field is Required, so the block cannot be set without providing `enabled`

### Boundary Conditions
- **Both blocks set**: The `merge()` correctly combines both `osImageNotificationProfile` and `terminateNotificationProfile` under the shared `scheduledEventsProfile` parent
- **Only termination_notification set**: The `scheduledEventsProfile` is created with only `terminateNotificationProfile` (no `osImageNotificationProfile`)
- **Only os_image_notification set**: The `scheduledEventsProfile` is created with only `osImageNotificationProfile` (no `terminateNotificationProfile`)

### Safe References
- ✅ The block check `var.termination_notification != null` protects against null access
- ✅ Individual field references (`var.termination_notification.enabled`, etc.) are only accessed within the non-null conditional block
- ✅ Shared parent condition correctly evaluates both blocks: `var.os_image_notification != null || var.termination_notification != null`

## Deferred Work Completion

**Checked `following.md`**: No deferred work found for Task #90.

## Child Tasks Now Ready

The following child tasks are now ready for delegation (block skeleton is in place):

| Task # | Field | Type | Required | Notes |
|--------|-------|------|----------|-------|
| #91 | `termination_notification.enabled` | Argument | Yes | Must implement Required field validation |
| #92 | `termination_notification.timeout` | Argument | No | Has default value "PT5M", validation PT5M-PT15M |

## Checklist

- ✅ Structure skeleton created with comment placeholders for child arguments
- ✅ Shared parent `scheduledEventsProfile` correctly handles both blocks
- ✅ Conditional block creation: `var.termination_notification != null ? {...} : {}`
- ✅ Hidden fields checked in expand function - none found
- ✅ No deferred work from `following.md`
- ✅ Edge case analysis completed
- ✅ Proof document created
- ✅ `track.md` updated to "Pending for check"
- ✅ Self-review: Only block skeleton added, no child argument implementations

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-24
**Task:** #90 - termination_notification

### Validation Results

✅ **Block Structure Skeleton:** Correctly created conditional skeleton with comment placeholders for child arguments (#91, #92)
✅ **Shared Parent Path:** Properly uses nested `merge()` for shared `scheduledEventsProfile` parent (combines with `osImageNotificationProfile` from Task #74)
✅ **Phase Detection:** Field correctly placed in `local.body.properties` (Create phase, single-phase pattern)
✅ **Assignment Path:** Verified path `properties.scheduledEventsProfile.terminateNotificationProfile` matches Go code trace exactly
✅ **Null Handling:** Correct conditional logic `var.termination_notification != null ? {...} : {}` prevents null access
✅ **Hidden Fields:** Correctly identified no hidden fields for skeleton task (special case behavior deferred to child tasks)
✅ **Deferred Work Completion:** No deferred work for this task in following.md
✅ **Edge Cases:** Comprehensive analysis covering null semantics, boundary conditions (both blocks, single block, no blocks), and safe references
✅ **Proof Document:** All required sections present with proper evidence and analysis
✅ **Scope Adherence:** Executor correctly limited implementation to skeleton only, no child argument implementations

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The skeleton follows the Type 3 task pattern precisely:
- Conditional parent path creation based on block presence
- Nested merge for shared parent (`scheduledEventsProfile`) to avoid shallow merge overwrites
- Comment placeholders for child tasks (#91 enabled, #92 timeout)
- No premature implementation of child arguments
- Proper integration with existing `os_image_notification` block under shared parent

No deviations, simplifications, or "safer alternatives" were found.

**Status:** APPROVED ✅

---
