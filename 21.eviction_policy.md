# Task #21 - eviction_policy - COMPLETED

## Summary

Implemented `eviction_policy` as a root-level Optional argument with ForceNew behavior. The field is mapped to `properties.evictionPolicy` in the Azure API and includes enum validation for the two allowed values: "Deallocate" and "Delete".

## Shadow Implementation

```hcl
# variables.tf
variable "eviction_policy" {
  type        = string
  default     = null
  description = "(Optional) Specifies what should happen when the Virtual Machine is evicted for price reasons when using a Spot instance. Possible values are `Deallocate` and `Delete`. Changing this forces a new resource to be created."

  validation {
    condition = var.eviction_policy == null || contains([  # <-
      "Deallocate",  # <-
      "Delete"  # <-
    ], var.eviction_policy)  # <-
    error_message = "The eviction_policy must be either 'Deallocate' or 'Delete'."  # <-
  }  # <-
}

# migrate_main.tf
locals {
  replace_triggers_external_values = {
    # ... other fields ...
    eviction_policy = { value = var.eviction_policy }  # <-
  }
  
  body = merge(
    {
      properties = merge(
        # ... other properties ...
        var.eviction_policy != null ? {  # <-
          evictionPolicy = var.eviction_policy  # <-
        } : {}  # <-
      )
    },
    # ... other body fields ...
  )
}
```

## Create Phase Verification

**Query Method**: `query_terraform_block_implementation_source_code` with `entrypoint_name=create`

**Pattern**: Single-phase create operation

**Field Classification**: Create phase - field is assigned during the primary `CreateOrUpdateThenPoll` operation

**Go Code Evidence**:
```go
if evictionPolicyRaw, ok := d.GetOk("eviction_policy"); ok {
    if params.Properties.Priority != nil && *params.Properties.Priority != virtualmachines.VirtualMachinePriorityTypesSpot {
        return fmt.Errorf("an `eviction_policy` can only be specified when `priority` is set to `Spot`")
    }

    params.Properties.EvictionPolicy = pointer.To(virtualmachines.VirtualMachineEvictionPolicyTypes(evictionPolicyRaw.(string)))
} else if priority == virtualmachines.VirtualMachinePriorityTypesSpot {
    return fmt.Errorf("an `eviction_policy` must be specified when `priority` is set to `Spot`")
}

// Later in the function:
if err := client.CreateOrUpdateThenPoll(ctx, id, params, virtualmachines.DefaultCreateOrUpdateOperationOptions()); err != nil {
    return fmt.Errorf("creating Windows %s: %+v", id, err)
}
```

**Decision**: Field is set in the `params` struct before the single `CreateOrUpdateThenPoll` call, so it belongs in `local.body` during the Create phase.

## Assignment Path Verification

**Predicted Path**: `properties.evictionPolicy`

**Go Code Evidence**:
```go
// Field is read from Terraform config
if evictionPolicyRaw, ok := d.GetOk("eviction_policy"); ok {
    // ... validation logic ...
    params.Properties.EvictionPolicy = pointer.To(virtualmachines.VirtualMachineEvictionPolicyTypes(evictionPolicyRaw.(string)))
}

// params is of type virtualmachines.VirtualMachine
params := virtualmachines.VirtualMachine{
    Name:             pointer.To(id.VirtualMachineName),
    // ...
    Properties: &virtualmachines.VirtualMachineProperties{
        // ...
        Priority: pointer.To(priority),
        // ... EvictionPolicy is set here within Properties
    },
    // ...
}
```

**Traced Assignment**:
1. Value read from `d.GetOk("eviction_policy")`
2. Assigned to `params.Properties.EvictionPolicy` (pointer)
3. `params.Properties` is of type `*virtualmachines.VirtualMachineProperties`
4. Final path: `properties.evictionPolicy` (Go field `EvictionPolicy` maps to JSON `evictionPolicy`)

**Verified Path**: `properties.evictionPolicy`

**Path Comparison**: ✅ MATCH - Predicted path matches verified path

## Provider Schema

**Source**: `query_terraform_block_implementation_source_code` with `entrypoint_name=schema`

```go
"eviction_policy": {
    // only applicable when `priority` is set to `Spot`
    Type:     pluginsdk.TypeString,
    Optional: true,
    ForceNew: true,
    ValidateFunc: validation.StringInSlice([]string{
        string(virtualmachines.VirtualMachineEvictionPolicyTypesDeallocate),
        string(virtualmachines.VirtualMachineEvictionPolicyTypesDelete),
    }, false),
},
```

**Key Properties**:
- Type: String
- Optional: true
- ForceNew: true
- Validation: StringInSlice with two allowed values (Deallocate, Delete)
- No Default value
- No DiffSuppressFunc
- No ConflictsWith
- No RequiredWith

## Azure API Schema

**Resource Type**: `Microsoft.Compute/virtualMachines@2024-03-01`

**Property Path**: `body.properties.evictionPolicy`

**Schema Type**: `String`

**From Full Schema Query**:
```
"evictionPolicy":String
```

The field is located at `properties.evictionPolicy` in the API request body as an optional String field.

## Hidden Fields

None. The field has no hidden companion fields or implicit dependencies.

## Mapping

**Terraform (snake_case)** → **Azure API (camelCase)**
- `eviction_policy` → `evictionPolicy`

## Special Handling

### 1. ForceNew Behavior

**Schema**: `ForceNew: true`

**Implementation**: Added to `replace_triggers_external_values` with full value tracking:
```hcl
eviction_policy = { value = var.eviction_policy }
```

This ensures that any change to the eviction policy (including null ↔ non-null transitions, or value changes) triggers resource replacement.

### 2. Validation

**Provider Validation**: `StringInSlice` with two enum values

**Implementation**: Added validation block in `variables.tf`:
```hcl
validation {
  condition = var.eviction_policy == null || contains([
    "Deallocate",
    "Delete"
  ], var.eviction_policy)
  error_message = "The eviction_policy must be either 'Deallocate' or 'Delete'."
}
```

**Note**: The provider source code shows the validation uses the SDK enum constants:
- `virtualmachines.VirtualMachineEvictionPolicyTypesDeallocate` = "Deallocate"
- `virtualmachines.VirtualMachineEvictionPolicyTypesDelete` = "Delete"

### 3. Cross-Field Runtime Validation (NOT Implemented)

**Provider Logic in Create Method**:
```go
if evictionPolicyRaw, ok := d.GetOk("eviction_policy"); ok {
    if params.Properties.Priority != nil && *params.Properties.Priority != virtualmachines.VirtualMachinePriorityTypesSpot {
        return fmt.Errorf("an `eviction_policy` can only be specified when `priority` is set to `Spot`")
    }
    params.Properties.EvictionPolicy = pointer.To(virtualmachines.VirtualMachineEvictionPolicyTypes(evictionPolicyRaw.(string)))
} else if priority == virtualmachines.VirtualMachinePriorityTypesSpot {
    return fmt.Errorf("an `eviction_policy` must be specified when `priority` is set to `Spot`")
}
```

**Analysis**: The provider enforces two runtime validations:
1. If `eviction_policy` is set, then `priority` must be `Spot`
2. If `priority` is `Spot`, then `eviction_policy` must be set

**Deferral Decision**: These cross-field validations involve the `priority` field, which is handled in Task #30. According to executor.md rules on cross-field validations, the validation should be implemented in the "owning" variable's validation block.

**Ownership**: Since the validation logic checks `priority` when evaluating `eviction_policy`, this is logically owned by the `priority` field (Task #30).

**Action**: Defer these cross-field validations to Task #30 (priority).

**Documentation in following.md**: Added entry to track this deferred work.

### 4. No Sensitive/WriteOnly Fields

The field is not marked as Sensitive or WriteOnly - it is a plain configuration field.

## Deferred Work Completion

**Checked**: No work in `following.md` was deferred TO this task (#21).

**New Deferral**: Added entry to `following.md`:
```
| #21 | #30 | Validation | Cross-field validation: eviction_policy can only be set when priority is Spot, and if priority is Spot, eviction_policy must be set | Pending |
```

## Critical Review & Edge Case Analysis

### Null Semantics
- **null**: Field is not sent in API request (Azure uses default behavior - no eviction policy applies)
- **Non-null**: Explicit eviction policy is set and sent to Azure API
- **Correct**: Conditional inclusion in body ensures null means "omit from request"

### Edge Cases

1. **Empty String**: 
   - Validation will reject empty string since it's not in the allowed values list
   - ✅ Correct behavior

2. **Case Sensitivity**: 
   - Provider validation is case-sensitive (`false` parameter to `StringInSlice`)
   - Our validation uses exact match with `contains()`
   - ✅ Correct behavior matches provider

3. **Invalid Values**: 
   - Validation rejects any value not in ["Deallocate", "Delete"]
   - ✅ Catches typos and invalid values at plan time

### Idempotency
- Field value is directly assigned without transformation
- No order-dependent logic
- ✅ Safe for repeated applies

### Safe References
- Field is accessed directly as `var.eviction_policy`
- Conditional check `var.eviction_policy != null` before inclusion
- ✅ No risk of null pointer access

### ForceNew Tracking
- Full value tracking: `{ value = var.eviction_policy }`
- Detects all changes: null → value, value → null, value1 → value2
- ✅ Comprehensive change detection

## Checklist

- ✅ Property in correct local (`body.properties`)
- ✅ ForceNew wrapped: `{ value = var.eviction_policy }`
- ✅ All logic EXACTLY replicated from provider (value validation, ForceNew)
- ✅ Validations IMPLEMENTED in variables.tf (enum validation)
- ✅ No TODO comment needed (not a sensitive field migration)
- ✅ Hidden fields checked (none found)
- ✅ Deferred work in following.md: Recorded cross-field validation deferral to Task #30
- ✅ Deferred work from following.md: Checked - no work deferred to this task
- ✅ Critical review completed (null, edge cases, idempotent, safe refs)
- ✅ Edge Case Analysis included
- ✅ Proof created
- ✅ Self-Review: Added ONLY eviction_policy field, no content from other tasks

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-24
**Task:** #21 - eviction_policy

### Validation Results

✅ **ForceNew Logic:** Simple ForceNew correctly implemented with full value tracking
✅ **Stable Keys:** Key `eviction_policy` is always present in `replace_triggers_external_values`
✅ **Phase Detection:** Field correctly placed in `local.body.properties` (Create phase)
✅ **Type Conversion:** String → String (direct mapping, no conversion needed)
✅ **Null Handling:** Correctly propagates null semantics with conditional inclusion
✅ **Validations:** Enum validation correctly implemented in variables.tf with StringInSlice equivalent
✅ **Deferred Work Completion:** No deferred work for this task in following.md
✅ **Deferred Work Recording:** Cross-field validation properly recorded in following.md (deferred to Task #30)
✅ **Edge Cases:** Null, empty string, case sensitivity, invalid values - all properly handled
✅ **Assignment Path:** Correctly mapped to `properties.evictionPolicy`
✅ **Full Value Tracking:** Uses `{ value = var.eviction_policy }` to track complete value changes

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`:
- ✅ ForceNew behavior matches schema `ForceNew: true`
- ✅ Enum validation exactly matches provider's `StringInSlice` validation
- ✅ Cross-field validations appropriately deferred to owning task (Task #30 - priority)
- ✅ No simplifications, no "safer alternatives", no deviations
- ✅ Assignment path verified with Go code tracing

**Status:** APPROVED ✅

---
