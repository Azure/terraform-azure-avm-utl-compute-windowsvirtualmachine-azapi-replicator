# Task #44 - os_disk Block Structure Skeleton

## Summary
Created structure skeleton for required `os_disk` block in `migrate_main.tf` with comment placeholders for all child arguments (Tasks #45-52). Identified hidden fields (`createOption`, `osType`) in expand function for future implementation.

## Create Phase Verification

### Query Create Method
The resource uses a single-phase create pattern:

```go
func resourceWindowsVirtualMachineCreate(d *pluginsdk.ResourceData, meta interface{}) error {
	client := meta.(*clients.Client).Compute.VirtualMachinesClient
	// ...
	if err := client.CreateOrUpdateThenPoll(ctx, id, params, virtualmachines.DefaultCreateOrUpdateOperationOptions()); err != nil {
		return fmt.Errorf("creating Windows %s: %+v", id, err)
	}
}
```

**Pattern**: Single-phase (one `CreateOrUpdateThenPoll` operation)

### Field Classification
The `os_disk` block is processed during the primary `CreateOrUpdateThenPoll` operation. All fields are assigned in `expandVirtualMachineOSDisk` which is called during request building for the primary create.

**Decision**: Field belongs in `local.body` (Create phase)

## Assignment Path Verification

### Predicted Path
`body.properties.storageProfile.osDisk`

### Go Code Evidence

From `expandVirtualMachineOSDisk`:
```go
func expandVirtualMachineOSDisk(input []interface{}, osType virtualmachines.OperatingSystemTypes) (*virtualmachines.OSDisk, error) {
	raw := input[0].(map[string]interface{})
	caching := raw["caching"].(string)

	disk := virtualmachines.OSDisk{
		Caching: pointer.To(virtualmachines.CachingTypes(caching)),
		ManagedDisk: &virtualmachines.ManagedDiskParameters{
			StorageAccountType: pointer.To(virtualmachines.StorageAccountTypes(raw["storage_account_type"].(string))),
		},
		WriteAcceleratorEnabled: pointer.To(raw["write_accelerator_enabled"].(bool)),
		CreateOption: virtualmachines.DiskCreateOptionTypesFromImage,
		OsType:       pointer.To(osType),
	}
	// ... additional fields ...
	return &disk, nil
}
```

From Create method:
```go
func resourceWindowsVirtualMachineCreate(d *pluginsdk.ResourceData, meta interface{}) error {
	// ...
	params := virtualmachines.VirtualMachine{
		// ...
		Properties: &virtualmachines.VirtualMachineProperties{
			StorageProfile: &virtualmachines.StorageProfile{
				OsDisk: expandVirtualMachineOSDisk(d.Get("os_disk").([]interface{}), virtualmachines.OperatingSystemTypesWindows),
				// ...
			},
		},
	}
}
```

**Assignment trace**: 
1. `expandVirtualMachineOSDisk` returns `*virtualmachines.OSDisk`
2. Assigned to `StorageProfile.OsDisk`
3. `StorageProfile` assigned to `Properties.StorageProfile`
4. `Properties` assigned to `VirtualMachine.Properties`

### Verified Path
`body.properties.storageProfile.osDisk`

### Path Comparison
✅ **MATCH** - Predicted path matches verified path exactly.

## Provider Schema

From `virtualMachineOSDiskSchema()`:

```go
func virtualMachineOSDiskSchema() *pluginsdk.Schema {
	return &pluginsdk.Schema{
		Type:     pluginsdk.TypeList,
		Required: true,  // <- Block is required
		MaxItems: 1,
		Elem: &pluginsdk.Resource{
			Schema: map[string]*pluginsdk.Schema{
				"caching": {
					Type:     pluginsdk.TypeString,
					Required: true,  // <- Task #45
					ValidateFunc: validation.StringInSlice([]string{
						string(virtualmachines.CachingTypesNone),
						string(virtualmachines.CachingTypesReadOnly),
						string(virtualmachines.CachingTypesReadWrite),
					}, false),
				},

				"storage_account_type": {
					Type:     pluginsdk.TypeString,
					Optional: true,  // <- Task #46
					Computed: true,
					ForceNew: true,
					ValidateFunc: validation.StringInSlice([]string{
						string(virtualmachines.StorageAccountTypesPremiumLRS),
						string(virtualmachines.StorageAccountTypesStandardLRS),
						string(virtualmachines.StorageAccountTypesStandardSSDLRS),
						string(virtualmachines.StorageAccountTypesStandardSSDZRS),
						string(virtualmachines.StorageAccountTypesPremiumZRS),
					}, false),
					ExactlyOneOf: []string{
						"os_managed_disk_id",
						"os_disk.0.storage_account_type",
					},
				},

				"diff_disk_settings": {
					Type:     pluginsdk.TypeList,
					Optional: true,  // <- Task #53 (nested block)
					ForceNew: true,
					MaxItems: 1,
					// ... nested schema
				},

				"disk_encryption_set_id": {
					Type:     pluginsdk.TypeString,
					Optional: true,  // <- Task #47
					DiffSuppressFunc: suppress.CaseDifference,
					ValidateFunc:     validate.DiskEncryptionSetID,
					ConflictsWith:    []string{"os_disk.0.secure_vm_disk_encryption_set_id"},
				},

				"disk_size_gb": {
					Type:         pluginsdk.TypeInt,
					Optional:     true,  // <- Task #48
					Computed:     true,
					ValidateFunc: validation.IntBetween(0, 4095),
				},

				"name": {
					Type:     pluginsdk.TypeString,
					Optional: true,  // <- Task #49
					ForceNew: true,
					Computed: true,
				},

				"secure_vm_disk_encryption_set_id": {
					Type:          pluginsdk.TypeString,
					Optional:      true,  // <- Task #50
					ForceNew:      true,
					ValidateFunc:  validate.DiskEncryptionSetID,
					ConflictsWith: []string{"os_disk.0.disk_encryption_set_id"},
				},

				"security_encryption_type": {
					Type:     pluginsdk.TypeString,
					Optional: true,  // <- Task #51
					ForceNew: true,
					ValidateFunc: validation.StringInSlice([]string{
						string(virtualmachines.SecurityEncryptionTypesVMGuestStateOnly),
						string(virtualmachines.SecurityEncryptionTypesDiskWithVMGuestState),
					}, false),
				},

				"write_accelerator_enabled": {
					Type:     pluginsdk.TypeBool,
					Optional: true,  // <- Task #52
					Default:  false,
				},

				"id": {
					Type:     pluginsdk.TypeString,
					Computed: true,  // <- Read-only, not for migration
				},
			},
		},
	}
}
```

## Hidden Fields

From `expandVirtualMachineOSDisk`:

```go
disk := virtualmachines.OSDisk{
	// ... user-configurable fields ...
	
	// Hidden fields - hardcoded values not exposed in schema:
	CreateOption: virtualmachines.DiskCreateOptionTypesFromImage,  // <- Always "FromImage"
	OsType:       pointer.To(osType),  // <- Always "Windows" (passed as parameter)
}
```

**Hidden Fields Identified**:
1. `createOption` = `"FromImage"` (hardcoded constant)
2. `osType` = `"Windows"` (passed as `virtualmachines.OperatingSystemTypesWindows` parameter)

These hidden fields will need to be added to the skeleton structure. Since they are constant values, they should be included in the conditional merge for the `os_disk` block.

## Azure API Schema

Query path: `properties.storageProfile.osDisk`

The Azure API expects the following structure:
```
properties.storageProfile.osDisk = {
  caching: string (enum: None, ReadOnly, ReadWrite)
  createOption: string (enum: FromImage, Empty, Attach)
  osType: string (enum: Windows, Linux)
  managedDisk: {
    storageAccountType: string
    diskEncryptionSet: { id: string }
    securityProfile: {
      securityEncryptionType: string
      diskEncryptionSet: { id: string }
    }
  }
  diskSizeGB: integer
  name: string
  writeAcceleratorEnabled: boolean
  diffDiskSettings: {
    option: string
    placement: string
  }
}
```

## Mapping

| Terraform (snake_case) | Azure API (camelCase) | Task # |
|------------------------|-----------------------|--------|
| os_disk | storageProfile.osDisk | #44 (block structure) |
| caching | caching | #45 |
| storage_account_type | managedDisk.storageAccountType | #46 |
| disk_encryption_set_id | managedDisk.diskEncryptionSet.id | #47 |
| disk_size_gb | diskSizeGB | #48 |
| name | name | #49 |
| secure_vm_disk_encryption_set_id | managedDisk.securityProfile.diskEncryptionSet.id | #50 |
| security_encryption_type | managedDisk.securityProfile.securityEncryptionType | #51 |
| write_accelerator_enabled | writeAcceleratorEnabled | #52 |
| diff_disk_settings | diffDiskSettings | #53 (nested block) |
| (hidden) | createOption = "FromImage" | #44 |
| (hidden) | osType = "Windows" | #44 |

## Special Handling

### Block Structure
- **Required block**: `os_disk` is required (min_items: 1, max_items: 1)
- **Null check**: Since the block is required (`nullable = false` in variables.tf), no null check is needed
- **Nested structure**: Requires `managedDisk` wrapper for several fields

### Hidden Fields
The skeleton will include the two hidden fields:
- `createOption: "FromImage"` - constant value
- `osType: "Windows"` - constant value for Windows VM

These are not configurable by users but must be present in the API request.

## Implementation

### Shadow Implementation
```hcl
locals {
  body = {
    properties = merge(
      # ... existing fields ...
      {
        storageProfile = merge(
          # ... existing storageProfile fields ...
          {
            osDisk = {
              # caching = ... # Task #45  # <-
              # storage_account_type -> managedDisk.storageAccountType # Task #46  # <-
              # disk_encryption_set_id -> managedDisk.diskEncryptionSet.id # Task #47  # <-
              # disk_size_gb -> diskSizeGB # Task #48  # <-
              # name = ... # Task #49  # <-
              # secure_vm_disk_encryption_set_id -> managedDisk.securityProfile.diskEncryptionSet.id # Task #50  # <-
              # security_encryption_type -> managedDisk.securityProfile.securityEncryptionType # Task #51  # <-
              # write_accelerator_enabled -> writeAcceleratorEnabled # Task #52  # <-
              # diff_disk_settings -> diffDiskSettings # Task #53  # <-
              
              # Hidden fields (hardcoded in provider):  # <-
              createOption = "FromImage"  # <-
              osType       = "Windows"  # <-
            }
          }
        )
      }
    )
  }
}
```

**Note**: The `# <-` markers are only in this proof document and will NOT appear in the actual code files.

## Edge Case Analysis

### Null Semantics
- Block is **required** (`nullable = false`), so `var.os_disk != null` check is not needed
- Child fields are **optional** with various defaults and computed values
- Child tasks will handle individual field null semantics

### Boundary Conditions
- Block must have exactly 1 instance (MaxItems: 1)
- Variables.tf already enforces this through `object()` type
- Hidden fields are constants and never null

### Idempotency
- Structure is deterministic (no ordering issues)
- Hidden fields have constant values ensuring consistent API requests
- Child field implementations will handle their own idempotency

### Safe References
- Since block is required, direct access to `var.os_disk.field` is safe
- No nested null checks needed at block level
- Child tasks will implement safe access patterns for optional nested fields

## Child Tasks Ready for Delegation

Based on the schema analysis, the following child tasks are now ready to be delegated:

### Direct Arguments (Type 4)
- **Task #45**: `os_disk.caching` (Required argument)
- **Task #46**: `os_disk.storage_account_type` (Optional, ForceNew)
- **Task #47**: `os_disk.disk_encryption_set_id` (Optional, DiffSuppressFunc)
- **Task #48**: `os_disk.disk_size_gb` (Optional, Computed)
- **Task #49**: `os_disk.name` (Optional, ForceNew, Computed)
- **Task #50**: `os_disk.secure_vm_disk_encryption_set_id` (Optional, ForceNew)
- **Task #51**: `os_disk.security_encryption_type` (Optional, ForceNew)
- **Task #52**: `os_disk.write_accelerator_enabled` (Optional, Default: false)

### Nested Block (Type 3)
- **Task #53**: `os_disk.diff_disk_settings` (Optional nested block structure skeleton)

**Total**: 9 child tasks ready for delegation (8 arguments + 1 nested block)

## Checklist

- ✅ Block structure skeleton created in `migrate_main.tf`
- ✅ Comment placeholders added for all child arguments (Tasks #45-52)
- ✅ Nested block placeholder added for `diff_disk_settings` (Task #53)
- ✅ Hidden fields identified (`createOption`, `osType`) from expand function
- ✅ Hidden fields added to skeleton with constant values
- ✅ Assignment path verified (matches prediction)
- ✅ Create phase verified (single-phase, primary create)
- ✅ Edge case analysis completed
- ✅ No deferred work in `following.md` for this task
- ✅ Proof document created
- ✅ Ready to update `track.md` to "Pending for check"
- ✅ Self-Review: Only skeleton structure added, no implementation of child fields

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-24
**Task:** #44 - os_disk

### Validation Results

✅ **Block Structure:** Skeleton correctly created in `migrate_main.tf` lines 168-182
✅ **Assignment Path:** Correctly placed at `body.properties.storageProfile.osDisk`
✅ **Hidden Fields:** Both `createOption = "FromImage"` and `osType = "Windows"` correctly hardcoded
✅ **Phase Detection:** Field correctly placed in `local.body` (Create phase, single-phase pattern)
✅ **Null Handling:** No conditional check needed - block is required (`nullable = false`)
✅ **Child Field Placeholders:** All 8 direct arguments (Tasks #45-52) properly commented
✅ **Nested Block Placeholder:** `diff_disk_settings` (Task #53) properly commented
✅ **Deferred Work Completion:** No deferred work for this task in `following.md`
✅ **Deferred Work Recording:** No deferrals made by this task
✅ **Edge Cases:** Comprehensive analysis completed in proof document
✅ **Scope Adherence:** Only skeleton structure added, no child field implementations

### Compliance Statement

This implementation EXACTLY follows the Type 3 (Block Structure Skeleton) requirements from `executor.md`. The skeleton provides proper structure with comment placeholders for all child tasks, includes both hidden fields identified from the expand function, and correctly places the block in the Create phase. No deviations found.

**Status:** APPROVED ✅

---
