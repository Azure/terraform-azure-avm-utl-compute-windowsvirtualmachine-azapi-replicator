# Task #22 - extensions_time_budget - COMPLETED

## Summary

Implemented `extensions_time_budget` as a root-level Optional argument with a default value of "PT1H30M". The field is updatable (no ForceNew) and includes validation to ensure the value is a valid ISO 8601 duration between PT15M (15 minutes) and PT2H (120 minutes). The field is mapped to `properties.extensionsTimeBudget` in the Azure API.

## Shadow Implementation

```hcl
# variables.tf
variable "extensions_time_budget" {
  type        = string  # <-
  default     = "PT1H30M"  # <-
  nullable    = false  # <-
  description = "(Optional) Specifies the duration allocated for all extensions to start. The time duration should be between 15 minutes and 120 minutes (inclusive) and should be specified in ISO 8601 format. Defaults to `PT1H30M`."  # <-

  validation {  # <-
    condition = can(regex("^PT([0-1]?[0-9]|2[0-3])H([0-5]?[0-9]M)?$", var.extensions_time_budget)) || can(regex("^PT([0-9]|[1-9][0-9]|1[0-1][0-9]|120)M$", var.extensions_time_budget))  # <-
    error_message = "The extensions_time_budget must be a valid ISO 8601 duration format."  # <-
  }  # <-

  validation {  # <-
    condition = (  # <-
      can(regex("^PT([0-9]+)M$", var.extensions_time_budget)) ?  # <-
        tonumber(regex("^PT([0-9]+)M$", var.extensions_time_budget)[0]) >= 15 && tonumber(regex("^PT([0-9]+)M$", var.extensions_time_budget)[0]) <= 120 :  # <-
      can(regex("^PT([0-9]+)H([0-9]+)M$", var.extensions_time_budget)) ?  # <-
        (tonumber(regex("^PT([0-9]+)H([0-9]+)M$", var.extensions_time_budget)[0]) * 60 + tonumber(regex("^PT([0-9]+)H([0-9]+)M$", var.extensions_time_budget)[1])) >= 15 &&  # <-
        (tonumber(regex("^PT([0-9]+)H([0-9]+)M$", var.extensions_time_budget)[0]) * 60 + tonumber(regex("^PT([0-9]+)H([0-9]+)M$", var.extensions_time_budget)[1])) <= 120 :  # <-
      can(regex("^PT([0-9]+)H$", var.extensions_time_budget)) ?  # <-
        tonumber(regex("^PT([0-9]+)H$", var.extensions_time_budget)[0]) * 60 >= 15 && tonumber(regex("^PT([0-9]+)H$", var.extensions_time_budget)[0]) * 60 <= 120 :  # <-
      false  # <-
    )  # <-
    error_message = "The extensions_time_budget must be between PT15M (15 minutes) and PT2H (120 minutes)."  # <-
  }  # <-
}

# migrate_main.tf
locals {
  body = merge(
    {
      properties = merge(
        # ... other properties ...
        {  # <-
          extensionsTimeBudget = var.extensions_time_budget  # <-
        },  # <-
      )
    },
    # ... other body fields ...
  )
}
```

## Create Phase Verification

**Query Method**: `query_terraform_block_implementation_source_code` with `entrypoint_name=create`

**Pattern**: Single-phase create operation

**Field Classification**: Create phase - field is assigned during the primary `CreateOrUpdateThenPoll` operation

**Go Code Evidence**:
```go
params := virtualmachines.VirtualMachine{
    Name:             pointer.To(id.VirtualMachineName),
    ExtendedLocation: expandEdgeZone(d.Get("edge_zone").(string)),
    Location:         location.Normalize(d.Get("location").(string)),
    Identity:         identityExpanded,
    Plan:             plan,
    Properties: &virtualmachines.VirtualMachineProperties{
        // ... other properties ...
        
        // Optional
        AdditionalCapabilities: additionalCapabilities,
        DiagnosticsProfile:     bootDiagnostics,
        ExtensionsTimeBudget:   pointer.To(d.Get("extensions_time_budget").(string)),
    },
    Tags: tags.Expand(t),
}

// Later in the function:
if err := client.CreateOrUpdateThenPoll(ctx, id, params, virtualmachines.DefaultCreateOrUpdateOperationOptions()); err != nil {
    return fmt.Errorf("creating Windows %s: %+v", id, err)
}
```

**Decision**: Field is set in the `params.Properties` struct before the single `CreateOrUpdateThenPoll` call, so it belongs in `local.body.properties` during the Create phase.

## Assignment Path Verification

**Predicted Path**: `properties.extensionsTimeBudget`

**Go Code Evidence**:
```go
// Field is read from Terraform config
ExtensionsTimeBudget:   pointer.To(d.Get("extensions_time_budget").(string)),

// params is of type virtualmachines.VirtualMachine
params := virtualmachines.VirtualMachine{
    Name:             pointer.To(id.VirtualMachineName),
    // ...
    Properties: &virtualmachines.VirtualMachineProperties{
        // ...
        ExtensionsTimeBudget:   pointer.To(d.Get("extensions_time_budget").(string)),
        // ...
    },
    // ...
}
```

**Traced Assignment**:
1. Value read from `d.Get("extensions_time_budget")`
2. Assigned to `params.Properties.ExtensionsTimeBudget` (pointer)
3. `params.Properties` is of type `*virtualmachines.VirtualMachineProperties`
4. Final path: `properties.extensionsTimeBudget` (Go field `ExtensionsTimeBudget` maps to JSON `extensionsTimeBudget`)

**Verified Path**: `properties.extensionsTimeBudget`

**Path Comparison**: ✅ MATCH - Predicted path matches verified path

## Provider Schema

**Source**: `query_terraform_block_implementation_source_code` with `entrypoint_name=schema`

```go
"extensions_time_budget": {
    Type:         pluginsdk.TypeString,
    Optional:     true,
    Default:      "PT1H30M",
    ValidateFunc: azValidate.ISO8601DurationBetween("PT15M", "PT2H"),
},
```

**Key Properties**:
- Type: String
- Optional: true
- Default: "PT1H30M"
- ForceNew: false (not set)
- Validation: ISO8601DurationBetween("PT15M", "PT2H") - validates duration is between 15 minutes and 2 hours
- No DiffSuppressFunc
- No ConflictsWith
- No RequiredWith

## Azure API Schema

**Resource Type**: `Microsoft.Compute/virtualMachines@2024-03-01`

**Property Path**: `body.properties.extensionsTimeBudget`

**Schema Type**: `String`

**API Documentation**: 
```
"Specifies the time alloted for all extensions to start. The time duration should be between 15 minutes and 120 minutes (inclusive) and should be specified in ISO 8601 format. The default value is 90 minutes (PT1H30M). Minimum api-version: 2020-06-01."
```

The field is located at `properties.extensionsTimeBudget` in the API request body as an optional String field.

## Hidden Fields

None. The field has no hidden companion fields or implicit dependencies.

## Mapping

**Terraform (snake_case)** → **Azure API (camelCase)**
- `extensions_time_budget` → `extensionsTimeBudget`

## Special Handling

### 1. No ForceNew Behavior

**Schema**: `ForceNew: false` (not set, defaults to false)

**Update Verification**: The field is updatable as seen in the Update method:
```go
if d.HasChange("extensions_time_budget") {
    shouldUpdate = true
    update.Properties.ExtensionsTimeBudget = pointer.To(d.Get("extensions_time_budget").(string))
}
```

**Implementation**: Field is NOT added to `replace_triggers_external_values` since it does not require ForceNew. Updates are handled via normal resource update operations.

### 2. Default Value

**Provider Default**: `"PT1H30M"` (90 minutes)

**Implementation**: Added default value in `variables.tf`:
```hcl
variable "extensions_time_budget" {
  type        = string
  default     = "PT1H30M"
  nullable    = false
  # ...
}
```

**Critical**: Since this is a root-level argument with a default value, MUST set both `default = "PT1H30M"` AND `nullable = false` as per executor.md rules for top-level arguments with defaults.

### 3. Validation

**Provider Validation**: `azValidate.ISO8601DurationBetween("PT15M", "PT2H")`

This validation ensures:
1. The value is a valid ISO 8601 duration format
2. The duration is between 15 minutes (PT15M) and 120 minutes (PT2H) inclusive

**Implementation**: Added two validation blocks in `variables.tf`:

**Validation 1 - Format Validation**:
```hcl
validation {
  condition = can(regex("^PT([0-1]?[0-9]|2[0-3])H([0-5]?[0-9]M)?$", var.extensions_time_budget)) || can(regex("^PT([0-9]|[1-9][0-9]|1[0-1][0-9]|120)M$", var.extensions_time_budget))
  error_message = "The extensions_time_budget must be a valid ISO 8601 duration format."
}
```

This validates the string format supports:
- `PT[0-23]H` optionally followed by `[0-59]M` (e.g., PT1H, PT1H30M, PT2H)
- `PT[0-120]M` (e.g., PT15M, PT90M, PT120M)

**Validation 2 - Range Validation**:
```hcl
validation {
  condition = (
    can(regex("^PT([0-9]+)M$", var.extensions_time_budget)) ?
      tonumber(regex("^PT([0-9]+)M$", var.extensions_time_budget)[0]) >= 15 && tonumber(regex("^PT([0-9]+)M$", var.extensions_time_budget)[0]) <= 120 :
    can(regex("^PT([0-9]+)H([0-9]+)M$", var.extensions_time_budget)) ?
      (tonumber(regex("^PT([0-9]+)H([0-9]+)M$", var.extensions_time_budget)[0]) * 60 + tonumber(regex("^PT([0-9]+)H([0-9]+)M$", var.extensions_time_budget)[1])) >= 15 && 
      (tonumber(regex("^PT([0-9]+)H([0-9]+)M$", var.extensions_time_budget)[0]) * 60 + tonumber(regex("^PT([0-9]+)H([0-9]+)M$", var.extensions_time_budget)[1])) <= 120 :
    can(regex("^PT([0-9]+)H$", var.extensions_time_budget)) ?
      tonumber(regex("^PT([0-9]+)H$", var.extensions_time_budget)[0]) * 60 >= 15 && tonumber(regex("^PT([0-9]+)H$", var.extensions_time_budget)[0]) * 60 <= 120 :
    false
  )
  error_message = "The extensions_time_budget must be between PT15M (15 minutes) and PT2H (120 minutes)."
}
```

This converts the ISO 8601 duration to minutes and validates:
- Minimum: 15 minutes (PT15M)
- Maximum: 120 minutes (PT2H)

Handles three formats:
1. Minutes only: `PT15M` to `PT120M`
2. Hours and minutes: `PT1H30M` (90 minutes)
3. Hours only: `PT1H` (60 minutes), `PT2H` (120 minutes)

### 4. No Sensitive/WriteOnly Fields

The field is not marked as Sensitive or WriteOnly - it is a plain configuration field.

## Deferred Work Completion

**Checked**: No work in `following.md` was deferred TO this task (#22).

**New Deferral**: None - no cross-field validations or dependencies identified.

## Critical Review & Edge Case Analysis

### Null Semantics
- **null**: Not applicable - field has `default = "PT1H30M"` and `nullable = false`
- **Non-null**: Explicit extensions time budget is set and sent to Azure API
- **Correct**: Field always has a value (default or user-provided)

### Edge Cases

1. **Empty String**: 
   - Validation will reject empty string since it doesn't match ISO 8601 format
   - ✅ Correct behavior

2. **Boundary Values**: 
   - PT15M (minimum): Valid and accepted
   - PT2H (maximum): Valid and accepted
   - PT14M (below minimum): Rejected by range validation
   - PT2H1M (above maximum): Rejected by range validation
   - ✅ Correct behavior matches provider validation

3. **Format Variations**: 
   - PT90M (90 minutes): Valid - equivalent to PT1H30M
   - PT120M (120 minutes): Valid - equivalent to PT2H
   - PT1H30M (90 minutes): Valid - default value
   - ✅ All valid ISO 8601 duration formats accepted

4. **Invalid Formats**: 
   - "90 minutes": Rejected by format validation
   - "PT90": Rejected by format validation
   - "1H30M": Rejected by format validation (missing PT prefix)
   - ✅ Catches invalid formats at plan time

### Idempotency
- Field value is directly assigned without transformation
- No order-dependent logic
- ✅ Safe for repeated applies

### Safe References
- Field is accessed directly as `var.extensions_time_budget`
- No conditional check needed since field has default value and is non-nullable
- ✅ No risk of null pointer access

### Default Value Handling
- Provider default: "PT1H30M"
- Terraform variable default: "PT1H30M"
- ✅ Exact match ensures consistent behavior

### Update Behavior
- Field can be updated without resource replacement
- Update method includes explicit handling: `d.HasChange("extensions_time_budget")`
- ✅ Updates work as expected

## Checklist

- ✅ Property in correct local (`body.properties`)
- ✅ No ForceNew needed (field is updatable)
- ✅ All logic EXACTLY replicated from provider (default value, format validation, range validation)
- ✅ Validations IMPLEMENTED in variables.tf (ISO 8601 format + range validation)
- ✅ No TODO comment needed (not a sensitive field migration)
- ✅ Hidden fields checked (none found)
- ✅ Deferred work in following.md: No new deferrals needed
- ✅ Deferred work from following.md: Checked - no work deferred to this task
- ✅ Critical review completed (null, edge cases, idempotent, safe refs)
- ✅ Edge Case Analysis included
- ✅ Proof created
- ✅ Self-Review: Added ONLY extensions_time_budget field, no content from other tasks

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-24
**Task:** #22 - extensions_time_budget

### Validation Results

✅ **ForceNew Logic:** Field is NOT ForceNew - correctly NOT in replace_triggers_external_values. Field is updatable per provider Update method.
✅ **Stable Keys:** N/A - field is not ForceNew
✅ **Phase Detection:** Field correctly placed in local.body.properties (Create phase)
✅ **Type Conversion:** Correct direct assignment from string to String (no conversion needed)
✅ **Null Handling:** Field has default = "PT1H30M" with nullable = false (MANDATORY for root-level defaults per executor.md)
✅ **Validations:** All provider validations EXACTLY replicated in variables.tf:
  - Format validation: ISO 8601 duration format (regex patterns for PTxM, PTxH, PTxHyM)
  - Range validation: 15-120 minutes inclusive (PT15M to PT2H)
✅ **Root-Level Default Values:** CRITICAL compliance verified:
  - `default = "PT1H30M"` matches provider default
  - `nullable = false` present (MANDATORY per executor.md lines 405-424)
✅ **Deferred Work Completion:** No deferred work for this task in following.md
✅ **Deferred Work Recording:** No deferrals made - no cross-field dependencies
✅ **Shared Path Merge:** No merge conflicts - properties key appears once, extensionsTimeBudget has no conflicts
✅ **Assignment Path:** properties.extensionsTimeBudget matches provider implementation exactly
✅ **Edge Cases:** All edge cases properly analyzed and handled:
  - Boundary values (PT15M, PT2H) correctly validated
  - Format variations (PT90M, PT1H30M, PT2H) all supported
  - Invalid formats rejected at plan time
  - Default value always applied (non-nullable)

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. No deviations, simplifications, or "safer alternatives" were found. The field:
- Has correct Optional status with default value
- Replicates exact ISO8601DurationBetween validation logic
- Is properly updatable (no ForceNew)
- Includes MANDATORY `nullable = false` for root-level default values
- Has comprehensive format and range validation
- Handles all edge cases correctly

**Status:** APPROVED ✅

---
