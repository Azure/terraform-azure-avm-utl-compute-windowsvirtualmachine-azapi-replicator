# Task #66 - gallery_application.automatic_upgrade_enabled

## Summary

Implemented `gallery_application.automatic_upgrade_enabled` field mapping from AzureRM provider to AzAPI resource. The field is optional with a default value of `false`, maps to `enableAutomaticUpgrade` in the Azure API, and is updatable (not ForceNew).

## Shadow Implementation

```hcl
locals {
  body = {
    properties = merge(
      var.gallery_application != null && length(var.gallery_application) > 0 ? {
        applicationProfile = {
          galleryApplications = [
            for app in var.gallery_application : {
              packageReferenceId         = app.version_id
              enableAutomaticUpgrade     = app.automatic_upgrade_enabled != null ? app.automatic_upgrade_enabled : false  # <-
              # Other fields...
            }
          ]
        }
      } : {}
    )
  }
}
```

## Create Phase Verification

**Query Result**: From `resourceWindowsVirtualMachineCreate` function:

```go
params := virtualmachines.VirtualMachine{
	Properties: &virtualmachines.VirtualMachineProperties{
		ApplicationProfile: &virtualmachines.ApplicationProfile{
			GalleryApplications: expandVirtualMachineGalleryApplication(d.Get("gallery_application").([]interface{})),
		},
		// ... other properties
	},
}

if err := client.CreateOrUpdateThenPoll(ctx, id, params, virtualmachines.DefaultCreateOrUpdateOperationOptions()); err != nil {
	return fmt.Errorf("creating Windows %s: %+v", id, err)
}
```

**Pattern**: Single-phase Create - the `gallery_application` field (including `automatic_upgrade_enabled`) is set in the primary `CreateOrUpdateThenPoll` operation.

**Classification**: This field is part of the Create phase within the primary `CreateOrUpdate` operation.

**Decision**: Implement in `local.body.properties.applicationProfile.galleryApplications[].enableAutomaticUpgrade`

## Assignment Path Verification

**Predicted Path**: `properties.applicationProfile.galleryApplications[].enableAutomaticUpgrade`

**Go Code Evidence** (from `expandVirtualMachineGalleryApplication`):

```go
func expandVirtualMachineGalleryApplication(input []interface{}) *[]virtualmachines.VMGalleryApplication {
	out := make([]virtualmachines.VMGalleryApplication, 0)
	if len(input) == 0 {
		return &out
	}

	for _, v := range input {
		config := v.(map[string]interface{})
		app := &virtualmachines.VMGalleryApplication{
			PackageReferenceId:              config["version_id"].(string),
			ConfigurationReference:          pointer.To(config["configuration_blob_uri"].(string)),
			Order:                           pointer.To(int64(config["order"].(int))),
			Tags:                            pointer.To(config["tag"].(string)),
			EnableAutomaticUpgrade:          pointer.To(config["automatic_upgrade_enabled"].(bool)),  // Direct assignment
			TreatFailureAsDeploymentFailure: pointer.To(config["treat_failure_as_deployment_failure_enabled"].(bool)),
		}

		out = append(out, *app)
	}

	return &out
}
```

The expand function directly assigns to the `EnableAutomaticUpgrade` field of `VMGalleryApplication` struct. In the Create function:

```go
ApplicationProfile: &virtualmachines.ApplicationProfile{
	GalleryApplications: expandVirtualMachineGalleryApplication(d.Get("gallery_application").([]interface{})),
}
```

This is assigned to `params.Properties.ApplicationProfile.GalleryApplications`.

**Verified Path**: `properties.applicationProfile.galleryApplications[].enableAutomaticUpgrade`

**Path Comparison**: ✅ Match - predicted path matches verified path

## Provider Schema

From `VirtualMachineGalleryApplicationSchema()`:

```go
"automatic_upgrade_enabled": {
	Type:     pluginsdk.TypeBool,
	Optional: true,
	Default:  false,
},
```

**Key Observations**:
- **Type**: Bool
- **Optional**: true
- **Default**: false
- **ForceNew**: false (not specified, meaning it's updatable)
- **Sensitive**: false
- **Computed**: false

## Azure API Schema

**Resource Type**: `Microsoft.Compute/virtualMachines@2024-03-01`

**Property Path**: `body.properties.applicationProfile.galleryApplications[].enableAutomaticUpgrade`

**Type**: `Bool`

**Description**: "Specifies whether the gallery application should be upgraded automatically when a new version becomes available."

## Hidden Fields

None. The expand function shows all fields are explicitly mapped from Terraform configuration.

## Mapping

- Terraform (snake_case): `automatic_upgrade_enabled`
- Azure API (camelCase): `enableAutomaticUpgrade`

## Special Handling

### Default Value

The provider schema specifies `Default: false`. Implementation must apply this default when the field is not set:

```hcl
enableAutomaticUpgrade = app.automatic_upgrade_enabled != null ? app.automatic_upgrade_enabled : false
```

This ensures the same behavior as the provider's default value.

### Updatable (Not ForceNew)

From Update method analysis:

```go
if d.HasChange("gallery_application") {
	shouldUpdate = true
	update.Properties.ApplicationProfile = &virtualmachines.ApplicationProfile{
		GalleryApplications: expandVirtualMachineGalleryApplication(d.Get("gallery_application").([]interface{})),
	}
}
```

The entire `gallery_application` block (including `automatic_upgrade_enabled`) is updatable via the Update method. **No ForceNew behavior** - changes to this field do not require resource replacement.

## Deferred Work Completion

Checked `following.md` - no work was deferred to Task #66.

## Critical Review & Edge Case

### Null Semantics

- **`null`**: When `automatic_upgrade_enabled` is not specified, the default value `false` is applied
- **`false`**: Explicitly disables automatic upgrades
- **`true`**: Enables automatic upgrades

### Edge Cases

1. **Empty gallery_application list**: The parent block conditional (`var.gallery_application != null && length(var.gallery_application) > 0`) prevents the entire `applicationProfile` from being set when no applications are configured
2. **Explicit false vs default**: Both result in `enableAutomaticUpgrade: false` in the API call
3. **Updates**: Changes to `automatic_upgrade_enabled` within existing gallery applications are applied via Update operation without VM replacement

### Idempotency

✅ The implementation is idempotent:
- First apply: Sets `enableAutomaticUpgrade` to the specified value or default `false`
- Subsequent applies: No change if value remains the same
- Updates: Properly reflects changes when the field is modified

### Safe References

✅ Safe access pattern:
- `app.automatic_upgrade_enabled` is safely accessed within the `for` loop over `var.gallery_application`
- The parent block ensures `var.gallery_application` is not null before iteration
- Default value handling with ternary operator ensures a valid boolean value is always assigned

## Checklist

- ✅ Property in correct local (`body.properties.applicationProfile.galleryApplications[].enableAutomaticUpgrade`)
- ✅ ForceNew NOT needed (field is updatable)
- ✅ ALL logic EXACTLY replicated from provider (default value applied)
- ✅ Validations: None required (boolean field with default, no cross-field dependencies)
- ✅ TODO comment: Not applicable (no sensitive field migration)
- ✅ Hidden fields checked (none found)
- ✅ Deferred work in following.md: Not applicable (no deferral needed)
- ✅ Deferred work from following.md: Checked - none deferred to this task
- ✅ Critical review completed
- ✅ Edge Case Analysis completed
- ✅ Proof created
- ✅ Self-Review: Only implemented `automatic_upgrade_enabled` field, no content from other tasks added

---

## ⚠️ CHECKER VALIDATION - ISSUES FOUND AND CORRECTED

**Checked by:** Checker Agent
**Date:** 2025-12-24
**Task:** #66 - gallery_application.automatic_upgrade_enabled

### Issues Identified

#### Issue 1: Violation of Method Priority for Default Values

**Problem:**
The executor implemented the default value using a ternary operator in `locals` instead of using the `optional(type, default)` syntax in the variable definition, violating the method priority rule from `executor.md`.

**Executor's Implementation:**
```hcl
# In variables.tf
automatic_upgrade_enabled = optional(bool)

# In migrate_main.tf
enableAutomaticUpgrade = app.automatic_upgrade_enabled != null ? app.automatic_upgrade_enabled : false
```

**Why This Violates executor.md:**
From `executor.md` lines 146-149:
> **Defaults:** If schema has `Default`, replicate it:
> - **Nested (PREFER):** `optional(bool, true)` or `optional(string, "PT1H30M")` in object type
> - **Fallback:** Apply default in locals if optional() syntax not possible

The field is inside a `list(object({...}))` structure, which means `optional(bool, false)` syntax IS possible and MUST be used according to the PREFER method.

**Provider's Actual Behavior:**
From the provider schema:
```go
"automatic_upgrade_enabled": {
	Type:     pluginsdk.TypeBool,
	Optional: true,
	Default:  false,
},
```

The provider specifies a default value of `false` for this optional boolean field.

**Expected Behavior:**
- When user doesn't specify `automatic_upgrade_enabled`, the value should be `false`
- When user explicitly sets it to `true` or `false`, use that value
- The default must be applied at the variable type level, not in locals

**Root Cause:**
Executor chose the Fallback method (applying default in locals) when the PREFER method (`optional(bool, false)`) was both possible and mandatory for nested object fields.

### Corrections Made

#### Fix 1: Applied Default Value Using PREFER Method

**Changed Files:**
- `variables.tf`: Changed `automatic_upgrade_enabled = optional(bool)` to `automatic_upgrade_enabled = optional(bool, false)`
- `migrate_main.tf`: Simplified `enableAutomaticUpgrade` from ternary operator to direct assignment

**New Implementation:**

In `variables.tf`:
```hcl
variable "gallery_application" {
  type = list(object({
    automatic_upgrade_enabled = optional(bool, false)  # Default applied here
    # ... other fields
  }))
}
```

In `migrate_main.tf`:
```hcl
enableAutomaticUpgrade = app.automatic_upgrade_enabled  # Direct assignment, default guaranteed by type
```

**Why This is EXACT:**
- Uses Terraform 1.9+ `optional(type, default)` syntax as prescribed by `executor.md` PREFER method
- Default value of `false` matches provider schema exactly
- Eliminates redundant null checking since `optional(bool, false)` guarantees non-null value
- Follows the method priority: PREFER method is used instead of Fallback

**Verification:**
- Scenario 1: User doesn't specify field → `false` (matches provider) ✅
- Scenario 2: User sets to `true` → `true` (matches provider) ✅
- Scenario 3: User sets to `false` → `false` (matches provider) ✅
- Edge Case: Empty gallery_application list → No field emitted (matches provider) ✅

### Compliance Statement

After corrections, this implementation now EXACTLY replicates the provider behavior as required by `executor.md`. The default value is applied using the PREFER method (`optional(bool, false)`) instead of the fallback ternary operator approach.

**Status:** CORRECTED AND APPROVED ✅
