# Task #2 - resource_group_name - Proof Document

## Summary
Implemented the `resource_group_name` argument for `azurerm_windows_virtual_machine` to `azapi_resource`. The `resource_group_name` field is Required and ForceNew. This field is used to construct the parent_id (resource group ID) for the Virtual Machine resource and is NOT placed in the request body. All provider validations have been replicated in variables.tf.

## Shadow Implementation

### variables.tf
```hcl
variable "resource_group_name" {
  type        = string
  description = "(Required) The name of the Resource Group in which the Windows Virtual Machine should be exist. Changing this forces a new resource to be created."
  nullable    = false

  validation {  # <-
    condition     = length(var.resource_group_name) <= 90  # <-
    error_message = "The resource_group_name may not exceed 90 characters in length."  # <-
  }  # <-

  validation {  # <-
    condition     = !can(regex("\\.$", var.resource_group_name))  # <-
    error_message = "The resource_group_name may not end with a period."  # <-
  }  # <-

  validation {  # <-
    condition     = can(regex("^[-\\w._()]+$", var.resource_group_name))  # <-
    error_message = "The resource_group_name may only contain alphanumeric characters, dash, underscores, parentheses and periods."  # <-
  }  # <-
}
```

### Note on parent_id mapping
The `resource_group_name` is NOT added to `local.body` or any other local. Instead, it is used to construct the `resource_group_id` which is passed to `azapi_header.parent_id`. This mapping was already completed in Task #1:

```hcl
# In migrate_variables.tf (from Task #1)
variable "resource_group_id" {
  type        = string
  description = "The ID of the Resource Group in which the Windows Virtual Machine should exist."
  nullable    = false
}

# In migrate_main.tf (from Task #1)
locals {
  azapi_header = {
    # ...
    parent_id = var.resource_group_id  # <-
    # ...
  }
}
```

## Create Phase Verification

### Pattern Identification
Query: `query_terraform_block_implementation_source_code(entrypoint_name="create")`

Evidence from Create method:
```go
func resourceWindowsVirtualMachineCreate(d *pluginsdk.ResourceData, meta interface{}) error {
	client := meta.(*clients.Client).Compute.VirtualMachinesClient
	subscriptionId := meta.(*clients.Client).Account.SubscriptionId
	ctx, cancel := timeouts.ForCreate(meta.(*clients.Client).StopContext, d)
	defer cancel()

	id := virtualmachines.NewVirtualMachineID(subscriptionId, d.Get("resource_group_name").(string), d.Get("name").(string))
	
	// ... builds params as virtualmachines.VirtualMachine
	
	params := virtualmachines.VirtualMachine{
		Name:     pointer.To(id.VirtualMachineName),
		Location: location.Normalize(d.Get("location").(string)),
		// ... other properties
	}
	
	if err := client.CreateOrUpdateThenPoll(ctx, id, params, virtualmachines.DefaultCreateOrUpdateOperationOptions()); err != nil {
		return fmt.Errorf("creating Windows %s: %+v", id, err)
	}

	d.SetId(id.ID())
	return resourceWindowsVirtualMachineRead(d, meta)
}
```

**Decision**: Single-phase operation. The `resource_group_name` field is used to construct the resource ID (via `virtualmachines.NewVirtualMachineID()`), which is used as the identifier for the `CreateOrUpdateThenPoll` operation. The field is NOT added to the request body (`params`). In AzAPI provider, this translates to using `resource_group_id` as the `parent_id` in `azapi_header`.

## Assignment Path Verification

### Predicted Path
`azapi_header.parent_id` (via `resource_group_id` variable transformation)

### Go Code Evidence
```go
id := virtualmachines.NewVirtualMachineID(subscriptionId, d.Get("resource_group_name").(string), d.Get("name").(string))

// The resource_group_name is used to construct the resource ID, not assigned to the params body
params := virtualmachines.VirtualMachine{
	Name:     pointer.To(id.VirtualMachineName),
	Location: location.Normalize(d.Get("location").(string)),
	// ... NO resource_group_name property in the body
}

if err := client.CreateOrUpdateThenPoll(ctx, id, params, ...); err != nil {
	// The 'id' parameter (first argument) contains the resource group name as part of the resource identifier
}
```

The `resource_group_name` is extracted from `d.Get("resource_group_name")` and used to construct the resource ID. It is NOT assigned to any property in the `params` (request body). This corresponds to the resource's parent scope in the Azure Resource Manager hierarchy.

### Verified Path
`azapi_header.parent_id` (resource group ID)

### Path Comparison
✅ Match. The predicted path matches the verified path. The `resource_group_name` is a parent scope identifier, not a body property. In AzureRM provider, it's part of the resource ID. In AzAPI provider, the resource group ID is passed as `parent_id`.

## Provider Schema

### Schema Definition
```go
"resource_group_name": commonschema.ResourceGroupName(),
```

Expanding `commonschema.ResourceGroupName()`:
```go
func ResourceGroupName() *schema.Schema {
	return &schema.Schema{
		Type:         schema.TypeString,
		Required:     true,
		ForceNew:     true,
		ValidateFunc: resourcegroups.ValidateName,
	}
}
```

### Validation Function
```go
func ValidateName(v interface{}, k string) (warnings []string, errors []error) {
	value := v.(string)

	if len(value) > 90 {
		errors = append(errors, fmt.Errorf("%q may not exceed 90 characters in length", k))
	}

	if strings.HasSuffix(value, ".") {
		errors = append(errors, fmt.Errorf("%q may not end with a period", k))
	}

	if len(value) == 0 {
		errors = append(errors, fmt.Errorf("%q cannot be blank", k))
	} else if matched := regexp.MustCompile(`^[-\w._()]+$`).Match([]byte(value)); !matched {
		// regex pulled from https://docs.microsoft.com/en-us/rest/api/resources/resourcegroups/createorupdate
		errors = append(errors, fmt.Errorf("%q may only contain alphanumeric characters, dash, underscores, parentheses and periods", k))
	}

	return warnings, errors
}
```

**Key Attributes**:
- Type: String
- Required: Yes
- ForceNew: Yes
- Validation: Custom function `resourcegroups.ValidateName` with multiple rules

## Azure API Schema

The `resource_group_name` is NOT part of the Azure API request body for Virtual Machines. It is part of the resource identifier in the ARM hierarchy:

```
/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/virtualMachines/{vmName}
```

In AzAPI provider:
- The resource group ID (`/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}`) is passed as `parent_id`
- The VM name is passed as `name`
- Together they form the complete resource ID

## Hidden Fields

No hidden fields detected for the `resource_group_name` property. This is a standard parent scope identifier that is part of the resource ID construction.

## Mapping

| AzureRM Field | AzAPI Field | Notes |
|---------------|-------------|-------|
| `resource_group_name` | `azapi_header.parent_id` (via `resource_group_id` variable) | Parent scope identifier, not in request body |

The field name `resource_group_name` in AzureRM becomes `resource_group_id` in the replicator module (as a required input that users must provide), which is then used as `parent_id` in the azapi_header.

## Special Handling

### ForceNew
**Schema Evidence**: `ForceNew: true`

**Implementation**: The ForceNew behavior is implicitly handled by AzAPI provider. When `parent_id` changes, the resource ID changes, which requires replacement. No explicit entry in `replace_triggers_external_values` is needed because `parent_id` is part of the resource identifier itself in `azapi_header`.

### Validations
All validations from the provider's `resourcegroups.ValidateName` function have been replicated in `variables.tf`:

1. **Length constraint**: Maximum 90 characters
2. **Trailing period restriction**: Cannot end with a period
3. **Character set**: Only alphanumeric characters, dash, underscores, parentheses, and periods
4. **Non-empty**: Implicitly enforced by `nullable = false` and Terraform's required constraint

Implementation matches the exact validation logic from the provider source code.

### Parent ID Transformation
The `resource_group_name` requires a transformation from name to ID:
- **User provides**: `var.resource_group_name` (e.g., "my-rg")
- **User must also provide**: `var.resource_group_id` (e.g., "/subscriptions/{sub-id}/resourceGroups/my-rg")
- **Module uses**: The `resource_group_id` as `parent_id` in `azapi_header`

This transformation was implemented in Task #1 by creating the `resource_group_id` variable in `migrate_variables.tf`.

## Deferred Work Completion

No deferred work was assigned to this task in `following.md`.

## Edge Case Analysis

### Null Semantics
- `resource_group_name` is Required and `nullable = false`, so null is not a valid value
- The validation blocks will catch invalid values before reaching the API
- The `resource_group_id` variable (created in Task #1) is also `nullable = false`, ensuring the parent_id is always provided

### Boundary Conditions
- **Empty string**: Caught by Terraform's required constraint and the non-empty validation
- **Maximum length (90 characters)**: Explicitly validated
- **Minimum length (1 character)**: Implicit in the non-empty requirement
- **Trailing period**: Explicitly rejected (e.g., "my-rg." is invalid)

### Idempotency
- The `resource_group_name` field is stable and deterministic
- No transformation or ordering concerns
- Direct value-to-value mapping ensures idempotent behavior
- The ID construction in AzAPI is deterministic based on parent_id and name

### Safe References
- `var.resource_group_name` is always available as it's a required field
- No nested access or conditional references needed
- No risk of null pointer exceptions
- The `resource_group_id` must be provided by users alongside `resource_group_name`

### Special Edge Cases
1. **Case sensitivity**: Resource group names in Azure are case-insensitive for lookup but preserve case. The validation doesn't enforce case rules, matching Azure's behavior.
2. **Special characters**: Only specific special characters are allowed (dash, underscore, parentheses, periods)
3. **Reserved names**: No validation for reserved names (Azure API handles this)
4. **Leading/trailing whitespace**: Not explicitly validated, but would fail the character set validation
5. **Multiple consecutive periods**: Allowed by validation (e.g., "my..rg" is valid per regex)
6. **Unicode characters**: Rejected by the alphanumeric-only pattern `[-\w._()]`

### ID Mapping Correctness
The user must ensure that `resource_group_id` matches `resource_group_name`. This is a user responsibility:
```hcl
# User's responsibility to ensure consistency
module "vm" {
  resource_group_name = azurerm_resource_group.example.name
  resource_group_id   = azurerm_resource_group.example.id
}
```

## Checklist

- ✅ Property in correct location (parent_id via resource_group_id, not in body)
- ✅ ForceNew behavior (implicitly handled by parent_id change)
- ✅ All logic EXACTLY replicated from provider (3 validation rules)
- ✅ Validations IMPLEMENTED in variables.tf (not deferred to Azure API)
- ✅ TODO comment added to original field in variables.tf (N/A - not a sensitive field)
- ✅ Hidden fields checked (none found)
- ✅ Deferred work in following.md (N/A - no work deferred)
- ✅ Deferred work from following.md (none assigned to this task)
- ✅ Critical review (null, edge, idempotent, safe refs)
- ✅ Edge Case Analysis in proof
- ✅ Proof created
- ✅ track.md ready to update to Pending for check
- ✅ Self-Review: Added ONLY what Task #2 requires (validations for resource_group_name; parent_id mapping already handled by Task #1)

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-24
**Task:** #2 - resource_group_name

### Validation Results

✅ **ForceNew Logic:** Implicitly handled by parent_id change (resource_group_name is part of resource identifier via parent_id in azapi_header)
✅ **Stable Keys:** N/A - field not in replace_triggers_external_values (correctly handled via parent_id)
✅ **Phase Detection:** Field correctly used to construct parent_id (resource group ID) in azapi_header, not placed in body
✅ **Type Conversion:** String to String, no conversion needed
✅ **Null Handling:** Required field with `nullable = false` correctly enforces non-null constraint
✅ **Validations:** All 3 provider validations exactly replicated in variables.tf:
  1. Maximum length 90 characters
  2. Cannot end with period
  3. Character set restriction (alphanumeric, dash, underscore, parentheses, periods)
✅ **Parent ID Mapping:** Task #1 correctly created `resource_group_id` variable in migrate_variables.tf and mapped to azapi_header.parent_id
✅ **Deferred Work Completion:** No following.md file exists, no deferred work assigned to this task
✅ **Deferred Work Recording:** No deferrals made by this task
✅ **Edge Cases:** Comprehensively analyzed in proof document (null semantics, boundary conditions, idempotency, safe references)

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The resource_group_name field is correctly mapped from an AzureRM argument to the AzAPI parent_id parameter. All provider validations from `resourcegroups.ValidateName` function are precisely replicated in variables.tf. ForceNew behavior is correctly handled implicitly through parent_id change. No deviations, simplifications, or "safer alternatives" were found.

**Status:** APPROVED ✅

---
