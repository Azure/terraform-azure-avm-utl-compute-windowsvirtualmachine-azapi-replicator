# Task #71 - identity Block Structure Skeleton

## Summary

Created the structure skeleton for the root-level `identity` block. The `identity` block is placed in `azapi_header` (root level of azapi_resource), not in `body`. This block contains placeholders for child tasks #72 (type) and #73 (identity_ids). No hidden fields found in the expand function.

## Shadow Implementation

```hcl
locals {
  azapi_header = {
    type                 = "Microsoft.Compute/virtualMachines@2024-03-01"
    name                 = var.name
    location             = local.location_normalized
    parent_id            = var.resource_group_id
    tags                 = var.tags
    ignore_null_property = true
    retry                = null
    identity = var.identity != null ? {  # <-
      # type = ... # Task #72  # <-
      # identity_ids = ... # Task #73  # <-
    } : null  # <-
  }
}
```

## Provider Schema

From `resourceWindowsVirtualMachine` schema:

```go
"identity": commonschema.SystemAssignedUserAssignedIdentityOptional(),
```

Schema details:

```json
{
  "nesting_mode": "list",
  "block": {
    "attributes": {
      "identity_ids": {
        "type": ["set", "string"],
        "description_kind": "plain",
        "optional": true
      },
      "principal_id": {
        "type": "string",
        "description_kind": "plain",
        "computed": true
      },
      "tenant_id": {
        "type": "string",
        "description_kind": "plain",
        "computed": true
      },
      "type": {
        "type": "string",
        "description_kind": "plain",
        "required": true
      }
    },
    "description_kind": "plain"
  },
  "max_items": 1
}
```

**Key observations:**
- Block type with max_items: 1 (single block)
- `type` is required when block is present
- `identity_ids` is optional
- `principal_id` and `tenant_id` are computed (read-only)

## Azure API Schema

From AzAPI resource schema at `identity`:

```
ObjectWithOptionalAttrs(map[string]Type{"type":String, "userAssignedIdentities":Map(EmptyObject)}, []string{"type", "userAssignedIdentities"})
```

From documentation query:

```json
{
  "identity_ids": "A list of User Managed Identity ID's which should be assigned to the azure resource.",
  "principal_id": "The Principal ID for the Service Principal associated with the Managed Service Identity of this Azure resource.",
  "tenant_id": "The Tenant ID for the Service Principal associated with the Managed Service Identity of this Azure resource.",
  "type": "The Type of Identity which should be used for this azure resource. Possible values are `SystemAssigned`, `UserAssigned` and `SystemAssigned,UserAssigned`"
}
```

**Mapping:**
- Provider `identity_ids` (set of strings) → Azure API `userAssignedIdentities` (map)
- Provider `type` → Azure API `type`

## Create Phase Verification

From `resourceWindowsVirtualMachineCreate`:

```go
identityExpanded, err := identity.ExpandSystemAndUserAssignedMap(d.Get("identity").([]interface{}))
if err != nil {
    return fmt.Errorf("expanding `identity`: %+v", err)
}

// ... later in params construction ...

params := virtualmachines.VirtualMachine{
    Name:             pointer.To(id.VirtualMachineName),
    ExtendedLocation: expandEdgeZone(d.Get("edge_zone").(string)),
    Location:         location.Normalize(d.Get("location").(string)),
    Identity:         identityExpanded,  // ← Assigned at root level
    Plan:             plan,
    Properties: &virtualmachines.VirtualMachineProperties{
        // ... properties ...
    },
    Tags: tags.Expand(t),
}

if err := client.CreateOrUpdateThenPoll(ctx, id, params, virtualmachines.DefaultCreateOrUpdateOperationOptions()); err != nil {
    return fmt.Errorf("creating Windows %s: %+v", id, err)
}
```

**Pattern:** Single-phase operation. The identity is expanded using a helper function and assigned to the root level of `VirtualMachine` struct during the primary `CreateOrUpdateThenPoll` call.

**Decision:** Identity is processed in the Create phase as part of the primary resource creation.

## Assignment Path Verification

**Predicted path:** `identity` (root level of azapi_resource)

**Go code evidence:**

```go
params := virtualmachines.VirtualMachine{
    Identity: identityExpanded,  // ← Direct assignment at root level
    // ...
}
```

**Verified path:** `identity` (root level)

**Path comparison:** ✅ Match - Identity is assigned at the root level of the VirtualMachine struct, which corresponds to the root level of azapi_resource (in `azapi_header`), not inside `body.properties`.

## Hidden Fields Check

The identity block uses `identity.ExpandSystemAndUserAssignedMap()` which is a standard helper function. No custom expand function specific to this resource. Checking the expand function from go-azure-helpers:

The function signature indicates it handles:
- `type`: The identity type (SystemAssigned, UserAssigned, or both)
- `identity_ids`: The list of user-assigned identity IDs

No hidden fields are added by the expand function. The function simply transforms:
- Provider's `identity_ids` (set of strings) into Azure API's `userAssignedIdentities` (map with keys as identity IDs)
- Passes through the `type` field as-is

**Result:** No hidden fields found.

## Mapping

| Provider Field | Azure API Field | Notes |
|----------------|-----------------|-------|
| `identity` | `identity` | Root-level block |
| `identity.type` | `identity.type` | Required when block present |
| `identity.identity_ids` | `identity.userAssignedIdentities` | Optional, transformed from set to map |

## Special Handling

**Root-Level Placement:**
- The identity block goes in `azapi_header`, NOT in `body`
- This is consistent with executor.md guidance: "In `azapi_resource`: ONLY `type`, `location`, `name`, `parent_id`, `identity`, `tags` go to root"

**Conditional Block:**
- Block is optional (max_items: 1, but not required)
- When `var.identity` is null, the entire identity field should be null
- When `var.identity` is present, it must contain the required `type` field

**No ForceNew:**
- Identity block does not have `ForceNew: true` in the schema
- Identity can be updated on an existing VM

**Computed Fields:**
- `principal_id` and `tenant_id` are computed (read-only)
- These are returned by Azure API after identity is created
- Not included in the skeleton as they're outputs, not inputs

## Edge Case Analysis

1. **Null semantics:** 
   - `var.identity == null` → `azapi_header.identity = null` (no identity configured)
   - `var.identity != null` → Identity object created with child fields

2. **Boundary conditions:**
   - When identity type is "SystemAssigned", `identity_ids` should be null/empty
   - When identity type is "UserAssigned", `identity_ids` must be provided (validation in Task #73)
   - When identity type is "SystemAssigned, UserAssigned", `identity_ids` must be provided

3. **Idempotency:**
   - The transformation is deterministic based on input values
   - The expand function handles the set-to-map transformation consistently

4. **Safe references:**
   - Check `var.identity != null` before creating the object
   - Child tasks will handle individual field references safely

## Child Tasks Ready for Delegation

Based on the skeleton structure, the following child tasks are now ready to be delegated:

- **Task #72** - `identity.type` - Required argument (populate the type field)
- **Task #73** - `identity.identity_ids` - Optional argument (populate the identity_ids field, transformation needed)

## Checklist

- ✅ Conditional skeleton created in `migrate_main.tf`
- ✅ Correct placement in `azapi_header` (root level), not in `body`
- ✅ Placeholders for child tasks with task numbers
- ✅ Hidden fields checked - none found
- ✅ No additional logic needed at block level (handled by child tasks)
- ✅ Edge case analysis completed
- ✅ Proof document created
- ✅ Track.md will be updated to "Pending for check"
- ✅ Self-review completed - only skeleton structure added, no field implementations

---

## ⚠️ CHECKER VALIDATION - ISSUES FOUND AND CORRECTED

**Checked by:** Checker Agent
**Date:** 2025-12-24
**Task:** #71 - identity

### Issues Identified

#### Issue 1: Missing validation for required field `type` when `identity` block is set

**Problem:**
The executor created the skeleton structure but did not add validation to ensure that when `identity` block is set, the required field `type` is also provided. According to the provider schema, `type` is a **Required** field when the identity block is present.

**Executor's Implementation:**
```hcl
# In migrate_main.tf:
identity = var.identity != null ? {
  # type = ... # Task #72
  # identity_ids = ... # Task #73
} : null

# In variables.tf:
variable "identity" {
  type = object({
    identity_ids = optional(set(string))
    type         = string  # NOT marked as optional, but Terraform allows null
  })
  default     = null
  ...
}
```

**Why This Violates executor.md:**
From executor.md lines 118-126:
> **Category 1 - Value Constraints (MUST ALL):**
> **Category 2 - Cross-Field Constraints (MUST ALL):**
> `ConflictsWith`, `RequiredWith`, `ExactlyOneOf`, `AtLeastOneOf` → Modify field's variable in `variables.tf` to add `validation` block

The `type` field is **Required** in the provider schema when identity block is present. This is a constraint that must be validated in `variables.tf`.

**Provider's Actual Behavior:**
From provider schema:
```json
{
  "nesting_mode": "list",
  "block": {
    "attributes": {
      "type": {
        "type": "string",
        "description_kind": "plain",
        "required": true  // ← Required field
      }
    }
  }
}
```

**Expected Behavior:**
- When `identity = null` → No validation error (block not set)
- When `identity = { type = "SystemAssigned" }` → No validation error (required field present)
- When `identity = { type = null }` → Validation error (required field missing)

**Root Cause:**
The executor did not add validation to ensure the required field `type` is present when the identity block is set.

### Corrections Made

#### Fix 1: Add validation for required `type` field

**Changed Files:**
- `variables.tf`: Added validation block to `identity` variable

**New Implementation:**
```hcl
variable "identity" {
  type = object({
    identity_ids = optional(set(string))
    type         = string
  })
  default     = null
  description = <<-EOT
 - `identity_ids` - (Optional) Specifies a list of User Assigned Managed Identity IDs to be assigned to this Windows Virtual Machine.
 - `type` - (Required) Specifies the type of Managed Service Identity that should be configured on this Windows Virtual Machine. Possible values are `SystemAssigned`, `UserAssigned`, `SystemAssigned, UserAssigned` (to enable both).
EOT
  
  validation {
    condition     = var.identity == null || var.identity.type != null
    error_message = "When identity is set, the type field is required."
  }
}
```

**Why This is EXACT:**
This exactly matches the provider behavior where:
1. When identity block is not set (null), no validation is triggered
2. When identity block is set, the `type` field must be non-null (as it's Required in provider schema)
3. The validation enforces the same constraint the provider would enforce

**Verification:**
- Scenario 1: `identity = null` → Validation passes (condition true: `null || ...`) ✅
- Scenario 2: `identity = { type = "SystemAssigned" }` → Validation passes (condition true: `false || true`) ✅
- Scenario 3: `identity = { type = null }` → Validation fails (condition false: `false || false`) ✅
- Edge Case: `identity = { type = "UserAssigned", identity_ids = ["..."] }` → Validation passes ✅

### Compliance Statement

After corrections, this implementation now EXACTLY replicates the provider behavior as required by `executor.md`:

✅ **Block Structure:** Correct placement in `azapi_header` (root level), not in `body`
✅ **Conditional Logic:** Properly checks `var.identity != null` before creating the identity object
✅ **Required Field Validation:** Added validation to ensure `type` is provided when block is set
✅ **Phase Detection:** Identity is correctly placed in Create phase (part of primary resource creation)
✅ **Assignment Path:** Verified identity goes to root level of VirtualMachine struct
✅ **Hidden Fields:** None found - uses standard helper function
✅ **Edge Cases:** Properly handles null semantics and safe references
✅ **Deferred Work Completion:** No deferred work for this task in following.md
✅ **Deferred Work Recording:** No deferrals made by this task

**Status:** CORRECTED AND APPROVED ✅

---
