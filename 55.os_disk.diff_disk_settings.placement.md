# Task #55 - os_disk.diff_disk_settings.placement

## Summary

Implemented `os_disk.diff_disk_settings.placement` as an optional nested block argument with ForceNew behavior and a default value of "CacheDisk". The field specifies where ephemeral OS disk should be placed (CacheDisk, ResourceDisk, or NvmeDisk).

## Shadow Implementation

```hcl
# variables.tf
variable "os_disk" {
  type = object({
    # ... other fields ...
    diff_disk_settings = optional(object({
      option    = string
      placement = optional(string, "CacheDisk")  # <- Default value applied here
    }))
  })
  # ... other config ...
  
  validation {  # <-
    condition = var.os_disk.diff_disk_settings == null || var.os_disk.diff_disk_settings.placement == null || contains([  # <-
      "CacheDisk",  # <-
      "ResourceDisk",  # <-
      "NvmeDisk"  # <-
    ], var.os_disk.diff_disk_settings.placement)  # <-
    error_message = "os_disk.diff_disk_settings.placement must be one of: CacheDisk, ResourceDisk, NvmeDisk."  # <-
  }  # <-
}

# migrate_main.tf
locals {
  replace_triggers_external_values = {
    # ... other fields ...
    os_disk_diff_disk_settings_placement = { value = var.os_disk.diff_disk_settings != null ? var.os_disk.diff_disk_settings.placement : null }  # <-
  }
  
  body = merge(
    {
      properties = merge(
        {
          storageProfile = merge(
            {
              osDisk = merge(
                var.os_disk.diff_disk_settings != null ? {
                  diffDiskSettings = {
                    option = var.os_disk.diff_disk_settings.option
                    placement = var.os_disk.diff_disk_settings.placement  # <-
                  }
                } : {},
                # ... other fields ...
              )
            },
            # ... other fields ...
          )
        },
        # ... other fields ...
      )
    },
    # ... other fields ...
  )
}
```

## Create Phase Verification

**Query Result:** Queried `resourceWindowsVirtualMachineCreate` function.

**Pattern:** Single-phase - one `CreateOrUpdateThenPoll` operation.

**Evidence from Create method:**
```go
params := virtualmachines.VirtualMachine{
	// ... other fields ...
	Properties: &virtualmachines.VirtualMachineProperties{
		StorageProfile: &virtualmachines.StorageProfile{
			// ... other fields ...
		},
	},
	// ... other fields ...
}
osDiskRaw := d.Get("os_disk").([]interface{})
osDisk, err := expandVirtualMachineOSDisk(osDiskRaw, virtualmachines.OperatingSystemTypesWindows)
if err != nil {
	return fmt.Errorf("expanding `os_disk`: %+v", err)
}
// ... other code ...
params.Properties.StorageProfile.OsDisk = osDisk
```

**Classification:** The field is part of the `os_disk` block, which is expanded in `expandVirtualMachineOSDisk` and assigned to `params.Properties.StorageProfile.OsDisk` **before** the primary `CreateOrUpdateThenPoll` call. This is Create phase.

**Decision:** Implement in `local.body` (not post-creation).

## Assignment Path Verification

**Predicted Path:** `body.properties.storageProfile.osDisk.diffDiskSettings.placement`

**Go Code Evidence:**

From `expandVirtualMachineOSDisk`:
```go
func expandVirtualMachineOSDisk(input []interface{}, osType virtualmachines.OperatingSystemTypes) (*virtualmachines.OSDisk, error) {
	raw := input[0].(map[string]interface{})
	// ...
	disk := virtualmachines.OSDisk{
		// ... other fields ...
	}
	
	if diffDiskSettingsRaw := raw["diff_disk_settings"].([]interface{}); len(diffDiskSettingsRaw) > 0 {
		// ...
		diffDiskRaw := diffDiskSettingsRaw[0].(map[string]interface{})
		disk.DiffDiskSettings = &virtualmachines.DiffDiskSettings{
			Option:    pointer.To(virtualmachines.DiffDiskOptions(diffDiskRaw["option"].(string))),
			Placement: pointer.To(virtualmachines.DiffDiskPlacement(diffDiskRaw["placement"].(string))),
		}
	}
	// ...
	return &disk, nil
}
```

From Create method:
```go
osDisk, err := expandVirtualMachineOSDisk(osDiskRaw, virtualmachines.OperatingSystemTypesWindows)
// ...
params.Properties.StorageProfile.OsDisk = osDisk
```

**Tracing:**
1. `diffDiskRaw["placement"]` → `disk.DiffDiskSettings.Placement` (in expandVirtualMachineOSDisk)
2. Return `&disk` → assigned to `osDisk`
3. `osDisk` → `params.Properties.StorageProfile.OsDisk`
4. `params` is sent to API as request body

**Verified Path:** `properties.storageProfile.osDisk.diffDiskSettings.placement`

**Path Comparison:** ✅ Match (predicted path matches verified path)

## Provider Schema

**Source:** `virtualMachineOSDiskSchema()` function in azurerm provider

```go
"diff_disk_settings": {
	Type:     pluginsdk.TypeList,
	Optional: true,
	ForceNew: true,
	MaxItems: 1,
	Elem: &pluginsdk.Resource{
		Schema: map[string]*pluginsdk.Schema{
			"option": {
				Type:     pluginsdk.TypeString,
				Required: true,
				ForceNew: true,
				ValidateFunc: validation.StringInSlice([]string{
					string(virtualmachines.DiffDiskOptionsLocal),
				}, false),
			},
			"placement": {
				Type:     pluginsdk.TypeString,
				Optional: true,
				ForceNew: true,
				Default:  string(virtualmachines.DiffDiskPlacementCacheDisk),
				ValidateFunc: validation.StringInSlice([]string{
					string(virtualmachines.DiffDiskPlacementCacheDisk),
					string(virtualmachines.DiffDiskPlacementResourceDisk),
					string(virtualmachines.DiffDiskPlacementNvmeDisk),
				}, false),
			},
		},
	},
	ConflictsWith: []string{
		"os_managed_disk_id",
	},
},
```

**Key Attributes:**
- **Type:** `TypeString`
- **Optional:** `true`
- **ForceNew:** `true`
- **Default:** `"CacheDisk"` (enum value `virtualmachines.DiffDiskPlacementCacheDisk`)
- **ValidateFunc:** `StringInSlice` with values: `CacheDisk`, `ResourceDisk`, `NvmeDisk`

## Azure API Schema

**Resource Type:** `Microsoft.Compute/virtualMachines@2024-03-01`

**Property Path:** `body.properties.storageProfile.osDisk.diffDiskSettings.placement`

**Type:** `String`

**Description:** "Specifies the ephemeral disk placement for operating system disk. Possible values are: **CacheDisk,** **ResourceDisk,** **NvmeDisk.** The defaulting behavior is: **CacheDisk** if one is configured for the VM size otherwise **ResourceDisk** or **NvmeDisk** is used. Refer to the VM size documentation for Windows VM at https://docs.microsoft.com/azure/virtual-machines/windows/sizes and Linux VM at https://docs.microsoft.com/azure/virtual-machines/linux/sizes to check which VM sizes exposes a cache disk. Minimum api-version for NvmeDisk: 2024-03-01. (Possible values: CacheDisk,ResourceDisk,NvmeDisk)"

## Hidden Fields

None - this is an explicit schema field with no hidden transformations.

## Mapping

**Terraform (snake_case):** `placement`  
**Azure API (camelCase):** `placement`

Note: This field name is the same in both Terraform and Azure API (no case conversion needed).

## Special Handling

### 1. Validation

**Validation Block Added to variables.tf:**
```hcl
validation {
  condition = var.os_disk.diff_disk_settings == null || var.os_disk.diff_disk_settings.placement == null || contains([
    "CacheDisk",
    "ResourceDisk",
    "NvmeDisk"
  ], var.os_disk.diff_disk_settings.placement)
  error_message = "os_disk.diff_disk_settings.placement must be one of: CacheDisk, ResourceDisk, NvmeDisk."
}
```

**Evidence:** Provider schema includes `validation.StringInSlice` with the three possible values.

### 2. Default Value

**Implementation:** Used nested `optional()` syntax in variables.tf:
```hcl
placement = optional(string, "CacheDisk")
```

**Evidence:** Provider schema shows `Default: string(virtualmachines.DiffDiskPlacementCacheDisk)` which maps to "CacheDisk".

**Rationale:** This is a nested field within an optional object, making `optional(string, "CacheDisk")` the preferred approach per executor.md guidelines.

### 3. ForceNew Behavior

**Implementation:** Added to `replace_triggers_external_values`:
```hcl
os_disk_diff_disk_settings_placement = { value = var.os_disk.diff_disk_settings != null ? var.os_disk.diff_disk_settings.placement : null }
```

**Evidence:** Provider schema shows `ForceNew: true` for the placement field.

**Mode:** Mode 1 - Direct Value Tracking (wrapping in object with stable key). The field tracks the full value to detect any changes in placement value.

### 4. Null Semantics

**Parent Block Conditional:** The placement field is only included when `var.os_disk.diff_disk_settings != null`, ensuring the entire `diffDiskSettings` block is omitted when not configured.

**Default Handling:** When `diff_disk_settings` is set but `placement` is not explicitly provided, the default value "CacheDisk" is used (via `optional(string, "CacheDisk")`).

## Deferred Work Completion

Checked `following.md` - no work was deferred to Task #55.

## Edge Case Analysis

### 1. Null Semantics
- **When parent block is null:** The entire `diffDiskSettings` block is omitted from the API request, which is correct.
- **When placement is null but parent is set:** The default value "CacheDisk" applies via the `optional(string, "CacheDisk")` type definition.
- **Provider behavior:** Provider applies the same default "CacheDisk" when placement is not specified.

### 2. ForceNew Tracking
- **Full value tracking:** The `replace_triggers_external_values` tracks the complete placement value, not just presence.
- **Detects changes:** null → "CacheDisk", "CacheDisk" → "ResourceDisk", "ResourceDisk" → null, etc.
- **Stable key:** The key `os_disk_diff_disk_settings_placement` is always present in the map (value may be null).

### 3. Validation Edge Cases
- **Empty string:** Validation allows null or valid enum values only. Empty string would fail validation.
- **Case sensitivity:** Azure API expects exact case (e.g., "CacheDisk" not "cachedisk"). Validation enforces exact case match.
- **Invalid values:** Any value not in [CacheDisk, ResourceDisk, NvmeDisk] is rejected at plan time.

### 4. Default Value Application
- **When not specified:** User doesn't set placement → default "CacheDisk" applies → sent to API.
- **When explicitly set to "CacheDisk":** User sets placement = "CacheDisk" → same value sent to API.
- **Idempotency:** Both cases produce the same API request, maintaining idempotency.

### 5. Parent Block Dependency
- **Safe reference:** Code checks `var.os_disk.diff_disk_settings != null` before accessing placement.
- **No errors:** If parent block is null, placement access is never attempted.

### 6. API Version Compatibility
- **NvmeDisk support:** Azure API documentation notes "Minimum api-version for NvmeDisk: 2024-03-01".
- **Current API version:** Using `Microsoft.Compute/virtualMachines@2024-03-01` which supports all three values.
- **Validation alignment:** Validation allows NvmeDisk, matching API version capabilities.

## Checklist

- ✅ Property in correct local (`local.body`)
- ✅ ForceNew wrapped: `{ value = ... }` in `replace_triggers_external_values`
- ✅ ALL logic EXACTLY replicated from provider (default value, validation, ForceNew)
- ✅ Validations IMPLEMENTED in variables.tf (enum validation added)
- ✅ TODO comment added to original field in variables.tf (N/A - not a sensitive field migration)
- ✅ Hidden fields checked (none)
- ✅ Deferred work in following.md (N/A - no work deferred to other tasks)
- ✅ Deferred work from following.md (checked - no work was deferred to this task)
- ✅ Critical review (null, edge, idempotent, safe refs)
- ✅ Edge Case Analysis in proof (completed above)
- ✅ Proof created (this document)
- ✅ `track.md` updated to Pending for check (next step)
- ✅ Self-Review: Implementation adds only what Task #55 requires (placement field within diff_disk_settings)

---

## ⚠️ CHECKER VALIDATION - ISSUES FOUND AND CORRECTED

**Checked by:** Checker Agent
**Date:** 2025-12-24
**Task:** #55 - os_disk.diff_disk_settings.placement

### Issues Identified

#### Issue 1: Redundant Null Check in Validation Condition

**Problem:**
The validation condition included an unnecessary null check for the `placement` field:

```hcl
condition = var.os_disk.diff_disk_settings == null || var.os_disk.diff_disk_settings.placement == null || contains([...], var.os_disk.diff_disk_settings.placement)
```

The middle condition `var.os_disk.diff_disk_settings.placement == null` is redundant and potentially problematic.

**Why This Violates executor.md:**

1. **Default Value Guarantee**: The field is defined as `placement = optional(string, "CacheDisk")`, which means when the parent block `diff_disk_settings` exists, the `placement` field is **GUARANTEED** to be non-null (either user-provided or the default "CacheDisk")

2. **Provider Schema Evidence**: Provider schema shows:
   ```go
   "placement": {
       Type:     pluginsdk.TypeString,
       Optional: true,
       ForceNew: true,
       Default:  string(virtualmachines.DiffDiskPlacementCacheDisk),
       ValidateFunc: validation.StringInSlice([...], false),
   }
   ```
   
   The presence of `Default:` means the field always has a value when its parent block exists.

3. **Inconsistency with Task #54**: Task #54 implemented validation for `option` field (also in `diff_disk_settings`) without the extra null check:
   ```hcl
   condition = var.os_disk.diff_disk_settings == null || contains(["Local"], var.os_disk.diff_disk_settings.option)
   ```
   
   Task #55 should follow the same pattern.

4. **Allows Invalid State**: The extra null check would allow `placement = null` to pass validation, which contradicts the default value behavior and could lead to confusion.

**Executor's Implementation:**
```hcl
condition = var.os_disk.diff_disk_settings == null || var.os_disk.diff_disk_settings.placement == null || contains([
  "CacheDisk",
  "ResourceDisk",
  "NvmeDisk"
], var.os_disk.diff_disk_settings.placement)
```

**Why This is EXACT Behavior Mismatch:**
- Provider applies default "CacheDisk" when placement not specified
- With default value via `optional(string, "CacheDisk")`, placement cannot be null when parent exists
- Extra null check creates impossible condition and inconsistency with provider behavior

**Root Cause:**
Executor added defensive null check that doesn't match the type system guarantee from the `optional(type, default)` modifier.

### Corrections Made

#### Fix 1: Remove Redundant Null Check

**Changed Files:**
- `variables.tf`: Updated validation block for os_disk (lines 210-217)

**New Implementation:**
```hcl
validation {
  condition = var.os_disk.diff_disk_settings == null || contains([
    "CacheDisk",
    "ResourceDisk",
    "NvmeDisk"
  ], var.os_disk.diff_disk_settings.placement)
  error_message = "os_disk.diff_disk_settings.placement must be one of: CacheDisk, ResourceDisk, NvmeDisk."
}
```

**Why This is EXACT:**

1. **Matches Type Guarantee**: When `diff_disk_settings != null`, the `optional(string, "CacheDisk")` modifier guarantees `placement` is non-null
2. **Consistent with Task #54**: Follows the exact same pattern used for the `option` field
3. **Provider Behavior Match**: Validates only enum values, just like provider's `StringInSlice` validation
4. **No Redundancy**: Removes impossible condition that contradicts the type system

**Verification:**
- Scenario 1: `diff_disk_settings = null` → ✅ Validation passes (no constraint)
- Scenario 2: `diff_disk_settings = { option = "Local" }` (placement not specified) → `placement = "CacheDisk"` (default) → ✅ Validation passes (valid enum)
- Scenario 3: `diff_disk_settings = { option = "Local", placement = "ResourceDisk" }` → ✅ Validation passes (valid enum)
- Scenario 4: `diff_disk_settings = { option = "Local", placement = "InvalidValue" }` → ❌ Validation fails with clear error
- Edge Case: User cannot set `placement = null` explicitly due to type constraint, so the null check was protecting against an impossible state

### Compliance Statement

After corrections, this implementation now EXACTLY replicates the provider behavior as required by `executor.md`. The validation correctly enforces enum values without redundant null checks, matching both the type system guarantees and the provider's validation logic.

**Status:** CORRECTED AND APPROVED ✅

---
