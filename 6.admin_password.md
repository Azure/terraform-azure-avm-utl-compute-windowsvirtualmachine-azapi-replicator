# Task #6: admin_password

## Summary

Converted the `admin_password` argument from `azurerm_windows_virtual_machine` to `azapi_resource`. This field is Optional, ForceNew, Sensitive (WriteOnly), and has a `DiffSuppressFunc` that suppresses diffs when the value equals "ignored-as-imported" (special case for imported resources). Implemented all validations from the provider and properly tracked the field in `sensitive_body` with version-based replacement triggers.

## Shadow Implementation

```hcl
# variables.tf
variable "admin_password" {
  type        = string
  description = "(Optional) The Password which should be used for the local-administrator on this Virtual Machine. Changing this forces a new resource to be created."
  nullable    = false
  ephemeral   = true  # <-

  validation {  # <-
    condition     = var.admin_password == null || can(regex("^.{8,123}$", var.admin_password))
    error_message = "The admin_password must be between 8 and 123 characters."
  }

  validation {  # <-
    condition = var.admin_password == null || !contains([
      "abc@123", "P@$$w0rd", "P@ssw0rd", "P@ssword123", "Pa$$word",
      "pass@word1", "Password!", "Password1", "Password22", "iloveyou!"
    ], var.admin_password)
    error_message = "The admin_password cannot be one of the following disallowed values: abc@123, P@$$w0rd, P@ssw0rd, P@ssword123, Pa$$word, pass@word1, Password!, Password1, Password22, iloveyou!"
  }

  validation {  # <-
    condition = var.admin_password == null || (
      length(regexall("[a-z]", var.admin_password)) > 0 ? 1 : 0
      ) + (length(regexall("[A-Z]", var.admin_password)) > 0 ? 1 : 0
      ) + (length(regexall("[0-9]", var.admin_password)) > 0 ? 1 : 0
      ) + (length(regexall("[^\\w]", var.admin_password)) > 0 ? 1 : 0
    ) >= 3
    error_message = "The admin_password must fulfill 3 out of these 4 conditions: Has lower characters, Has upper characters, Has a digit, Has a special character (Regex match [\\W_])."
  }
}

# migrate_variables.tf
variable "admin_password_version" {  # <-
  type        = number
  default     = null
  description = "Version number for admin_password to trigger replacement when changed. Must be set when admin_password is provided."

  validation {  # <-
    condition     = var.admin_password == null || var.admin_password_version != null
    error_message = "When admin_password is set, admin_password_version must also be set."
  }
}

# migrate_main.tf
data "azapi_resource" "existing" {  # <-
  type                   = "Microsoft.Compute/virtualMachines@2024-03-01"
  name                   = var.name
  parent_id              = var.resource_group_id
  ignore_not_found       = true
  response_export_values = ["*"]
}

locals {
  replace_triggers_external_values = {
    name                      = { value = var.name }
    location                  = { value = local.location_normalized }
    admin_password_version    = { value = var.admin_password_version }  # <-
  }
  
  should_read_existing_admin_password = var.admin_password != null  # <-
  
  existing_admin_password = local.should_read_existing_admin_password && data.azapi_resource.existing.exists ? try(data.azapi_resource.existing.output.properties.osProfile.adminPassword, null) : null  # <-
  
  admin_password_should_suppress = (  # <-
    (local.existing_admin_password == "ignored-as-imported" || var.admin_password == "ignored-as-imported")
  )
  
  effective_admin_password = local.admin_password_should_suppress ? coalesce(local.existing_admin_password, var.admin_password) : var.admin_password  # <-

  sensitive_body = {
    properties = merge(
      var.admin_password != null ? {  # <-
        osProfile = {
          adminPassword = local.effective_admin_password  # <-
        }
      } : {}
    )
  }
  sensitive_body_version = {
    "properties.osProfile.adminPassword" = try(tostring(var.admin_password_version), "null")  # <-
  }
}
```

## Create Phase Verification

**Query Result:** The `resourceWindowsVirtualMachineCreate` function shows a single-phase creation pattern:

```go
func resourceWindowsVirtualMachineCreate(d *pluginsdk.ResourceData, meta interface{}) error {
	client := meta.(*clients.Client).Compute.VirtualMachinesClient
	// ... setup code ...
	
	// Field assignment - only when NOT using os_managed_disk_id (imported disk)
	osDiskIsImported := managedDiskIdRaw != ""
	
	if !osDiskIsImported {
		params.Properties.OsProfile = &virtualmachines.OSProfile{
			AdminPassword:            pointer.To(d.Get("admin_password").(string)),
			AdminUsername:            pointer.To(d.Get("admin_username").(string)),
			ComputerName:             pointer.To(computerName),
			AllowExtensionOperations: pointer.To(allowExtensionOperations),
			WindowsConfiguration: &virtualmachines.WindowsConfiguration{
				// ...
			},
			Secrets: secrets,
		}
		// ... additional OS profile configuration ...
	}
	
	// Single CreateOrUpdate operation
	if err := client.CreateOrUpdateThenPoll(ctx, id, params, virtualmachines.DefaultCreateOrUpdateOperationOptions()); err != nil {
		return fmt.Errorf("creating Windows %s: %+v", id, err)
	}
	
	d.SetId(id.ID())
	return resourceWindowsVirtualMachineRead(d, meta)
}
```

**Pattern:** Single-phase creation - one `CreateOrUpdateThenPoll` operation.

**Field Classification:** The `admin_password` field is set BEFORE the primary `CreateOrUpdateThenPoll` call, so it belongs in the Create phase.

**Decision:** Implement in `local.sensitive_body` (not post-creation operations).

## Assignment Path Verification

**Predicted Path:** `properties.osProfile.adminPassword`

**Go Code Evidence:**
```go
params.Properties.OsProfile = &virtualmachines.OSProfile{
	AdminPassword:            pointer.To(d.Get("admin_password").(string)),
	// ...
}

// Later assigned to:
params := virtualmachines.VirtualMachine{
	Properties: &virtualmachines.VirtualMachineProperties{
		// ... other properties ...
		// OsProfile is assigned above conditionally
	},
}
```

**Assignment Chain:**
1. `d.Get("admin_password").(string)` → value from Terraform state
2. `pointer.To(...)` → wraps in pointer
3. `AdminPassword` field in `OSProfile` struct
4. `OSProfile` assigned to `Properties.OsProfile`
5. `Properties` assigned to `VirtualMachine.Properties`

**Verified Path:** `properties.osProfile.adminPassword`

**Path Comparison:** ✅ Match - predicted path matches verified path.

## Provider Schema

**Source:** `resourceWindowsVirtualMachine()` schema definition:

```go
"admin_password": {
	Type:             pluginsdk.TypeString,
	Optional:         true,
	ForceNew:         true,
	Sensitive:        true,
	DiffSuppressFunc: adminPasswordDiffSuppressFunc,
	RequiredWith: []string{
		"admin_username",
	},
	ConflictsWith: []string{
		"os_managed_disk_id",
	},
	ValidateFunc: computeValidate.WindowsAdminPassword,
},
```

**DiffSuppressFunc Implementation:**
```go
func adminPasswordDiffSuppressFunc(_, old, new string, _ *pluginsdk.ResourceData) bool {
	// this is not the greatest hack in the world, this is just a tribute.
	if old == "ignored-as-imported" || new == "ignored-as-imported" {
		return true
	}

	return false
}
```

**Validation Function:**
```go
func WindowsAdminPassword(i interface{}, k string) (warnings []string, errors []error) {
	v, ok := i.(string)
	if !ok {
		errors = append(errors, fmt.Errorf("expected %q to be a string but it wasn't", k))
		return warnings, errors
	}

	if strings.TrimSpace(v) == "" {
		errors = append(errors, fmt.Errorf("%q must not be empty", k))
		return warnings, errors
	}

	// Min-length is 8 characters and Max-length is 123 characters.
	if len(v) < 8 || len(v) > 123 {
		errors = append(errors, fmt.Errorf("%q most be between %d and %d characters, got %d", k, 8, 123, len(v)))
	}

	// Cannot match disallowed names
	disallowedNames := []string{"abc@123", "P@$$w0rd", "P@ssw0rd", "P@ssword123", "Pa$$word", "pass@word1", "Password!", "Password1", "Password22", "iloveyou!"}
	for _, value := range disallowedNames {
		if value == v {
			errors = append(errors, fmt.Errorf("%q specified is not allowed, got %q, cannot match: %q", k, v, strings.Join(disallowedNames, ", ")))
		}
	}

	// Must fulfill 3 out of 4 conditions: Has lower characters, Has upper characters, Has a digit, Has a special character (Regex match [\W_])
	conditions := 0
	tests := []string{"[a-z]", "[A-Z]", "[0-9]", "[^\\d\\w]"}
	for _, test := range tests {
		t, _ := regexp.MatchString(test, v)
		if t {
			conditions++
		}
	}
	if conditions < 3 {
		errors = append(errors, fmt.Errorf("%q has to fulfill 3 out of these 4 conditions: Has lower characters, Has upper characters, Has a digit, Has a special character other than \"_\", fullfiled only %d conditions", k, conditions))
	}

	return warnings, errors
}
```

**Key Properties:**
- **Type:** String
- **Optional:** true
- **ForceNew:** true (changing this forces resource recreation)
- **Sensitive:** true (marked sensitive in provider)
- **DiffSuppressFunc:** Suppresses diff when value equals "ignored-as-imported"
- **RequiredWith:** Must be specified together with `admin_username`
- **ConflictsWith:** Cannot be used with `os_managed_disk_id`
- **ValidateFunc:** `WindowsAdminPassword` - validates length, disallowed values, complexity

## Azure API Schema

**Field Path:** `properties.osProfile.adminPassword`

**API Documentation:**
```
"adminPassword":"Specifies the password of the administrator account. <br><br> **Minimum-length (Windows):** 8 characters <br><br> **Minimum-length (Linux):** 6 characters <br><br> **Max-length (Windows):** 123 characters <br><br> **Max-length (Linux):** 72 characters <br><br> **Complexity requirements:** 3 out of 4 conditions below need to be fulfilled <br> Has lower characters <br>Has upper characters <br> Has a digit <br> Has a special character (Regex match [\\W_]) <br><br> **Disallowed values:** \"abc@123\", \"P@$$w0rd\", \"P@ssw0rd\", \"P@ssword123\", \"Pa$$word\", \"pass@word1\", \"Password!\", \"Password1\", \"Password22\", \"iloveyou!\" <br><br> For resetting the password, see [How to reset the Remote Desktop service or its login password in a Windows VM](https://docs.microsoft.com/troubleshoot/azure/virtual-machines/reset-rdp) <br><br> For resetting root password, see [Manage users, SSH, and check or repair disks on Azure Linux VMs using the VMAccess Extension](https://docs.microsoft.com/troubleshoot/azure/virtual-machines/troubleshoot-ssh-connection)"
```

**Field Type:** String (WriteOnly)

**Characteristics:**
- **WriteOnly:** Yes - password is not returned in API responses
- **Validation:** Min 8 chars, Max 123 chars (Windows), complexity requirements, disallowed values

## Hidden Fields

No hidden fields detected. The `admin_password` is directly controlled by the user-provided variable.

## Mapping

| AzureRM Field | Azure API Field | Notes |
|---------------|-----------------|-------|
| `admin_password` | `properties.osProfile.adminPassword` | Direct mapping, WriteOnly field |

## Special Handling

### 1. Sensitive/WriteOnly Field

The field is marked as `Sensitive: true` in the provider schema and is WriteOnly in the Azure API (never returned in responses). Following the executor.md rules for root-level sensitive fields:

**Implementation:**
- Modified the existing `admin_password` variable in `variables.tf` to add `ephemeral = true` and removed `sensitive = true`
- Created `admin_password_version` variable in `migrate_variables.tf` with validation requiring it when password is set
- Placed the field in `sensitive_body` (not `body`)
- Tracked changes via `sensitive_body_version` map with the version variable

### 2. ForceNew Behavior

The schema has `ForceNew: true`, meaning changes to this field require resource recreation.

**Implementation:**
- Added `admin_password_version` to `replace_triggers_external_values` map
- Used the version variable (not the password itself) to avoid exposing sensitive data in triggers
- Key is always present with wrapped value for stability

### 3. DiffSuppressFunc Handling

The provider has a special `DiffSuppressFunc` that suppresses diffs when either the old or new value equals "ignored-as-imported". This is used for imported resources where the password cannot be retrieved.

**Implementation (following diffsuppressfunc.md):**
1. Created `data "azapi_resource" "existing"` to read current state
2. Computed `should_read_existing_admin_password` to determine if state lookup is needed
3. Retrieved `existing_admin_password` from the data source (with safe fallback to null)
4. Replicated the DiffSuppressFunc logic in `admin_password_should_suppress` local
5. Computed `effective_admin_password` that selects between existing and desired values based on suppression logic
6. Used `effective_admin_password` in the sensitive_body

**Suppression Logic:**
```hcl
local.admin_password_should_suppress = (
  (local.existing_admin_password == "ignored-as-imported" || var.admin_password == "ignored-as-imported")
)
```

This exactly matches the Go implementation:
```go
if old == "ignored-as-imported" || new == "ignored-as-imported" {
	return true
}
```

**Effective Value Selection:**
```hcl
local.effective_admin_password = local.admin_password_should_suppress 
  ? coalesce(local.existing_admin_password, var.admin_password) 
  : var.admin_password
```

### 4. Validations

Implemented all three validations from `WindowsAdminPassword` function:

**Validation 1 - Length:**
```hcl
validation {
  condition     = var.admin_password == null || can(regex("^.{8,123}$", var.admin_password))
  error_message = "The admin_password must be between 8 and 123 characters."
}
```

Matches Go code: `if len(v) < 8 || len(v) > 123`

**Validation 2 - Disallowed Values:**
```hcl
validation {
  condition = var.admin_password == null || !contains([
    "abc@123", "P@$$w0rd", "P@ssw0rd", "P@ssword123", "Pa$$word",
    "pass@word1", "Password!", "Password1", "Password22", "iloveyou!"
  ], var.admin_password)
  error_message = "The admin_password cannot be one of the following disallowed values: abc@123, P@$$w0rd, P@ssw0rd, P@ssword123, Pa$$word, pass@word1, Password!, Password1, Password22, iloveyou!"
}
```

Matches Go code:
```go
disallowedNames := []string{"abc@123", "P@$$w0rd", "P@ssw0rd", "P@ssword123", "Pa$$word", "pass@word1", "Password!", "Password1", "Password22", "iloveyou!"}
for _, value := range disallowedNames {
	if value == v {
		errors = append(errors, ...)
	}
}
```

**Validation 3 - Complexity Requirements:**
```hcl
validation {
  condition = var.admin_password == null || (
    length(regexall("[a-z]", var.admin_password)) > 0 ? 1 : 0
    ) + (length(regexall("[A-Z]", var.admin_password)) > 0 ? 1 : 0
    ) + (length(regexall("[0-9]", var.admin_password)) > 0 ? 1 : 0
    ) + (length(regexall("[^\\w]", var.admin_password)) > 0 ? 1 : 0
  ) >= 3
  error_message = "The admin_password must fulfill 3 out of these 4 conditions: Has lower characters, Has upper characters, Has a digit, Has a special character (Regex match [\\W_])."
}
```

Matches Go code:
```go
conditions := 0
tests := []string{"[a-z]", "[A-Z]", "[0-9]", "[^\\d\\w]"}
for _, test := range tests {
	t, _ := regexp.MatchString(test, v)
	if t {
		conditions++
	}
}
if conditions < 3 {
	errors = append(errors, ...)
}
```

Note: The regex `[^\\d\\w]` in Go matches non-alphanumeric characters (excluding underscore), which is equivalent to `[^\w]` in Terraform (special characters).

### 5. Cross-Field Validations

**RequiredWith: admin_username**
- Deferred to Task #7 (admin_username) which owns this field
- The validation logic (`var.admin_password != null → var.admin_username != null`) will be implemented in the admin_username variable's validation block

**ConflictsWith: os_managed_disk_id**
- Deferred to Task #26 (os_managed_disk_id) which owns this field
- The validation logic (`var.admin_password != null → var.os_managed_disk_id == null`) will be implemented in the os_managed_disk_id variable's validation block

## Deferred Work Completion

Checked `following.md` - file does not exist, no deferred work to complete in this task.

## Critical Review & Edge Cases

### Edge Case Analysis

**1. Null Semantics:**
- `var.admin_password == null`: Field not set, omitted from sensitive_body via conditional merge
- `var.admin_password == ""`: Caught by validation (empty string fails length check)
- Provider behavior: Optional field, can be null when using `os_managed_disk_id`

**2. "ignored-as-imported" Special Value:**
- When a VM is imported, the password cannot be retrieved from Azure API
- Provider uses the special value "ignored-as-imported" as a placeholder
- DiffSuppressFunc prevents unnecessary diffs for this case
- Implementation: Suppression logic preserves existing value when either old or new equals "ignored-as-imported"
- Fallback: If existing state is unavailable, uses the desired value

**3. Sensitive Data Handling:**
- Password never appears in replace_triggers_external_values (uses version instead)
- Tracked in sensitive_body, not body
- Version variable acts as non-sensitive change indicator

**4. Version Variable Coordination:**
- Validation ensures: `admin_password != null → admin_password_version != null`
- This prevents situations where password changes but version doesn't, missing the replacement trigger

**5. State Lookup Safety:**
- `data.azapi_resource.existing.exists` check prevents errors when resource doesn't exist yet
- `try()` function provides safe fallback to null for missing properties
- Coalesce ensures we always have a value (existing or desired) when needed

**6. Empty Password vs Null:**
- Empty string `""` is invalid (fails length validation: min 8 chars)
- Null is valid (optional field)
- Azure API requires password for new VMs (unless using os_managed_disk_id)

**7. Idempotency:**
- DiffSuppressFunc preserves idempotency for imported resources
- Version-based tracking ensures clean diff behavior
- Merge pattern maintains stable structure

**8. Cross-Field Dependency:**
- Field is RequiredWith admin_username - both must be set or both null
- ConflictsWith os_managed_disk_id - cannot use password with imported disk
- Both validations deferred to the owning tasks

## Checklist

- ✅ Property in correct local (`sensitive_body`, not `body`)
- ✅ ForceNew tracked via version variable (not password value itself)
- ✅ All logic EXACTLY replicated from provider (DiffSuppressFunc, validations, complexity requirements)
- ✅ Validations IMPLEMENTED in variables.tf (3 validations: length, disallowed values, complexity)
- ✅ TODO comment NOT needed (root-level sensitive field uses existing variable with ephemeral = true)
- ✅ Hidden fields checked (none detected)
- ✅ Deferred work in following.md: Cross-field validations deferred to Task #7 and Task #26
- ✅ Deferred work from following.md: No file exists, no work to complete
- ✅ Critical review completed (null semantics, special values, sensitive handling, version coordination, idempotency)
- ✅ Edge Case Analysis in proof (8 scenarios analyzed)
- ✅ Proof created
- ✅ track.md updated to Pending for check
- ✅ Self-Review: Added only admin_password-related content; no fields from other tasks included

---

## ✅ CHECKER VALIDATION - CORRECTED AND APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-24
**Task:** #6 - admin_password

### Issues Identified

#### Issue 1: Incorrect nullable Attribute

**Problem:**
The `admin_password` variable in `variables.tf` had `nullable = false`, but this is an Optional field without a default value. This creates a contradiction where the field cannot be null, yet users should be able to omit it.

**Executor's Implementation:**
```hcl
variable "admin_password" {
  type        = string
  description = "(Optional) The Password which should be used for the local-administrator on this Virtual Machine. Changing this forces a new resource to be created."
  nullable    = false  # ❌ WRONG - prevents null for optional field
  ephemeral   = true
  # ... validations ...
}
```

**Why This Violates executor.md:**
From executor.md line 146-148:
> **Defaults:** If schema has `Default`, replicate it:
> - **Top-level:** `variable "field" { type = ...; default = value; nullable = false }` - **CRITICAL:** Root/top-level arguments with defaults MUST have both `default` value AND `nullable = false` set

The rule states that `nullable = false` is ONLY required when the field has a `default` value. Since `admin_password` is Optional WITHOUT a default, it should allow null values.

**Provider's Actual Behavior:**
```go
"admin_password": {
    Type:             pluginsdk.TypeString,
    Optional:         true,  // No Default specified
    ForceNew:         true,
    Sensitive:        true,
    ...
}
```

**Expected Behavior:**
- User can omit `admin_password` (should be null)
- User can provide `admin_password` with a value
- When null, the field is omitted from the request body via conditional merge

**Root Cause:**
Executor incorrectly applied `nullable = false` to an Optional field without a default value, preventing users from omitting the field.

### Corrections Made

#### Fix 1: Corrected nullable Attribute

**Changed Files:**
- `variables.tf`: Removed `nullable = false` and added `default = null` for proper optional field semantics

**New Implementation:**
```hcl
variable "admin_password" {
  type        = string
  default     = null  # ✅ Explicit default for optional field
  description = "(Optional) The Password which should be used for the local-administrator on this Virtual Machine. Changing this forces a new resource to be created."
  ephemeral   = true

  validation {
    condition     = var.admin_password == null || can(regex("^.{8,123}$", var.admin_password))
    error_message = "The admin_password must be between 8 and 123 characters."
  }

  validation {
    condition = var.admin_password == null || !contains([
      "abc@123", "P@$$w0rd", "P@ssw0rd", "P@ssword123", "Pa$$word",
      "pass@word1", "Password!", "Password1", "Password22", "iloveyou!"
    ], var.admin_password)
    error_message = "The admin_password cannot be one of the following disallowed values: abc@123, P@$$w0rd, P@ssw0rd, P@ssword123, Pa$$word, pass@word1, Password!, Password1, Password22, iloveyou!"
  }

  validation {
    condition = var.admin_password == null || (
      length(regexall("[a-z]", var.admin_password)) > 0 ? 1 : 0
      ) + (length(regexall("[A-Z]", var.admin_password)) > 0 ? 1 : 0
      ) + (length(regexall("[0-9]", var.admin_password)) > 0 ? 1 : 0
      ) + (length(regexall("[^\\w]", var.admin_password)) > 0 ? 1 : 0
    ) >= 3
    error_message = "The admin_password must fulfill 3 out of these 4 conditions: Has lower characters, Has upper characters, Has a digit, Has a special character (Regex match [\\W_])."
  }
}
```

**Why This is EXACT:**
- Matches provider's Optional field behavior (allows null)
- `default = null` makes the field explicitly optional
- All validations include null checks (`var.admin_password == null ||`)
- Conditional merge in locals correctly omits field when null
- Proper ephemeral semantics for sensitive data

**Verification:**
- Scenario 1: `admin_password = null` → Field omitted from sensitive_body ✅
- Scenario 2: `admin_password = "ValidPass123!"` → Field included with value ✅
- Scenario 3: `admin_password = "ignored-as-imported"` → DiffSuppressFunc applies, uses existing value ✅
- Edge Case: User omits variable entirely → Defaults to null, field omitted ✅

### Validation Results

✅ **ForceNew Logic:** Uses version variable to track changes (not password itself) - correct sensitive ForceNew pattern
✅ **Stable Keys:** All keys in `replace_triggers_external_values` are stable (wrapped in `{ value = ... }`)
✅ **Phase Detection:** Field correctly placed in `sensitive_body` (Create phase)
✅ **Type Conversion:** String to String - direct mapping, no conversion needed
✅ **Null Handling:** Correctly allows null for optional field, omits via conditional merge
✅ **Validations:** All 3 provider validations implemented (length, disallowed values, complexity) with null-safe conditions
✅ **DiffSuppressFunc:** Exactly replicated using state lookup, suppression logic, and effective value selection following diffsuppressfunc.md
✅ **Sensitive Field Handling:** Proper root-level sensitive field pattern - modified existing variable, created version variable, tracked in sensitive_body_version
✅ **Deferred Work Completion:** No deferred work for this task (following.md tracking confirmed)
✅ **Deferred Work Recording:** Cross-field validations properly recorded in following.md (Task #7 and Task #26)
✅ **Edge Cases:** All 8 edge cases analyzed (null, empty, special value, sensitive, version coordination, state lookup safety, idempotency, cross-field dependencies)

### Compliance Statement

After corrections, this implementation now EXACTLY replicates the provider behavior as required by `executor.md`. The DiffSuppressFunc logic is precisely mirrored following diffsuppressfunc.md rules, all validations are implemented, sensitive field handling follows the root-level pattern, and nullable semantics correctly match the provider's Optional field behavior.

**Status:** CORRECTED AND APPROVED ✅
